//
//  ContentView.swift
//  PINEE
//
//  Created by CÃ¡ssio Nunes on 18/06/25.
//

import SwiftUI
// import FirebaseFirestore
import FirebaseAuth
import UserNotifications
import StoreKit
// Se DateRange nÃ£o for reconhecido, tente importar explicitamente:
// import PINEE.Models // (descomente se necessÃ¡rio)

// DefiniÃ§Ã£o local de DateRange para compatibilidade
struct DateRange {
    var start: Date
    var end: Date
    var displayText: String
    init(start: Date, end: Date, displayText: String) {
        self.start = start
        self.end = end
        self.displayText = displayText
    }
}

// Classe para gerenciar o estado global do perÃ­odo selecionado
class GlobalDateManager: ObservableObject {
    @Published var selectedDate: Date = Date()
    @Published var periodType: PeriodType = .monthly
    
    enum PeriodType: String, CaseIterable, Hashable {
        case monthly = "monthly"
        case yearly = "yearly"
        case allTime = "allTime"
        
        var displayName: String {
            switch self {
            case .monthly: return "Mensal"
            case .yearly: return "Anual"
            case .allTime: return "Todo o perÃ­odo"
            }
        }
    }
    
    func updateSelectedDate(_ date: Date) {
        selectedDate = date
    }
    
    func updatePeriodType(_ type: PeriodType) {
        periodType = type
    }
    
    func getCurrentDateRange() -> DateRange {
        let calendar = Calendar.current
        
        switch periodType {
        case .monthly:
            let month = calendar.component(.month, from: selectedDate)
            let year = calendar.component(.year, from: selectedDate)
            
            let startOfMonth = calendar.date(from: DateComponents(year: year, month: month, day: 1))!
            let endOfMonth = calendar.date(byAdding: DateComponents(month: 1, day: -1), to: startOfMonth)!
            
            return DateRange(
                start: startOfMonth,
                end: endOfMonth,
                displayText: ContentView.formatMonthYear(date: selectedDate)
            )
            
        case .yearly:
            let year = calendar.component(.year, from: selectedDate)
            
            let startOfYear = calendar.date(from: DateComponents(year: year, month: 1, day: 1))!
            let endOfYear = calendar.date(from: DateComponents(year: year, month: 12, day: 31))!
            
            return DateRange(
                start: startOfYear,
                end: endOfYear,
                displayText: String(year)
            )
            
        case .allTime:
            // Para "Todo o perÃ­odo", usar uma data muito antiga como inÃ­cio
            let startDate = calendar.date(from: DateComponents(year: 2000, month: 1, day: 1))!
            let endDate = Date()
            
            return DateRange(
                start: startDate,
                end: endDate,
                displayText: "Todo o perÃ­odo"
            )
        }
    }
    
    // Novo mÃ©todo para calcular o perÃ­odo do saldo consolidado
    func getConsolidatedBalanceDateRange() -> DateRange {
        let calendar = Calendar.current
        
        switch periodType {
        case .monthly:
            // Para mensal, incluir todo o histÃ³rico atÃ© o final do mÃªs selecionado
            let month = calendar.component(.month, from: selectedDate)
            let year = calendar.component(.year, from: selectedDate)
            
            let endOfMonth = calendar.date(byAdding: DateComponents(month: 1, day: -1), to: calendar.date(from: DateComponents(year: year, month: month, day: 1))!)!
            
            // Data de inÃ­cio muito antiga para incluir todo o histÃ³rico
            let startDate = calendar.date(from: DateComponents(year: 2000, month: 1, day: 1))!
            
            return DateRange(
                start: startDate,
                end: endOfMonth,
                displayText: "Acumulado atÃ© \(ContentView.formatMonthYear(date: selectedDate))"
            )
            
        case .yearly:
            // Para anual, incluir apenas o ano selecionado
            let year = calendar.component(.year, from: selectedDate)
            
            let startOfYear = calendar.date(from: DateComponents(year: year, month: 1, day: 1))!
            let endOfYear = calendar.date(from: DateComponents(year: year, month: 12, day: 31))!
            
            return DateRange(
                start: startOfYear,
                end: endOfYear,
                displayText: "Ano \(year)"
            )
            
        case .allTime:
            // Para todo o perÃ­odo, incluir todo o histÃ³rico
            let startDate = calendar.date(from: DateComponents(year: 2000, month: 1, day: 1))!
            let endDate = Date()
            
            return DateRange(
                start: startDate,
                end: endDate,
                displayText: "Todo o perÃ­odo"
            )
        }
    }
    
    func canNavigateBackward() -> Bool {
        return periodType != .allTime
    }
    
    func canNavigateForward() -> Bool {
        return periodType != .allTime
    }
    
    func previousPeriod() {
        guard canNavigateBackward() else { return }
        
        let calendar = Calendar.current
        var newDate: Date?
        
        switch periodType {
        case .monthly:
            newDate = calendar.date(byAdding: .month, value: -1, to: selectedDate)
        case .yearly:
            newDate = calendar.date(byAdding: .year, value: -1, to: selectedDate)
        case .allTime:
            return
        }
        
        if let newDate = newDate {
            selectedDate = newDate
        }
    }
    
    func nextPeriod() {
        guard canNavigateForward() else { return }
        
        let calendar = Calendar.current
        var newDate: Date?
        
        switch periodType {
        case .monthly:
            newDate = calendar.date(byAdding: .month, value: 1, to: selectedDate)
        case .yearly:
            newDate = calendar.date(byAdding: .year, value: 1, to: selectedDate)
        case .allTime:
            return
        }
        
        if let newDate = newDate {
            selectedDate = newDate
        }
    }

struct ContentView: View {
    // MARK: - Models
    struct TransactionItemView: View {
        let title: String
        let category: String
        let amount: String
        let date: String
        let isIncome: Bool
        let transactionType: String
        @AppStorage("isMonochromaticMode") private var isMonochromaticMode: Bool = false
        
        // Computed properties para quebrar a complexidade
        private var circleColor: Color {
            if transactionType == "investment" {
                return isMonochromaticMode ? MonochromaticColorManager.primaryGreen : Color.blue
            } else if isIncome {
                return isMonochromaticMode ? MonochromaticColorManager.primaryGreen : Color(hex: "#16A34A")
            } else {
                return isMonochromaticMode ? MonochromaticColorManager.primaryGray : .red
            }
        }
        
        private var iconName: String {
            if transactionType == "investment" {
                return "chart.line.uptrend.xyaxis"
            } else if isIncome {
                return "chevron.up"
            } else {
                return "chevron.down"
            }
        }
        
        private var amountTextColor: Color {
            if transactionType == "investment" {
                return isMonochromaticMode ? MonochromaticColorManager.primaryGreen : Color.blue
            } else if isIncome {
                return isMonochromaticMode ? MonochromaticColorManager.primaryGreen : Color(hex: "#16A34A")
            } else {
                return isMonochromaticMode ? MonochromaticColorManager.primaryGray : .red
            }
        }
        
        var body: some View {
            HStack {
                // Ãcone da transaÃ§Ã£o
                ZStack {
                    Circle()
                        .fill(circleColor)
                        .frame(width: 36, height: 36)
                    
                    Image(systemName: iconName)
                        .font(.system(size: 16, weight: .bold))
                        .foregroundColor(.white)
                }
                
                VStack(alignment: .leading, spacing: 4) {
                    Text(title)
                        .font(.system(size: 14, weight: .medium))
                        .foregroundColor(.primary)
                    
                    Text(category)
                        .font(.system(size: 12))
                        .foregroundColor(.secondary)
                }
                
                Spacer()
                
                VStack(alignment: .trailing, spacing: 4) {
                    Text(amount)
                        .font(.system(size: 12, weight: .medium))
                        .foregroundColor(amountTextColor)
                    
                    Text(date)
                        .font(.system(size: 12))
                        .foregroundColor(.secondary)
                }
            }
            .padding(.horizontal, 16)
            .padding(.vertical, 12)
            .frame(maxWidth: .infinity)
        }
    }
    
    // MARK: - Properties
    @EnvironmentObject var authViewModel: AuthViewModel
    @AppStorage("colorScheme") private var colorScheme: String = "system"
    @State private var transactionToEdit: TransactionModel?
    @State private var showAddTransaction = false
    @State private var saldoConsolidadoVisivel: Bool = true
    @State private var selectedTab: Int = 0
    @State private var listener: Any?? // Listener para mudanÃ§as em tempo real
    @State private var consolidatedListener: Any?? // Listener para saldo consolidado
    @State private var goalsListener: Any?? = nil
    @StateObject private var globalDateManager = GlobalDateManager() // Gerenciador global de data
    private let db: Any? = nil // Firestore.firestore() temporariamente desabilitado

    // Estados financeiros
    @State private var receitasConsolidadas: Double = 0
    @State private var receitasPendentes: Double = 0
    @State private var despesasPagas: Double = 0
    @State private var despesasPendentes: Double = 0
    @State private var saldoConsolidado: Double = 0
    @State private var saldoProjetado: Double = 0
    @State private var saldoInvestido: Double = 0
    @State private var recentTransactions: [TransactionModel] = []
    @State private var showStatusNotification = false
    @State private var statusNotificationMessage = ""
    
    // NotificaÃ§Ã£o Premium
    @State private var showPremiumNotification = false
    @State private var premiumNotificationMessage = "Desbloqueie recursos exclusivos com o PINEE Premium!"

    // Data
    @State private var selectedMonth = Calendar.current.component(.month, from: Date())
    @State private var selectedYear = Calendar.current.component(.year, from: Date())
    @State private var currentDateRange: DateRange

    @State private var showProfile = false
    @State private var showReports = false
    @State private var showGoals = false
    @State private var showInvestments = false
    @State private var showSettings = false
    @State private var showNotifications = false
    @State private var showCategories = false

    @AppStorage("notificationsEnabled") private var notificationsEnabled: Bool = true
    @AppStorage("transactionReminders") private var transactionReminders: Bool = true
    @AppStorage("goalReminders") private var goalReminders: Bool = true
    @AppStorage("investmentUpdates") private var investmentUpdates: Bool = true
    @AppStorage("weeklyReports") private var weeklyReports: Bool = false
    @AppStorage("monthlyReports") private var monthlyReports: Bool = true
    @AppStorage("reminderTime") private var reminderTime: String = "20:00"
    @AppStorage("isMonochromaticMode") private var isMonochromaticMode: Bool = false
    @State private var showNotificationMessage = false
    @State private var notificationMessage = ""

    @State private var dollarRate: Double = 5.25
    @State private var bitcoinPrice: Double = 350000.0
    @State private var bitcoinPriceUSD: Double = 65000.0
    @State private var isLoadingRates = false
    @State private var lastUpdateTime = Date()
    @State private var updateTimer: Timer?

    @State private var showExportData = false
    @State private var showImportData = false
    @State private var showHelp = false
    @State private var showPrivacy = false

    @State private var showAddGoalSheet = false
    @State private var showPredefinedGoalsSheet = false

    // Progresso geral das metas para o dashboard
    @State private var totalTargetAmount: Double = 0
    @State private var totalCurrentAmount: Double = 0
    @State private var totalProgress: Double = 0

    @State private var goals: [Any] = []  // TEMPORARIAMENTE ALTERADO - Goal nÃ£o disponÃ­vel
    @State private var showGoalsScreen: Bool = false

    init() {
        let now = Date()
        let calendar = Calendar.current
        let month = calendar.component(.month, from: now)
        let year = calendar.component(.year, from: now)
        
        let startOfMonth = calendar.date(from: DateComponents(year: year, month: month, day: 1))!
        let endOfMonth = calendar.date(byAdding: DateComponents(month: 1, day: -1), to: startOfMonth)!
        
        _currentDateRange = State(initialValue: DateRange(
            start: startOfMonth,
            end: endOfMonth,
            displayText: ContentView.formatMonthYear(date: now)
        ))
    }

    // MARK: - Body
    var body: some View {
        ZStack {
            VStack(spacing: 0) {
                Group {
                    if selectedTab == 0 {
                        // Tab 1: Home
                        VStack(spacing: 0) {
                            filterView
                            Divider()
                                .opacity(0.3)
                            
                            ScrollView(showsIndicators: false) {
                                VStack(spacing: 8) {
                                    dashboardView
                                    transactionsListView
                                }
                                .padding(.top, 8)
                                .padding(.bottom, 100)
                            }
                        }
                        .background(Color(UIColor.systemGroupedBackground))
                    } else if selectedTab == 1 {
                        // Tab 2: TransaÃ§Ãµes
                        TransactionsView()
                            .environmentObject(authViewModel)
                            .environmentObject(globalDateManager)
                    } else if selectedTab == 2 {
                        // Tab 3: Metas (alterado de Ajustes)
                        NavigationView {
                        GoalsView()
                            .environmentObject(authViewModel)
                            .environmentObject(globalDateManager)
                                .navigationTitle("Metas")
                                .navigationBarTitleDisplayMode(.inline)
                        }
                    } else if selectedTab == 3 {
                        // Tab 4: Mais
                        MoreView()
                            .environmentObject(authViewModel)
                            .environmentObject(globalDateManager)
                    }
                }
            }

            // Menu inferior
            VStack {
                Spacer()
                bottomNavigationView
            }
            .zIndex(2)
        }
        .background(Color(UIColor.systemGroupedBackground))
        .sheet(isPresented: $showAddTransaction) {
            transactionToEdit = nil
            fetchDashboardData()
        } content: {
            AddTransactionView(transactionToEdit: transactionToEdit)
                .environmentObject(authViewModel)
                .environmentObject(globalDateManager)
        }
        .sheet(item: $transactionToEdit, onDismiss: {
            fetchDashboardData()
        }) { transaction in
            AddTransactionView(transactionToEdit: transaction)
                .environmentObject(authViewModel)
                .environmentObject(globalDateManager)
        }
        .overlay(
            // NotificaÃ§Ã£o de boas-vindas aprimorada
            Group {
                if authViewModel.showWelcomeNotification {
                    WelcomeNotificationView(
                        message: authViewModel.welcomeMessage,
                        isVisible: $authViewModel.showWelcomeNotification
                    )
                }
            }
        )
        .overlay(
            // NotificaÃ§Ã£o de status
            Group {
                if showStatusNotification {
                    StatusNotificationView(
                        message: statusNotificationMessage,
                        isVisible: $showStatusNotification
                    )
                }
            }
        )
        .overlay(
            // NotificaÃ§Ã£o Premium
            Group {
                if showPremiumNotification {
                    PremiumNotificationView(
                        message: premiumNotificationMessage,
                        isVisible: $showPremiumNotification
                    )
                }
            }
        )
        .onAppear {
            fetchDashboardData()
            setupDashboardGoalsListener()
        }
        .onDisappear {
            goalsListener?.remove()
        }
        .onChange(of: selectedTab) { newTab in
            // Atualizar dados quando volta para a tela inicial
            if newTab == 0 {
                print("ğŸ”„ Voltando para a tela inicial - Atualizando dados...")
                
                // Verificar se os listeners estÃ£o ativos
                if listener == nil || consolidatedListener == nil {
                    print("âš ï¸ Listeners nÃ£o encontrados - Reconfigurando...")
                    setupRealtimeListener()
                } else {
                    print("âœ… Listeners ativos - Atualizando dados...")
                    fetchDashboardData()
                }
            }
        }
                            .onChange(of: globalDateManager.periodType) { _ in
                        print("ğŸ”„ Tipo de perÃ­odo alterado para: \(globalDateManager.periodType.displayName)")
                        // ForÃ§ar atualizaÃ§Ã£o dos dados quando o tipo de perÃ­odo muda
                        updateToPeriod(globalDateManager.selectedDate)
                    }
                    .onChange(of: globalDateManager.selectedDate) { _ in
                        print("ğŸ”„ Data selecionada alterada para: \(globalDateManager.selectedDate)")
                        // ForÃ§ar atualizaÃ§Ã£o dos dados quando a data selecionada muda
                        updateToPeriod(globalDateManager.selectedDate)
                    }
        .onChange(of: authViewModel.user?.id) { newUserId in
            print("ğŸ”„ UsuÃ¡rio alterado - Novo userId: \(newUserId ?? "nil")")
            // ForÃ§ar refresh completo quando o usuÃ¡rio muda
            if let userId = newUserId {
                // Limpar todos os dados antigos
                clearAllData()
                
                // Recriar listeners com o novo usuÃ¡rio
                setupRealtimeListener()
                setupDashboardGoalsListener()
                
                print("âœ… Listeners recriados para o novo usuÃ¡rio: \(userId)")
            }
        }
        .onChange(of: authViewModel.user?.accountType) { newAccountType in
            print("ğŸ”„ Tipo de conta alterado para: \(newAccountType?.displayName ?? "nil")")
            // ForÃ§ar atualizaÃ§Ã£o da UI quando o tipo de conta muda
            // Isso garante que botÃµes premium sejam ocultados/exibidos corretamente
            // A UI serÃ¡ atualizada automaticamente pelo SwiftUI quando o @Published user mudar
        }
        .onDisappear {
            // NÃ£o remover os listeners automaticamente para manter a atualizaÃ§Ã£o em tempo real
            // Os listeners serÃ£o removidos apenas quando necessÃ¡rio (logout, etc.)
            print("ğŸ“± Tela inicial desapareceu - Mantendo listeners ativos")
        }
        .preferredColorScheme(getColorScheme())
        .sheet(isPresented: $showInvestments) {
            InvestmentsView()
                .environmentObject(authViewModel)
                .onAppear {
                    // Iniciar atualizaÃ§Ãµes de cotaÃ§Ãµes quando a view aparecer
                    print("ğŸ”„ Iniciando carregamento de cotaÃ§Ãµes...")
                }
                .onDisappear {
                    // Parar atualizaÃ§Ãµes quando a view desaparecer
                    print("â¹ï¸ Parando atualizaÃ§Ãµes de cotaÃ§Ãµes...")
                }
        }
        .sheet(isPresented: $showSettings) {
            SettingsView()
                .environmentObject(authViewModel)
        }
        .sheet(isPresented: $showNotifications) {
            NotificationsView()
                .environmentObject(authViewModel)
        }
        .sheet(isPresented: $showCategories) {
            CategoriesView()
                .environmentObject(authViewModel)
        }
        .sheet(isPresented: $showTransferInvestment, onDismiss: {
            fetchDashboardData()
        }) {
            if let transaction = transactionToInvest {
                TransferInvestmentView(sourceTransaction: transaction)
                    .environmentObject(authViewModel)
                    .environmentObject(globalDateManager)
            }
        }
        .sheet(isPresented: $showTransferIncome, onDismiss: {
            fetchDashboardData()
        }) {
            if let transaction = transactionToInvest {
                TransferIncomeView(sourceTransaction: transaction)
                    .environmentObject(authViewModel)
                    .environmentObject(globalDateManager)
            }
        }
        .sheet(isPresented: $showPrivacy) {
            PrivacyPolicyView()
        }
        .sheet(isPresented: $showImportData) {
            ImportDataView()
                // .environmentObject(authViewModel)  // TEMPORARIAMENTE COMENTADO
        }
        .sheet(isPresented: $showAddGoalSheet) {
            AddGoalView { newGoal in
                addGoal(newGoal)
            }
            .environmentObject(authViewModel)
        }
    }

    // MARK: - Views
    private var filterView: some View {
        HStack(spacing: 20) {
            Button(action: previousMonth) {
                Image(systemName: "chevron.left")
                    .foregroundColor(globalDateManager.canNavigateBackward() ? .primary : .gray.opacity(0.3))
                    .font(.system(size: 18, weight: .medium))
                    .frame(width: 44, height: 44)
                    .background(Color(UIColor.secondarySystemBackground))
                    .clipShape(Circle())
            }
            .disabled(!globalDateManager.canNavigateBackward())
            
            // O texto central agora Ã© um Menu
            Menu {
                if globalDateManager.periodType != .monthly {
                    Button(action: {
                        globalDateManager.updatePeriodType(.monthly)
                        updateToPeriod(globalDateManager.selectedDate)
                    }) {
                        Text("Mensal")
                        if globalDateManager.periodType == .monthly {
                            Image(systemName: "checkmark")
                        }
                    }
                }
                if globalDateManager.periodType != .yearly {
                    Button(action: {
                        globalDateManager.updatePeriodType(.yearly)
                        updateToPeriod(globalDateManager.selectedDate)
                    }) {
                        Text("Anual")
                        if globalDateManager.periodType == .yearly {
                            Image(systemName: "checkmark")
                        }
                    }
                }
                if globalDateManager.periodType != .allTime {
                    Button(action: {
                        globalDateManager.updatePeriodType(.allTime)
                        updateToPeriod(globalDateManager.selectedDate)
                    }) {
                        Text("Todo o perÃ­odo")
                        if globalDateManager.periodType == .allTime {
                            Image(systemName: "checkmark")
                        }
                    }
                }
            } label: {
                HStack(spacing: 6) {
                    Text(globalDateManager.getCurrentDateRange().displayText)
                        .font(.system(size: 18, weight: .semibold))
                        .foregroundColor(.primary)
                        .lineLimit(1)
                        .minimumScaleFactor(0.8)
                    Image(systemName: "chevron.down")
                        .font(.system(size: 12))
                        .foregroundColor(.secondary)
                }
                .padding(.horizontal, 12)
                .padding(.vertical, 6)
                .background(Color(UIColor.secondarySystemBackground))
                .cornerRadius(16)
            }
            .buttonStyle(PlainButtonStyle())
            
            Button(action: nextMonth) {
                Image(systemName: "chevron.right")
                    .foregroundColor(globalDateManager.canNavigateForward() ? .primary : .gray.opacity(0.3))
                    .font(.system(size: 18, weight: .medium))
                    .frame(width: 44, height: 44)
                    .background(Color(UIColor.secondarySystemBackground))
                    .clipShape(Circle())
            }
            .disabled(!globalDateManager.canNavigateForward())
        }
        .padding(.horizontal, 20)
        .padding(.vertical, 8)
    }

    private var transactionsListView: some View {
        VStack(alignment: .leading, spacing: 16) {
            HStack {
                Text("Ãšltimas TransaÃ§Ãµes")
                    .font(.system(size: 16, weight: .semibold))
                    .foregroundColor(.primary)
                
                Spacer()
                
                Button(action: { selectedTab = 1 }) {
                    Text("Ver todas")
                        .font(.system(size: 14))
                        .foregroundColor(isMonochromaticMode ? 
                            MonochromaticColorManager.primaryGreen : 
                            Color(hex: "#059669"))
                }
            }
            .padding(.horizontal, 16)
            .padding(.top, 8)

            if recentTransactions.isEmpty {
                VStack(spacing: 8) {
                    Image(systemName: "doc.text")
                        .font(.system(size: 32))
                        .foregroundColor(.gray.opacity(0.5))
                        .padding(.bottom, 4)
                    Text("Nenhuma transaÃ§Ã£o encontrada")
                        .font(.system(size: 14))
                        .foregroundColor(.gray)
                }
                .frame(maxWidth: .infinity)
                .padding(.vertical, 32)
            } else {
                VStack(spacing: 12) {
                    ForEach(recentTransactions) { transaction in
                        SwipeableTransactionRow(
                            transaction: transaction,
                            onEdit: {
                                transactionToEdit = transaction
                            },
                            onDelete: { deleteTransaction(transaction) },
                            onToggleStatus: { toggleTransactionStatus(transaction) },
                            onTap: {
                                transactionToEdit = transaction
                            },
                            onInvest: { investTransaction(transaction) },
                            onRedeem: { transferInvestment(transaction) }
                        )
                        .padding(.horizontal, 16)
                    }
                }
            }
        }
        .padding(.bottom, 16)
    }

    // MARK: - Navigation Views
    private var bottomNavigationView: some View {
        VStack(spacing: 0) {
            Divider()
            
            HStack(spacing: 0) {
                // Dashboard (InÃ­cio)
                bottomNavButton(icon: "house.fill", title: "InÃ­cio", isSelected: selectedTab == 0) {
                    selectedTab = 0
                }
                
                // TransaÃ§Ãµes (alterado de RelatÃ³rios)
                bottomNavButton(icon: "list.bullet", title: "TransaÃ§Ãµes", isSelected: selectedTab == 1) {
                    selectedTab = 1
                }
                
                // BotÃ£o central (adicionar)
                addTransactionButton
                
                // Metas (alterado de Ajustes)
                bottomNavButton(icon: "target", title: "Metas", isSelected: selectedTab == 2) {
                    selectedTab = 2
                }
                
                // Mais
                bottomNavButton(icon: "ellipsis", title: "Mais", isSelected: selectedTab == 3) {
                    // Sempre retornar ao menu principal do MoreView
                    selectedTab = 3
                }
            }
            .padding(.horizontal, 16)
            .padding(.bottom, 8)
        }
        .background(Color(UIColor.systemBackground))
    }

    private func bottomNavButton(icon: String, title: String, isSelected: Bool = false, action: @escaping () -> Void) -> some View {
        Button(action: action) {
            VStack(spacing: 2) { // Reduzindo o espaÃ§amento para melhor alinhamento
                // Container para o Ã­cone com altura fixa
                ZStack {
                    Image(systemName: icon)
                        .font(.system(size: 20))
                        .foregroundColor(isSelected ? 
                            (isMonochromaticMode ? MonochromaticColorManager.primaryGreen : Color(hex: "#059669")) : 
                            .gray)
                }
                .frame(height: 20) // Altura fixa para todos os Ã­cones
                
                // Container para o texto com altura fixa
                ZStack {
                    Text(title)
                        .font(.system(size: 10))
                        .foregroundColor(isSelected ? 
                            (isMonochromaticMode ? MonochromaticColorManager.primaryGreen : Color(hex: "#059669")) : 
                            .gray)
                        .lineLimit(1)
                        .minimumScaleFactor(0.8)
                }
                .frame(height: 12) // Altura fixa para todos os textos
            }
            .frame(maxWidth: .infinity)
            .frame(height: 44) // Altura fixa para todos os botÃµes
        }
    }

    private var addTransactionButton: some View {
        VStack(spacing: 0) {
            // EspaÃ§o para manter alinhamento com outros botÃµes
            Spacer()
                .frame(height: 44)
            
            // BotÃ£o de nova transaÃ§Ã£o posicionado acima
            Button(action: { showAddTransaction = true }) {
                Circle()
                    .fill(
                        LinearGradient(
                            gradient: Gradient(colors: [Color(hex: "#059669"), Color(hex: "#10B981"), Color(hex: "#34D399")]),
                            startPoint: .topLeading,
                            endPoint: .bottomTrailing
                        ).asAnyShapeStyle()
                    )
                    .frame(width: 56, height: 56)
                    .shadow(color: Color.black.opacity(0.15), radius: 8, x: 0, y: 4)
                    .overlay(
                        Image(systemName: "plus")
                            .font(.system(size: 24, weight: .medium))
                            .foregroundColor(.white)
                    )
            }
            .offset(y: -28)
        }
        .frame(maxWidth: .infinity)
        .frame(height: 44) // Garantir que ocupe a mesma altura dos outros botÃµes
    }

    private func setupDashboardGoalsListener() {
        guard let userId = authViewModel.user?.id else { return }
        goalsListener?.remove()
        let db = // Firestore.firestore()
        goalsListener = db// .collection("users")// .document(userId)// .collection("goals")
            .whereField("isActive", isEqualTo: true)
            .addSnapshotListener { snapshot, error in
                if let error = error {
                    print("âŒ Erro ao escutar metas do dashboard: \(error.localizedDescription)")
                    return
                }
                guard let documents = snapshot?.documents else {
                    print("âŒ Nenhuma meta encontrada para o dashboard")
                    DispatchQueue.main.async {
                        self.goals = []
                        self.totalTargetAmount = 0
                        self.totalCurrentAmount = 0
                        self.totalProgress = 0
                    }
                    return
                }
                DispatchQueue.main.async {
                    self.goals = documents.compactMap { doc -> Goal? in
                        let data = doc.data()
                        return Goal(
                            id: doc.documentID,
                            userId: userId,
                            title: data["title"] as? String ?? "",
                            description: data["description"] as? String ?? "",
                            targetAmount: (data["targetAmount"] as? NSNumber)?.doubleValue ?? 0,
                            currentAmount: (data["currentAmount"] as? NSNumber)?.doubleValue ?? 0,
                            deadline: (data["deadline"] as? Timestamp)?.dateValue() ?? Date(),
                            category: data["category"] as? String ?? "Geral",
                            isPredefined: data["isPredefined"] as? Bool ?? false,
                            predefinedType: data["predefinedType"] as? String,
                            createdAt: (data["createdAt"] as? Timestamp)?.dateValue() ?? Date(),
                            updatedAt: (data["updatedAt"] as? Timestamp)?.dateValue() ?? Date(),
                            isActive: data["isActive"] as? Bool ?? true
                        )
                    }
                    // Calcular totais
                    var targetTotal: Double = 0
                    var currentTotal: Double = 0
                    for goal in self.goals {
                        targetTotal += goal.targetAmount
                        currentTotal += goal.currentAmount
                    }
                    self.totalTargetAmount = targetTotal
                    self.totalCurrentAmount = currentTotal
                    self.totalProgress = targetTotal > 0 ? currentTotal / targetTotal : 0
                }
            }
    }

    // MARK: - Helper Views
    private func transactionView(for transaction: TransactionModel) -> some View {
        let itemView = TransactionItemView(
            title: transaction.title ?? transaction.description ?? "-",
            category: transaction.category,
            amount: formatCurrency(transaction.amount),
            date: formatShortDate(transaction.date),
            isIncome: transaction.isIncome,
            transactionType: transaction.type ?? "expense"
        )
        
        return ZStack(alignment: .trailing) {
            HStack(spacing: 0) {
                Button(action: {
                    transactionToEdit = transaction
                }) {
                    Image(systemName: "pencil")
                        .font(.title2)
                        .foregroundColor(.white)
                        .frame(width: 60, height: 80)
                        .background(Color.blue)
                        .cornerRadius(12)
                }

                Button(action: { deleteTransaction(transaction) }) {
                    Image(systemName: "trash")
                        .font(.title2)
                        .foregroundColor(.white)
                        .frame(width: 60, height: 80)
                        .background(Color.red)
                        .cornerRadius(12)
                }
            }

            itemView
                .background(Color(UIColor.secondarySystemBackground))
        }
    }

    // MARK: - Functions
    static func formatMonthYear(date: Date) -> String {
        let formatter = DateFormatter()
        formatter.dateFormat = "MMMM yyyy"
        formatter.locale = Locale(identifier: "pt_BR")
        return formatter.string(from: date).capitalized
    }

    private func getColorScheme() -> ColorScheme? {
        switch colorScheme {
        case "light": return .light
        case "dark": return .dark
        default: return nil
        }
    }

    private func formatCurrency(_ value: Double) -> String {
        let formatter = NumberFormatter()
        formatter.numberStyle = .currency
        formatter.currencyCode = "BRL"
        formatter.locale = Locale(identifier: "pt_BR")
        return formatter.string(from: NSNumber(value: value)) ?? "R$ 0,00"
    }

    private func formatShortDate(_ dateStr: String) -> String {
        let dateFormatter = DateFormatter()
        dateFormatter.dateFormat = "yyyy-MM-dd"
        if let date = dateFormatter.date(from: dateStr) {
            let outFormatter = DateFormatter()
            outFormatter.locale = Locale(identifier: "pt_BR")
            outFormatter.dateFormat = "dd MMM"
            return outFormatter.string(from: date)
        }
        return dateStr
    }

    private func previousMonth() {
        globalDateManager.previousPeriod()
        updateToPeriod(globalDateManager.selectedDate)
    }

    private func nextMonth() {
        globalDateManager.nextPeriod()
        updateToPeriod(globalDateManager.selectedDate)
    }

    private func updateToPeriod(_ date: Date) {
        print("ğŸ”„ Atualizando perÃ­odo para: \(date)")
        
        // Atualizar o perÃ­odo no globalDateManager
        globalDateManager.updateSelectedDate(date)
        
        // Usar o mÃ©todo do globalDateManager para obter o perÃ­odo atual
        currentDateRange = globalDateManager.getCurrentDateRange()
        
        // Limpar dados temporariamente para evitar exibiÃ§Ã£o de dados antigos
        DispatchQueue.main.async {
            self.recentTransactions = []
            self.resetFinancialData()
        }
        
        // Configurar os listeners com os novos perÃ­odos
        setupRealtimeListener()
    }

    private func deleteTransaction(_ tx: TransactionModel) {
        guard let id = tx.id else { return }
        print("ğŸ—‘ï¸ Iniciando exclusÃ£o da transaÃ§Ã£o: \(id)")
        print("ğŸ“Š TransaÃ§Ã£o a ser excluÃ­da: \(tx.title ?? "") - R$ \(String(format: "%.2f", tx.amount)) - \(tx.type ?? "")")
        
        db// .collection("transactions")// .document(id).delete { error in
            DispatchQueue.main.async {
                if let error = error {
                    print("âŒ Erro ao deletar transaÃ§Ã£o: \(error.localizedDescription)")
                    self.displayStatusNotification(message: "Erro ao excluir transaÃ§Ã£o")
                } else {
                    print("âœ… TransaÃ§Ã£o deletada com sucesso: \(id)")
                    print("ğŸ”„ ForÃ§ando atualizaÃ§Ã£o dos dados...")
                    
                    // ForÃ§ar atualizaÃ§Ã£o dos dados apÃ³s exclusÃ£o
                    self.fetchDashboardData()
                    
                    self.displayStatusNotification(message: "TransaÃ§Ã£o excluÃ­da com sucesso")
                }
            }
        }
    }

    private func toggleTransactionStatus(_ transaction: TransactionModel) {
        guard let id = transaction.id else { return }
        
        let newStatus: String
        let statusMessage: String
        
        if (transaction.type ?? "expense") == "expense" {
            newStatus = transaction.status == "paid" ? "unpaid" : "paid"
            statusMessage = newStatus == "paid" ? "Despesa marcada como paga" : "Despesa marcada como nÃ£o paga"
        } else if (transaction.type ?? "") == "investment" {
            newStatus = transaction.status == "invested" ? "pending" : "invested"
            statusMessage = newStatus == "invested" ? "Investimento Aportado" : "Investimento nÃ£o Aportado"
        // } else {
            newStatus = transaction.status == "received" ? "pending" : "received"
            statusMessage = newStatus == "received" ? "Receita marcada como recebida" : "Receita marcada como pendente"
        }
        
        print("ğŸ”„ Iniciando alteraÃ§Ã£o de status da transaÃ§Ã£o: \(id)")
        print("ğŸ“Š TransaÃ§Ã£o: \(transaction.title ?? "") - R$ \(String(format: "%.2f", transaction.amount))")
        print("ğŸ“Š Status atual: \(transaction.status) -> Novo status: \(newStatus)")
        
        let updateData: [String: Any] = [
            "status": newStatus,
            "updatedAt": Timestamp(date: Date())
        ]
        
        db// .collection("transactions")// .document(id).updateData(updateData) { error in
            DispatchQueue.main.async {
                if let error = error {
                    print("âŒ Erro ao atualizar status: \(error.localizedDescription)")
                    self.displayStatusNotification(message: "Erro ao atualizar status")
                } else {
                    print("âœ… Status atualizado com sucesso: \(transaction.title ?? "") - \(newStatus)")
                    print("ğŸ”„ ForÃ§ando atualizaÃ§Ã£o dos dados...")
                    
                    // ForÃ§ar atualizaÃ§Ã£o dos dados apÃ³s alteraÃ§Ã£o de status
                    self.fetchDashboardData()
                    
                    self.displayStatusNotification(message: statusMessage)
                }
            }
        }
    }
    
    // @State private var showTransferInvestment = false    @State private var showTransferIncome = false
    // @State private var transactionToInvest: TransactionModel?    
    private func investTransaction(_ transaction: TransactionModel) {
        // Verificar se Ã© uma receita
        guard transaction.isIncome else {
            print("âŒ Apenas receitas podem ser transferidas para investimento")
            return
        }
        
        print("ğŸ’° Investir na transaÃ§Ã£o: \(transaction.title ?? "")")
        transactionToInvest = transaction
        showTransferInvestment = true
    }
    
    private func transferInvestment(_ transaction: TransactionModel) {
        guard (transaction.type ?? "expense") == "investment" else {
            print("âŒ Apenas investimentos podem ser transferidos")
            return
        }

        print("ğŸ’° Transferir investimento: \(transaction.title ?? "")")
        transactionToInvest = transaction
        showTransferIncome = true
    }

    private func fetchDashboardData() {
        setupRealtimeListener()
    }
    
    private func setupRealtimeListener() {
        guard let userId = authViewModel.user?.id else {
            print("âš ï¸ UserId nÃ£o encontrado - Aguardando autenticaÃ§Ã£o...")
            return
        }
        
        print("ğŸ”„ Configurando listeners para userId: \(userId)")
        
        // Remove listeners anteriores se existirem
        listener?.remove()
        consolidatedListener?.remove()
        
        let dateFormatter = DateFormatter()
        dateFormatter.dateFormat = "yyyy-MM-dd"
        
        let currentRange = globalDateManager.getCurrentDateRange()
        let consolidatedRange = globalDateManager.getConsolidatedBalanceDateRange()
        
        let startStr = dateFormatter.string(from: currentRange.start)
        let endStr = dateFormatter.string(from: currentRange.end)
        let consolidatedStartStr = dateFormatter.string(from: consolidatedRange.start)
        let consolidatedEndStr = dateFormatter.string(from: consolidatedRange.end)
        
        print("ğŸ” Configurando listeners em tempo real para dashboard")
        print("ğŸ‘¤ UserId: \(userId)")
        print("ğŸ“… PerÃ­odo selecionado: \(startStr) atÃ© \(endStr)")
        print("ğŸ’° PerÃ­odo saldo consolidado: \(consolidatedStartStr) atÃ© \(consolidatedEndStr)")
        
        // Listener para transaÃ§Ãµes do perÃ­odo selecionado (para exibiÃ§Ã£o na lista e cards)
        listener = db// .collection("transactions")
            .whereField("userId", isEqualTo: userId)
            .whereField("date", isGreaterThanOrEqualTo: startStr)
            .whereField("date", isLessThanOrEqualTo: endStr)
            .order(by: "date", descending: true)
            .addSnapshotListener { snapshot, error in
                if let error = error {
                    print("âŒ Erro ao escutar mudanÃ§as do perÃ­odo: \(error.localizedDescription)")
                    return
                }
                
                guard let documents = snapshot?.documents else {
                    print("âŒ Nenhum documento encontrado no perÃ­odo")
                    DispatchQueue.main.async {
                        // Limpar dados quando nÃ£o hÃ¡ transaÃ§Ãµes no perÃ­odo
                        self.recentTransactions = []
                        self.resetFinancialData()
                    }
                    return
                }
                
                print("ğŸ“„ MudanÃ§as detectadas no perÃ­odo: \(documents.count) documentos")
                print("ğŸ“… PerÃ­odo: \(startStr) atÃ© \(endStr)")
                
                DispatchQueue.main.async {
                    self.processPeriodTransactions(documents: documents, userId: userId)
                }
            }
        
        // Listener para saldo consolidado (perÃ­odo acumulado) - apenas para cÃ¡lculo do saldo consolidado
        consolidatedListener = db// .collection("transactions")
            .whereField("userId", isEqualTo: userId)
            .whereField("date", isGreaterThanOrEqualTo: consolidatedStartStr)
            .whereField("date", isLessThanOrEqualTo: consolidatedEndStr)
            .addSnapshotListener { snapshot, error in
                if let error = error {
                    print("âŒ Erro ao escutar mudanÃ§as do saldo consolidado: \(error.localizedDescription)")
                    return
                }
                
                guard let documents = snapshot?.documents else {
                    print("âŒ Nenhum documento encontrado para saldo consolidado")
                    DispatchQueue.main.async {
                        // Manter os dados do perÃ­odo atual, apenas zerar o saldo consolidado
                        self.saldoConsolidado = 0
                    }
                    return
                }
                
                print("ğŸ’° MudanÃ§as detectadas no saldo consolidado: \(documents.count) documentos")
                print("ğŸ“… PerÃ­odo consolidado: \(consolidatedStartStr) atÃ© \(consolidatedEndStr)")
                
                DispatchQueue.main.async {
                    self.processConsolidatedBalance(documents: documents, userId: userId)
                }
            }
    }
    
    private func processPeriodTransactions(documents: [Any], userId: String) {
        var receitasConsolidadas: Double = 0
        var receitasPendentes: Double = 0
        var despesasPagas: Double = 0
        var despesasPendentes: Double = 0
        var saldoInvestido: Double = 0
        var investimentosTransferidos: Double = 0
        let dateFormatter = DateFormatter()
        dateFormatter.dateFormat = "yyyy-MM-dd"
        var transactionsInPeriod: [TransactionModel] = []
        
        let currentRange = globalDateManager.getCurrentDateRange()
        
        print("ğŸ” Processando \(documents.count) documentos para o perÃ­odo: \(currentRange.displayText)")
        print("ğŸ“… PerÃ­odo: \(dateFormatter.string(from: currentRange.start)) atÃ© \(dateFormatter.string(from: currentRange.end))")
        
        for doc in documents {
            let data = doc.data()
            let amount = (data["amount"] as? NSNumber)?.doubleValue ?? (data["amount"] as? Double) ?? 0
            let type = data["type"] as? String ?? ""
            let status = data["status"] as? String ?? ""
            let dateStr = data["date"] as? String ?? ""
            let sourceTransactionId = data["sourceTransactionId"] as? String ?? ""
            let category = data["category"] as? String ?? ""
            let description = data["description"] as? String ?? ""
            let title = data["title"] as? String ?? description
            
            if let date = dateFormatter.date(from: dateStr),
               date >= currentRange.start,
               date <= currentRange.end {
                let transaction = TransactionModel(
                    id: doc.documentID,
                    userId: userId,
                    title: title,
                    description: description,
                    amount: amount,
                    category: category,
                    date: dateStr,
                    isIncome: type == "income",
                    type: type,
                    status: status,
                    createdAt: (data["createdAt"] as? Timestamp)?.dateValue() ?? Date(),
                    isRecurring: data["isRecurring"] as? Bool ?? false,
                    recurringFrequency: data["recurringFrequency"] as? String ?? "",
                    recurringEndDate: data["recurringEndDate"] as? String ?? "",
                    sourceTransactionId: data["sourceTransactionId"] as? String ?? ""
                )
                
                transactionsInPeriod.append(transaction)
                
                // Calcular receitas e despesas do perÃ­odo para os cards
                if type == "income" {
                    if status == "consolidated" || status == "paid" || status == "received" {
                        receitasConsolidadas += amount
                    } else {
                        receitasPendentes += amount
                    }
                } else if type == "expense" {
                    if status == "paid" {
                        despesasPagas += amount
                    } else if status == "unpaid" {
                        despesasPendentes += amount
                    }
                } else if type == "investment" {
                    saldoInvestido += amount
                    // SÃ³ desconta investimentos que foram transferidos de receita
                    if !sourceTransactionId.isEmpty {
                        investimentosTransferidos += amount
                        print("ğŸ“ˆ Investimento transferido de receita (perÃ­odo): \(title) - R$ \(String(format: "%.2f", amount))")
                    }
                }
                
                print("âœ… TransaÃ§Ã£o incluÃ­da: \(title) - R$ \(String(format: "%.2f", amount)) - \(type) - \(status)")
            } else {
                print("âŒ TransaÃ§Ã£o fora do perÃ­odo: \(title) - Data: \(dateStr)")
            }
        }
        
        let sorted = transactionsInPeriod.sorted { $0.createdAt > $1.createdAt }
        self.recentTransactions = Array(sorted.prefix(5))
        
        // Atualizar os valores dos cards com os dados do perÃ­odo selecionado
        self.receitasConsolidadas = receitasConsolidadas
        self.receitasPendentes = receitasPendentes
        self.despesasPagas = despesasPagas
        self.despesasPendentes = despesasPendentes
        self.saldoInvestido = saldoInvestido
        
        // Calcular saldo projetado baseado no perÃ­odo selecionado
        let receitasProjetadas = receitasConsolidadas + receitasPendentes
        let despesasProjetadas = despesasPagas + despesasPendentes
        self.saldoProjetado = receitasProjetadas - despesasProjetadas - investimentosTransferidos
        
        print("âœ… TransaÃ§Ãµes do perÃ­odo atualizadas: \(self.recentTransactions.count) transaÃ§Ãµes recentes")
        print("ğŸ’° Saldo projetado atualizado: R$ \(String(format: "%.2f", self.saldoProjetado))")
        print("ğŸ“Š Valores do perÃ­odo - Receitas: R$ \(String(format: "%.2f", receitasConsolidadas)), Pendentes: R$ \(String(format: "%.2f", receitasPendentes))")
        print("ğŸ“Š Valores do perÃ­odo - Despesas Pagas: R$ \(String(format: "%.2f", despesasPagas)), Pendentes: R$ \(String(format: "%.2f", despesasPendentes))")
        print("ğŸ“Š Investimentos transferidos de receita (perÃ­odo): R$ \(String(format: "%.2f", investimentosTransferidos))")
        print("ğŸ“Š Saldo Investido: R$ \(String(format: "%.2f", saldoInvestido))")
        print("ğŸ“Š Total de transaÃ§Ãµes no perÃ­odo: \(transactionsInPeriod.count)")
    }
    
    private func processConsolidatedBalance(documents: [Any], userId: String) {
        var receitasConsolidadas: Double = 0
        var despesasPagas: Double = 0
        var investimentosTransferidos: Double = 0
        let dateFormatter = DateFormatter()
        dateFormatter.dateFormat = "yyyy-MM-dd"
        
        let consolidatedRange = globalDateManager.getConsolidatedBalanceDateRange()
        
        print("ğŸ” Processando saldo consolidado para \(documents.count) documentos")
        print("ğŸ“… PerÃ­odo consolidado: \(dateFormatter.string(from: consolidatedRange.start)) atÃ© \(dateFormatter.string(from: consolidatedRange.end))")
        
        for doc in documents {
            let data = doc.data()
            let amount = (data["amount"] as? NSNumber)?.doubleValue ?? (data["amount"] as? Double) ?? 0
            let type = data["type"] as? String ?? ""
            let status = data["status"] as? String ?? ""
            let dateStr = data["date"] as? String ?? ""
            let sourceTransactionId = data["sourceTransactionId"] as? String ?? ""
            let title = data["title"] as? String ?? data["description"] as? String ?? "Sem tÃ­tulo"
            
            if let date = dateFormatter.date(from: dateStr) {
                if type == "income" {
                    if status == "consolidated" || status == "paid" || status == "received" {
                        receitasConsolidadas += amount
                        print("ğŸ’° Receita consolidada: \(title) - R$ \(String(format: "%.2f", amount))")
                    }
                } else if type == "expense" {
                    if status == "paid" {
                        despesasPagas += amount
                        print("ğŸ’¸ Despesa paga: \(title) - R$ \(String(format: "%.2f", amount))")
                    }
                } else if type == "investment" {
                    // SÃ³ desconta investimentos que foram transferidos de receita
                    if !sourceTransactionId.isEmpty {
                        investimentosTransferidos += amount
                        print("ğŸ“ˆ Investimento transferido de receita: \(title) - R$ \(String(format: "%.2f", amount))")
                    }
                }
            }
        }
        
        // Atualizar apenas o saldo consolidado (nÃ£o os valores dos cards)
        self.saldoConsolidado = receitasConsolidadas - despesasPagas - investimentosTransferidos
        
        print("âœ… Saldo consolidado atualizado: R$ \(String(format: "%.2f", self.saldoConsolidado))")
        print("ğŸ“Š Saldo consolidado - Receitas: R$ \(String(format: "%.2f", receitasConsolidadas)), Despesas: R$ \(String(format: "%.2f", despesasPagas))")
        print("ğŸ“Š Investimentos transferidos de receita: R$ \(String(format: "%.2f", investimentosTransferidos))")
        print("ğŸ“Š Total de documentos processados: \(documents.count)")
    }
    
    private func resetFinancialData() {
        self.receitasConsolidadas = 0
        self.receitasPendentes = 0
        self.despesasPagas = 0
        self.despesasPendentes = 0
        self.saldoConsolidado = 0
        self.saldoProjetado = 0
        self.saldoInvestido = 0
    }
    
    private func clearAllData() {
        print("ğŸ§¹ Limpando todos os dados da tela inicial")
        resetFinancialData()
        recentTransactions = []
        goals = []
        totalTargetAmount = 0
        totalCurrentAmount = 0
        totalProgress = 0
    }
    
    private func addGoal(_ goal: Any) {  // TEMPORARIAMENTE ALTERADO - Goal nÃ£o disponÃ­vel
        // TEMPORARIAMENTE COMENTADO - AuthViewModel nÃ£o disponÃ­vel
        /*
        guard let userId = authViewModel.user?.id else { 
            print("âŒ UserId nÃ£o encontrado para adicionar meta")
            displayStatusNotification(message: "Erro: UsuÃ¡rio nÃ£o autenticado")
            return 
        }
        */
        
        print("ğŸ¯ Iniciando criaÃ§Ã£o de meta:")
        print("   - TÃ­tulo: \(goal.title)")
        print("   - DescriÃ§Ã£o: \(goal.description)")
        print("   - Meta: R$ \(goal.targetAmount)")
        print("   - Atual: R$ \(goal.currentAmount)")
        print("   - Categoria: \(goal.category)")
        print("   - PrÃ©-definida: \(goal.isPredefined)")
        print("   - UserId: \(userId)")
        
        var newGoal = goal
        newGoal.userId = userId
        
        do {
            print("ğŸ“ Salvando meta no Firebase...")
            let docRef = try db// .collection("users")// .document(userId)// .collection("goals").addDocument(from: newGoal)
            
            print("âœ… Documento criado com ID: \(docRef.documentID)")
            
            // Atualizar o ID do documento
            newGoal.id = docRef.documentID
            try docRef.setData(from: newGoal)
            
            print("âœ… Meta salva com sucesso no Firebase!")
            displayStatusNotification(message: "Meta criada com sucesso!")
            
            // ForÃ§ar atualizaÃ§Ã£o da lista
            DispatchQueue.main.asyncAfter(deadline: .now() + 0.5) {
                self.setupRealtimeListener()
            }
            
        } catch {
            print("âŒ Erro ao adicionar meta: \(error)")
            print("âŒ Detalhes do erro: \(error.localizedDescription)")
            displayStatusNotification(message: "Erro ao criar meta")
        }
    }
    
    private func displayStatusNotification(message: String) {
        statusNotificationMessage = message
        showStatusNotification = true
        
        DispatchQueue.main.asyncAfter(deadline: .now() + 2) {
            showStatusNotification = false
        }
    }
    
    // MARK: - Dashboard Views
    private var dashboardView: some View {
        VStack(spacing: 12) {
            // Cards de receitas
            HStack(spacing: 12) {
                financeCard(
                    title: "Receitas Consolidadas",
                    value: formatCurrency(receitasConsolidadas),
                    subtitle: "Valores recebidos",
                    icon: "arrow.up",
                    gradientColors: isMonochromaticMode ? 
                        [MonochromaticColorManager.darkGreen, MonochromaticColorManager.primaryGreen] :
                        [Color(hex: "#22C55E"), Color(hex: "#16A34A")]
                )

                financeCard(
                    title: "Receitas Pendentes",
                    value: formatCurrency(receitasPendentes),
                    subtitle: "A receber",
                    icon: "clock",
                    gradientColors: isMonochromaticMode ? 
                        [MonochromaticColorManager.primaryGreen, MonochromaticColorManager.secondaryGreen] :
                        [Color(hex: "#4ADE80"), Color(hex: "#22C55E")]
                )
            }
            .padding(.horizontal, 16)

            // Cards de despesas
            HStack(spacing: 12) {
                financeCard(
                    title: "Despesas Pagas",
                    value: formatCurrency(despesasPagas),
                    subtitle: "Valores pagos",
                    icon: "arrow.down",
                    gradientColors: isMonochromaticMode ? 
                        [MonochromaticColorManager.darkGray, MonochromaticColorManager.primaryGray] :
                        [Color(hex: "#EF4444"), Color(hex: "#DC2626")]
                )

                financeCard(
                    title: "Despesas Pendentes",
                    value: formatCurrency(despesasPendentes),
                    subtitle: "A pagar",
                    icon: "clock",
                    gradientColors: isMonochromaticMode ? 
                        [MonochromaticColorManager.primaryGray, MonochromaticColorManager.secondaryGray] :
                        [Color(hex: "#F87171"), Color(hex: "#EF4444")]
                )
            }
            .padding(.horizontal, 16)

            // Saldo consolidado
            saldoConsolidadoCard
                .padding(.horizontal, 16)

            // Saldo projetado
            saldoProjetadoCard
                .padding(.horizontal, 16)

            // Card Progresso geral de Metas (minimalista)
            Button(action: { showGoalsScreen = true }) {
            HStack {
                VStack(alignment: .leading, spacing: 6) {
                    HStack(spacing: 8) {
                        Image(systemName: "target")
                            .font(.system(size: 16))
                            .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : .orange)
                            Text("\(Int(totalProgress * 100))%")
                            .font(.system(size: 15, weight: .bold))
                            .foregroundColor(.primary)
                        Text("Progresso geral de Metas")
                            .font(.system(size: 13, weight: .medium))
                            .foregroundColor(.primary)
                    }
                        ProgressView(value: totalProgress)
                        .progressViewStyle(LinearProgressViewStyle(tint: .orange))
                        .frame(height: 6)
                        .clipShape(Capsule())
                }
                .padding(12)
                .background(Color(UIColor.secondarySystemBackground))
                .cornerRadius(12)
                Spacer()
            }
            .padding(.horizontal, 16)
            }
            .buttonStyle(PlainButtonStyle())
            .sheet(isPresented: $showGoalsScreen) {
                NavigationView {
                    GoalsView()
                        .environmentObject(authViewModel)
                        .navigationTitle("Metas")
                        .navigationBarTitleDisplayMode(.inline)
                }
            }
        }
    }

    private func financeCard(title: String, value: String, subtitle: String, icon: String, gradientColors: [Color]) -> some View {
        ZStack(alignment: .topTrailing) {
            VStack(alignment: .leading, spacing: 2) {
                Text(title)
                    .font(.system(size: 11))
                    .foregroundColor(.white.opacity(0.9))

                Text(value)
                    .font(.system(size: 12, weight: .bold))
                    .foregroundColor(.white)
                    .padding(.vertical, 2)

                Text(subtitle)
                    .font(.system(size: 9))
                    .foregroundColor(.white.opacity(0.8))
            }
            .frame(maxWidth: .infinity, alignment: .leading)
            .padding(.vertical, 8)
            .padding(.horizontal)

            Image(systemName: icon)
                .font(.system(size: 16))
                .foregroundColor(.white.opacity(0.8))
                .padding(8)
        }
        .background(
            LinearGradient(
                gradient: Gradient(colors: gradientColors),
                startPoint: .top,
                endPoint: .bottom
            )
        )
        .cornerRadius(16)
        .shadow(color: Color.black.opacity(0.1), radius: 6, x: 0, y: 3)
    }

    private var saldoConsolidadoCard: some View {
        HStack {
            VStack(alignment: .leading, spacing: 4) {
                Text("Saldo Consolidado")
                    .font(.system(size: 11))
                    .foregroundColor(.white.opacity(0.9))
                Text(saldoConsolidadoVisivel ? formatCurrency(saldoConsolidado) : "â€¢â€¢â€¢â€¢â€¢â€¢")
                    .font(.system(size: 16, weight: .bold))
                    .foregroundColor(.white)
                    .padding(.vertical, 4)
                Text("Apenas valores confirmados")
                    .font(.system(size: 9))
                    .foregroundColor(.white.opacity(0.8))
            }
            
            Spacer()
            
            // Saldo Investido (apenas se existir)
            if saldoInvestido > 0 {
                VStack(alignment: .trailing, spacing: 4) {
                    Text("Saldo Investido")
                        .font(.system(size: 11))
                        .foregroundColor(.white.opacity(0.9))
                    Text(saldoConsolidadoVisivel ? formatCurrency(saldoInvestido) : "â€¢â€¢â€¢â€¢â€¢â€¢")
                        .font(.system(size: 16, weight: .bold))
                        .foregroundColor(.white)
                        .padding(.vertical, 4)
                    Text("Valor total investido")
                        .font(.system(size: 9))
                        .foregroundColor(.white.opacity(0.8))
                }
            }
        }
        .frame(maxWidth: .infinity, alignment: .leading)
        .padding()
        .frame(height: 80)
        .background(
            LinearGradient(
                gradient: Gradient(colors: getSaldoConsolidadoColors()),
                startPoint: .top,
                endPoint: .bottom
            )
        )
        .cornerRadius(16)
        .shadow(color: Color.black.opacity(0.1), radius: 6, x: 0, y: 3)
    }

    private var saldoProjetadoCard: some View {
        ZStack(alignment: .topTrailing) {
            VStack(alignment: .leading, spacing: 4) {
                Text("Saldo Projetado")
                    .font(.system(size: 11))
                    .foregroundColor(.white.opacity(0.9))
                Text(saldoConsolidadoVisivel ? formatCurrency(saldoProjetado) : "â€¢â€¢â€¢â€¢â€¢â€¢")
                    .font(.system(size: 16, weight: .bold))
                    .foregroundColor(.white)
                    .padding(.vertical, 4)
                Text("Incluindo valores pendentes")
                    .font(.system(size: 9))
                    .foregroundColor(.white.opacity(0.8))
            }
            .frame(maxWidth: .infinity, alignment: .leading)
            .padding()

            Button(action: { saldoConsolidadoVisivel.toggle() }) {
                Image(systemName: saldoConsolidadoVisivel ? "eye" : "eye.slash")
                    .font(.system(size: 16))
                    .foregroundColor(.white.opacity(0.8))
                    .padding(12)
            }
        }
        .frame(height: 80)
        .background(
            LinearGradient(
                gradient: Gradient(colors: getProjectedBalanceGradientColors(saldoProjetado: saldoProjetado)),
                startPoint: .top,
                endPoint: .bottom
            )
        )
        .cornerRadius(16)
        .shadow(color: Color.black.opacity(0.1), radius: 6, x: 0, y: 3)
    }
    
    // MARK: - Helper Functions for Saldo Colors
    private func getSaldoConsolidadoColors() -> [Color] {
        if saldoConsolidado < 0 {
            // Saldo negativo
            if isMonochromaticMode {
                return [MonochromaticColorManager.primaryGray, MonochromaticColorManager.secondaryGray]
            } else {
                return [Color(hex: "#DC2626"), Color(hex: "#B91C1C")] // Laranja avermelhado escuro
            }
        // } else {
            // Saldo positivo
            if isMonochromaticMode {
                return [MonochromaticColorManager.primaryGreen, MonochromaticColorManager.secondaryGreen]
            } else {
                return [Color(hex: "#2563EB"), Color(hex: "#1D4ED8")]
            }
        }
    }
    
    private func getProjectedBalanceGradientColors(saldoProjetado: Double) -> [Color] {
        if saldoProjetado < 0 {
            // Saldo negativo
            if isMonochromaticMode {
                return [MonochromaticColorManager.tertiaryGray, MonochromaticColorManager.darkGray]
            } else {
                return [Color(hex: "#EA580C"), Color(hex: "#C2410C")] // Laranja avermelhado mais claro
            }
        // } else {
            // Saldo positivo
            if isMonochromaticMode {
                return [MonochromaticColorManager.lightGreen, MonochromaticColorManager.primaryGreen]
            } else {
                return [Color(hex: "#7C3AED"), Color(hex: "#6D28D9")]
            }
        }
    }

// MARK: - Welcome Notification View
struct WelcomeNotificationView: View {
    let message: String
    @Binding var isVisible: Bool
    
    @State private var dragOffset: CGFloat = 0
    @State private var isDragging = false
    @State private var showNotification = false
    
    var body: some View {
        VStack {
            // NotificaÃ§Ã£o principal
            HStack(spacing: 12) {
                // Ãcone com animaÃ§Ã£o
                Image(systemName: "checkmark.circle.fill")
                    .foregroundColor(.green)
                    .font(.system(size: 20))
                    .scaleEffect(showNotification ? 1.0 : 0.5)
                    .animation(.spring(response: 0.6, dampingFraction: 0.7).delay(0.2), value: showNotification)
                
                // Mensagem
                Text(message)
                    .font(.system(size: 16, weight: .medium))
                    .foregroundColor(.primary)
                    .lineLimit(2)
                    .opacity(showNotification ? 1.0 : 0.0)
                    .animation(.easeOut(duration: 0.4).delay(0.3), value: showNotification)
                
                Spacer()
                
                // Ãcone de fechar
                Button(action: dismissNotification) {
                    Image(systemName: "xmark.circle.fill")
                        .foregroundColor(.gray.opacity(0.6))
                        .font(.system(size: 18))
                }
                .opacity(showNotification ? 1.0 : 0.0)
                .animation(.easeOut(duration: 0.3).delay(0.4), value: showNotification)
            }
            .padding(.horizontal, 16)
            .padding(.vertical, 14)
            .background(
                RoundedRectangle(cornerRadius: 16)
                    .fill(Color(UIColor.secondarySystemBackground))
                    .shadow(color: Color.black.opacity(0.1), radius: 12, x: 0, y: 6)
            )
            .offset(x: dragOffset)
            .scaleEffect(isDragging ? 0.98 : 1.0)
            .gesture(
                DragGesture()
                    .onChanged { value in
                        isDragging = true
                        dragOffset = value.translation.width
                    }
                    .onEnded { value in
                        isDragging = false
                        
                        // Se arrastou para a esquerda ou direita mais de 100 pontos, remove a notificaÃ§Ã£o
                        if abs(value.translation.width) > 100 {
                            withAnimation(.spring(response: 0.6, dampingFraction: 0.8)) {
                                dragOffset = value.translation.width > 0 ? 500 : -500
                            }
                            DispatchQueue.main.asyncAfter(deadline: .now() + 0.3) {
                                dismissNotification()
                            }
                        } else {
                            // Retorna Ã  posiÃ§Ã£o original
                            withAnimation(.spring(response: 0.6, dampingFraction: 0.8)) {
                                dragOffset = 0
                            }
                        }
                    }
            )
            .padding(.horizontal, 16)
            .padding(.top, 50) // Posicionado no topo absoluto
            
            Spacer()
        }
        .transition(.asymmetric(
            insertion: .move(edge: .top).combined(with: .opacity),
            removal: .move(edge: .top).combined(with: .opacity)
        ))
        .animation(.spring(response: 0.8, dampingFraction: 0.8), value: isVisible)
        .zIndex(1000)
        .onAppear {
            withAnimation(.spring(response: 0.8, dampingFraction: 0.8)) {
                showNotification = true
            }
        }
    }
    
    private func dismissNotification() {
        withAnimation(.spring(response: 0.6, dampingFraction: 0.8)) {
            showNotification = false
        }
        
        DispatchQueue.main.asyncAfter(deadline: .now() + 0.2) {
            isVisible = false
        }
    }
}

struct ContentView_Previews: PreviewProvider {
    static var previews: some View {
        ContentView()
            // .environmentObject(AuthViewModel())  // TEMPORARIAMENTE COMENTADO
    }
}

// MARK: - More View
struct MoreView: View {
    @EnvironmentObject var authViewModel: AuthViewModel
    @State private var showExportData = false
    @State private var showImportData = false
    @State private var showHelp = false
    @State private var showContact = false
    @State private var showFeedback = false
    @State private var showAbout = false
    @State private var showPrivacy = false
    @AppStorage("isMonochromaticMode") private var isMonochromaticMode: Bool = false
    
    var body: some View {
        NavigationView {
            ScrollView {
                VStack(spacing: 20) {
                    // SeÃ§Ã£o de Acesso RÃ¡pido
                    VStack(alignment: .leading, spacing: 8) {
                        Text("Acesso RÃ¡pido")
                            .font(.headline)
                            .foregroundColor(.secondary)
                        
                        // BotÃ£o Perfil - Agora usando NavigationLink
                        NavigationLink(destination: ProfileView().environmentObject(authViewModel)) {
                            HStack(spacing: 12) {
                                Image(systemName: "person.circle.fill")
                                    .font(.system(size: 20))
                                    .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : .green)
                                
                                VStack(alignment: .leading, spacing: 2) {
                                    Text("Perfil")
                                        .font(.system(size: 16, weight: .medium))
                                        .foregroundColor(.primary)
                                    
                                    Text("Gerencie sua conta e informaÃ§Ãµes")
                                        .font(.system(size: 12))
                                        .foregroundColor(.secondary)
                                }
                                
                                Spacer()
                                
                                Image(systemName: "chevron.right")
                                    .font(.system(size: 14))
                                    .foregroundColor(.secondary)
                            }
                            .padding()
                            .background(Color(UIColor.secondarySystemBackground))
                            .cornerRadius(12)
                        }
                        .buttonStyle(PlainButtonStyle())
                    }
                    .padding(.horizontal, 16)
                    
                    // SeÃ§Ã£o de Ferramentas
                    VStack(alignment: .leading, spacing: 8) {
                        Text("Ferramentas")
                            .font(.headline)
                            .foregroundColor(.secondary)
                        
                        // BotÃ£o EstatÃ­sticas - Agora usando NavigationLink
                        NavigationLink(destination: ReportsView().environmentObject(authViewModel).environmentObject(GlobalDateManager())) {
                            HStack(spacing: 12) {
                                Image(systemName: "chart.pie.fill")
                                    .font(.system(size: 20))
                                    .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : .blue)
                                
                                VStack(alignment: .leading, spacing: 2) {
                                    Text("EstatÃ­sticas")
                                        .font(.system(size: 16, weight: .medium))
                                        .foregroundColor(.primary)
                                    
                                    Text("Visualize grÃ¡ficos e anÃ¡lises")
                                        .font(.system(size: 12))
                                        .foregroundColor(.secondary)
                                }
                                
                                Spacer()
                                
                                Image(systemName: "chevron.right")
                                    .font(.system(size: 14))
                                    .foregroundColor(.secondary)
                            }
                            .padding()
                            .background(Color(UIColor.secondarySystemBackground))
                            .cornerRadius(12)
                        }
                        .buttonStyle(PlainButtonStyle())
                        
                        // BotÃ£o Metas - Agora usando NavigationLink
                        NavigationLink(destination: NavigationView { GoalsView().environmentObject(authViewModel) }) {
                            HStack(spacing: 12) {
                                Image(systemName: "target")
                                    .font(.system(size: 20))
                                    .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : .orange)
                                
                                VStack(alignment: .leading, spacing: 2) {
                                    Text("Metas")
                                        .font(.system(size: 16, weight: .medium))
                                        .foregroundColor(.primary)
                                    
                                    Text("Defina e acompanhe suas metas")
                                        .font(.system(size: 12))
                                        .foregroundColor(.secondary)
                                }
                                
                                Spacer()
                                
                                Image(systemName: "chevron.right")
                                    .font(.system(size: 14))
                                    .foregroundColor(.secondary)
                            }
                            .padding()
                            .background(Color(UIColor.secondarySystemBackground))
                            .cornerRadius(12)
                        }
                        .buttonStyle(PlainButtonStyle())
                        
                        // BotÃ£o Investimentos - Agora usando NavigationLink
                        NavigationLink(destination: InvestmentsView().environmentObject(authViewModel)) {
                            HStack(spacing: 12) {
                                Image(systemName: "chart.line.uptrend.xyaxis")
                                    .font(.system(size: 20))
                                    .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : .green)
                                
                                VStack(alignment: .leading, spacing: 2) {
                                    Text("Investimentos")
                                        .font(.system(size: 16, weight: .medium))
                                        .foregroundColor(.primary)
                                    
                                    Text("Acompanhe seus investimentos")
                                        .font(.system(size: 12))
                                        .foregroundColor(.secondary)
                                }
                                
                                Spacer()
                                
                                Image(systemName: "chevron.right")
                                    .font(.system(size: 14))
                                    .foregroundColor(.secondary)
                            }
                            .padding()
                            .background(Color(UIColor.secondarySystemBackground))
                            .cornerRadius(12)
                        }
                        .buttonStyle(PlainButtonStyle())
                        
                        // BotÃ£o Categorias - Agora usando NavigationLink
                        NavigationLink(destination: CategoriesView().environmentObject(authViewModel)) {
                            HStack(spacing: 12) {
                                Image(systemName: "folder.fill")
                                    .font(.system(size: 20))
                                    .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : .purple)
                                
                                VStack(alignment: .leading, spacing: 2) {
                                    Text("Categorias")
                                        .font(.system(size: 16, weight: .medium))
                                        .foregroundColor(.primary)
                                    
                                    Text("Gerencie suas categorias")
                                        .font(.system(size: 12))
                                        .foregroundColor(.secondary)
                                }
                                
                                Spacer()
                                
                                Image(systemName: "chevron.right")
                                    .font(.system(size: 14))
                                    .foregroundColor(.secondary)
                            }
                            .padding()
                            .background(Color(UIColor.secondarySystemBackground))
                            .cornerRadius(12)
                        }
                        .buttonStyle(PlainButtonStyle())
                        
                        // BotÃ£o Exportar Dados
                        Button(action: {
                            showExportData = true
                        }) {
                            HStack(spacing: 12) {
                                Image(systemName: "square.and.arrow.up")
                                    .font(.system(size: 20))
                                    .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : .orange)
                                
                                VStack(alignment: .leading, spacing: 2) {
                                    Text("Exportar Dados")
                                        .font(.system(size: 16, weight: .medium))
                                        .foregroundColor(.primary)
                                    
                                    Text("Backup e compartilhamento")
                                        .font(.system(size: 12))
                                        .foregroundColor(.secondary)
                                }
                                
                                Spacer()
                                
                                Image(systemName: "chevron.right")
                                    .font(.system(size: 14))
                                    .foregroundColor(.secondary)
                            }
                            .padding()
                            .background(Color(UIColor.secondarySystemBackground))
                            .cornerRadius(12)
                        }
                        
                        // BotÃ£o Importar Dados
                        Button(action: {
                            showImportData = true
                        }) {
                            HStack(spacing: 12) {
                                Image(systemName: "square.and.arrow.down")
                                    .font(.system(size: 20))
                                    .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : .blue)
                                
                                VStack(alignment: .leading, spacing: 2) {
                                    Text("Importar Dados")
                                        .font(.system(size: 16, weight: .medium))
                                        .foregroundColor(.primary)
                                    
                                    Text("Restaurar dados de backup")
                                        .font(.system(size: 12))
                                        .foregroundColor(.secondary)
                                }
                                
                                Spacer()
                                
                                Image(systemName: "chevron.right")
                                    .font(.system(size: 14))
                                    .foregroundColor(.secondary)
                            }
                            .padding()
                            .background(Color(UIColor.secondarySystemBackground))
                            .cornerRadius(12)
                        }
                    }
                    .padding(.horizontal, 16)
                    
                    // SeÃ§Ã£o de ConfiguraÃ§Ãµes
                    VStack(alignment: .leading, spacing: 8) {
                        Text("ConfiguraÃ§Ãµes")
                            .font(.headline)
                            .foregroundColor(.secondary)
                        
                        // BotÃ£o NotificaÃ§Ãµes - Agora usando NavigationLink
                        NavigationLink(destination: NotificationsView().environmentObject(authViewModel)) {
                            HStack(spacing: 12) {
                                Image(systemName: "bell.fill")
                                    .font(.system(size: 20))
                                    .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : .blue)
                                
                                VStack(alignment: .leading, spacing: 2) {
                                    Text("NotificaÃ§Ãµes")
                                        .font(.system(size: 16, weight: .medium))
                                        .foregroundColor(.primary)
                                    
                                    Text("Gerencie alertas e lembretes")
                                        .font(.system(size: 12))
                                        .foregroundColor(.secondary)
                                }
                                
                                Spacer()
                                
                                Image(systemName: "chevron.right")
                                    .font(.system(size: 14))
                                    .foregroundColor(.secondary)
                            }
                            .padding()
                            .background(Color(UIColor.secondarySystemBackground))
                            .cornerRadius(12)
                        }
                        .buttonStyle(PlainButtonStyle())
                        
                        // BotÃ£o Ajustes - Agora usando NavigationLink
                        NavigationLink(destination: SettingsView().environmentObject(authViewModel)) {
                            HStack(spacing: 12) {
                                Image(systemName: "gearshape.fill")
                                    .font(.system(size: 20))
                                    .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : .gray)
                                
                                VStack(alignment: .leading, spacing: 2) {
                                    Text("Ajustes")
                                        .font(.system(size: 16, weight: .medium))
                                        .foregroundColor(.primary)
                                    
                                    Text("ConfiguraÃ§Ãµes do aplicativo")
                                        .font(.system(size: 12))
                                        .foregroundColor(.secondary)
                                }
                                
                                Spacer()
                                
                                Image(systemName: "chevron.right")
                                    .font(.system(size: 14))
                                    .foregroundColor(.secondary)
                            }
                            .padding()
                            .background(Color(UIColor.secondarySystemBackground))
                            .cornerRadius(12)
                        }
                        .buttonStyle(PlainButtonStyle())
                        
                        // BotÃ£o Seja Premium - Exibir apenas se nÃ£o for premium, exclusive ou lifetime
                        if let accountType = authViewModel.user?.accountType, !accountType.isPremium {
                            NavigationLink(destination: PremiumView()) {
                                HStack(spacing: 12) {
                                    Image(systemName: "crown.fill")
                                        .font(.system(size: 20))
                                        .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : .yellow)
                                    
                                    VStack(alignment: .leading, spacing: 2) {
                                        Text("Seja Premium")
                                            .font(.system(size: 16, weight: .medium))
                                            .foregroundColor(.primary)
                                        
                                        Text("Desbloqueie recursos exclusivos")
                                            .font(.system(size: 12))
                                            .foregroundColor(.secondary)
                                    }
                                    
                                    Spacer()
                                    
                                    Image(systemName: "chevron.right")
                                        .font(.system(size: 14))
                                        .foregroundColor(.secondary)
                                }
                                .padding()
                                .background(Color(UIColor.secondarySystemBackground))
                                .cornerRadius(12)
                            }
                            .buttonStyle(PlainButtonStyle())
                        }
                    }
                    .padding(.horizontal, 16)
                    
                    // SeÃ§Ã£o de Suporte
                    VStack(alignment: .leading, spacing: 8) {
                        Text("Suporte")
                            .font(.headline)
                            .foregroundColor(.secondary)
                        
                        // BotÃ£o Central de Ajuda
                        Button(action: {
                            showHelp = true
                        }) {
                            HStack(spacing: 12) {
                                Image(systemName: "questionmark.circle.fill")
                                    .font(.system(size: 20))
                                    .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : .purple)
                                
                                VStack(alignment: .leading, spacing: 2) {
                                    Text("Central de Ajuda")
                                        .font(.system(size: 16, weight: .medium))
                                        .foregroundColor(.primary)
                                    
                                    Text("Tutoriais e perguntas frequentes")
                                        .font(.system(size: 12))
                                        .foregroundColor(.secondary)
                                }
                                
                                Spacer()
                                
                                Image(systemName: "chevron.right")
                                    .font(.system(size: 14))
                                    .foregroundColor(.secondary)
                            }
                            .padding()
                            .background(Color(UIColor.secondarySystemBackground))
                            .cornerRadius(12)
                        }
                        
                        // BotÃ£o Contato
                        Button(action: {
                            showContact = true
                        }) {
                            HStack(spacing: 12) {
                                Image(systemName: "envelope.fill")
                                    .font(.system(size: 20))
                                    .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : .green)
                                
                                VStack(alignment: .leading, spacing: 2) {
                                    Text("Contato")
                                        .font(.system(size: 16, weight: .medium))
                                        .foregroundColor(.primary)
                                    
                                    Text("Entre em contato conosco")
                                        .font(.system(size: 12))
                                        .foregroundColor(.secondary)
                                }
                                
                                Spacer()
                                
                                Image(systemName: "chevron.right")
                                    .font(.system(size: 14))
                                    .foregroundColor(.secondary)
                            }
                            .padding()
                            .background(Color(UIColor.secondarySystemBackground))
                            .cornerRadius(12)
                        }
                        
                        // BotÃ£o Feedback
                        Button(action: {
                            showFeedback = true
                        }) {
                            HStack(spacing: 12) {
                                Image(systemName: "bubble.left.fill")
                                    .font(.system(size: 20))
                                    .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : .blue)
                                
                                VStack(alignment: .leading, spacing: 2) {
                                    Text("Feedback")
                                        .font(.system(size: 16, weight: .medium))
                                        .foregroundColor(.primary)
                                    
                                    Text("Envie sua opiniÃ£o")
                                        .font(.system(size: 12))
                                        .foregroundColor(.secondary)
                                }
                                
                                Spacer()
                                
                                Image(systemName: "chevron.right")
                                    .font(.system(size: 14))
                                    .foregroundColor(.secondary)
                            }
                            .padding()
                            .background(Color(UIColor.secondarySystemBackground))
                            .cornerRadius(12)
                        }
                    }
                    .padding(.horizontal, 16)
                    
                    // SeÃ§Ã£o de InformaÃ§Ãµes
                    VStack(alignment: .leading, spacing: 8) {
                        Text("InformaÃ§Ãµes")
                            .font(.headline)
                            .foregroundColor(.secondary)
                        
                        // BotÃ£o Sobre o App
                        Button(action: {
                            showAbout = true
                        }) {
                            HStack(spacing: 12) {
                                Image(systemName: "info.circle.fill")
                                    .font(.system(size: 20))
                                    .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : .gray)
                                
                                VStack(alignment: .leading, spacing: 2) {
                                    Text("Sobre o App")
                                        .font(.system(size: 16, weight: .medium))
                                        .foregroundColor(.primary)
                                    
                                    Text("VersÃ£o e informaÃ§Ãµes tÃ©cnicas")
                                        .font(.system(size: 12))
                                        .foregroundColor(.secondary)
                                }
                                
                                Spacer()
                                
                                Image(systemName: "chevron.right")
                                    .font(.system(size: 14))
                                    .foregroundColor(.secondary)
                            }
                            .padding()
                            .background(Color(UIColor.secondarySystemBackground))
                            .cornerRadius(12)
                        }
                        
                        // BotÃ£o PolÃ­tica de Privacidade
                        Button(action: {
                            showPrivacy = true
                        }) {
                            HStack(spacing: 12) {
                                Image(systemName: "hand.raised.fill")
                                    .font(.system(size: 20))
                                    .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : .gray)
                                
                                VStack(alignment: .leading, spacing: 2) {
                                    Text("PolÃ­tica de Privacidade")
                                        .font(.system(size: 16, weight: .medium))
                                        .foregroundColor(.primary)
                                    
                                    Text("Como protegemos seus dados")
                                        .font(.system(size: 12))
                                        .foregroundColor(.secondary)
                                }
                                
                                Spacer()
                                
                                Image(systemName: "chevron.right")
                                    .font(.system(size: 14))
                                    .foregroundColor(.secondary)
                            }
                            .padding()
                            .background(Color(UIColor.secondarySystemBackground))
                            .cornerRadius(12)
                        }
                    }
                    .padding(.horizontal, 16)
                    
                    // BotÃ£o Sair da Conta - Ãšltima opÃ§Ã£o
                    Button(action: {
                        authViewModel.signOut()
                    }) {
                        HStack(spacing: 12) {
                            Image(systemName: "rectangle.portrait.and.arrow.right")
                                .font(.system(size: 20))
                                .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : .red)
                            
                            VStack(alignment: .leading, spacing: 2) {
                                Text("Sair da Conta")
                                    .font(.system(size: 16, weight: .medium))
                                    .foregroundColor(.primary)
                                
                                Text("Fazer logout do aplicativo")
                                    .font(.system(size: 12))
                                    .foregroundColor(.secondary)
                            }
                            
                            Spacer()
                            
                            Image(systemName: "chevron.right")
                                .font(.system(size: 14))
                                .foregroundColor(.secondary)
                        }
                        .padding()
                        .background(Color(UIColor.secondarySystemBackground))
                        .cornerRadius(12)
                    }
                    .buttonStyle(PlainButtonStyle())
                    .padding(.horizontal, 16)
                    .padding(.top, 20)
                    
                    // EspaÃ§amento extra para evitar sobreposiÃ§Ã£o com menu inferior
                    Spacer(minLength: 100)
                }
                .padding(.vertical, 16)
                .padding(.bottom, 120)
            }
            .background(Color(UIColor.systemBackground))
            .navigationTitle("Mais")
            .navigationBarTitleDisplayMode(.inline)
        }
        // Removido o sheet do ExportView - ele deve estar na MoreView
        .sheet(isPresented: $showHelp) {
            // View para central de ajuda
            Text("Central de Ajuda")
                .navigationTitle("Central de Ajuda")
        }
        .sheet(isPresented: $showContact) {
            // View para contato
            Text("Contato")
                .navigationTitle("Contato")
        }
        .sheet(isPresented: $showFeedback) {
            FeedbackView()
                .environmentObject(authViewModel)
        }
        .sheet(isPresented: $showAbout) {
            AboutAppView()
        }
        .sheet(isPresented: $showPrivacy) {
            PrivacyPolicyView()
        }
        .sheet(isPresented: $showImportData) {
            ImportDataView()
                // .environmentObject(authViewModel)  // TEMPORARIAMENTE COMENTADO
        }
    }
}

// MARK: - Status Notification View
struct StatusNotificationView: View {
    let message: String
    @Binding var isVisible: Bool
    
    @State private var dragOffset: CGFloat = 0
    @State private var isDragging = false
    @State private var showNotification = false
    
    var body: some View {
        VStack {
            // NotificaÃ§Ã£o principal
            HStack(spacing: 12) {
                // Ãcone com animaÃ§Ã£o
                Image(systemName: message.contains("Erro") ? "xmark.circle.fill" : "checkmark.circle.fill")
                    .foregroundColor(message.contains("Erro") ? .red : .green)
                    .font(.system(size: 20))
                    .scaleEffect(showNotification ? 1.0 : 0.5)
                    .animation(.spring(response: 0.6, dampingFraction: 0.7).delay(0.2), value: showNotification)
                
                // Mensagem
                Text(message)
                    .font(.system(size: 16, weight: .medium))
                    .foregroundColor(.primary)
                    .lineLimit(2)
                    .opacity(showNotification ? 1.0 : 0.0)
                    .animation(.easeOut(duration: 0.4).delay(0.3), value: showNotification)
                
                Spacer()
                
                // Ãcone de fechar
                Button(action: dismissNotification) {
                    Image(systemName: "xmark.circle.fill")
                        .foregroundColor(.gray.opacity(0.6))
                        .font(.system(size: 18))
                }
                .opacity(showNotification ? 1.0 : 0.0)
                .animation(.easeOut(duration: 0.3).delay(0.4), value: showNotification)
            }
            .padding(.horizontal, 16)
            .padding(.vertical, 14)
            .background(
                RoundedRectangle(cornerRadius: 16)
                    .fill(Color(UIColor.secondarySystemBackground))
                    .shadow(color: Color.black.opacity(0.1), radius: 12, x: 0, y: 6)
            )
            .offset(x: dragOffset)
            .scaleEffect(isDragging ? 0.98 : 1.0)
            .gesture(
                DragGesture()
                    .onChanged { value in
                        isDragging = true
                        dragOffset = value.translation.width
                    }
                    .onEnded { value in
                        isDragging = false
                        
                        // Se arrastou para a esquerda ou direita mais de 100 pontos, remove a notificaÃ§Ã£o
                        if abs(value.translation.width) > 100 {
                            withAnimation(.spring(response: 0.6, dampingFraction: 0.8)) {
                                dragOffset = value.translation.width > 0 ? 500 : -500
                            }
                            DispatchQueue.main.asyncAfter(deadline: .now() + 0.3) {
                                dismissNotification()
                            }
                        } else {
                            // Retorna Ã  posiÃ§Ã£o original
                            withAnimation(.spring(response: 0.6, dampingFraction: 0.8)) {
                                dragOffset = 0
                            }
                        }
                    }
            )
            .padding(.horizontal, 16)
            .padding(.top, 50) // Posicionado no topo absoluto
            
            Spacer()
        }
        .transition(.asymmetric(
            insertion: .move(edge: .top).combined(with: .opacity),
            removal: .move(edge: .top).combined(with: .opacity)
        ))
        .animation(.spring(response: 0.8, dampingFraction: 0.8), value: isVisible)
        .zIndex(1000)
        .onAppear {
            withAnimation(.spring(response: 0.8, dampingFraction: 0.8)) {
                showNotification = true
            }
        }
    }
    
    private func dismissNotification() {
        withAnimation(.spring(response: 0.6, dampingFraction: 0.8)) {
            showNotification = false
        }
        
        DispatchQueue.main.asyncAfter(deadline: .now() + 0.2) {
            isVisible = false
        }
    }
}

// MARK: - Goals View
// TEMPORARIAMENTE COMENTADO PARA COMPILAÃ‡ÃƒO
/*
struct GoalsView: View {
    // MARK: - Properties
    @EnvironmentObject var authViewModel: AuthViewModel
    @Environment(\.presentationMode) private var presentationMode
    @AppStorage("isMonochromaticMode") private var isMonochromaticMode: Bool = false
    @State private var goals: [Any] = []  // TEMPORARIAMENTE ALTERADO - Goal nÃ£o disponÃ­vel
    @State private var goalToEdit: Any?  // TEMPORARIAMENTE ALTERADO - Goal nÃ£o disponÃ­vel
    @State private var statusFilter: String = "all" // "all", "active", "completed"
    @State private var totalTargetAmount: Double = 0
    @State private var totalCurrentAmount: Double = 0
    @State private var totalProgress: Double = 0
    @State private var showStatusNotification = false
    @State private var statusNotificationMessage = ""
    
    @State private var showAddGoalSheet = false
    @State private var showPredefinedGoalsSheet = false
    private let db: Any? = nil // Firestore.firestore() temporariamente desabilitado
    
    // Listener para mudanÃ§as na coleÃ§Ã£o
    @State private var listener: Any??
    
    var body: some View {
        Text("Goals View - Temporariamente desabilitada")
            .foregroundColor(.secondary)
    }
    
    // TEMPORARIAMENTE COMENTADO - Goal nÃ£o disponÃ­vel
    /*
    // MARK: - Computed Properties
    private var filteredGoals: [Goal] {
        var filtered = goals
        
        // Filtro por status
        if statusFilter != "all" {
            filtered = filtered.filter { goal in
                let progress = goal.currentAmount / goal.targetAmount
                if statusFilter == "active" {
                    return progress < 1.0
                } else if statusFilter == "completed" {
                    return progress >= 1.0
                }
                return true
            }
        }
        
        return filtered
    }
    
    var body: some View {
        VStack(spacing: 0) {
            // Filtro de status e categoria (fixo no topo)
            filterView
                .background(Color(UIColor.systemBackground))
            
            Divider()
                .opacity(0.3)
            
            // ConteÃºdo rolÃ¡vel
            Group {
                if goals.isEmpty {
                    emptyStateView
                } else {
                    ScrollView {
                        VStack(spacing: 0) {
                            // Cards de progresso geral
                            progressCardsView
                                .padding(.horizontal, 16)
                                .padding(.vertical, 12)
                            
                            // Filtros de status e categoria
                            filtersView
                                .padding(.horizontal, 16)
                                .padding(.vertical, 4)
                            
                            Divider()
                                .opacity(0.3)
                                .padding(.horizontal, 16)
                            
                            // Lista de metas
                            LazyVStack(spacing: 8) {
                                ForEach(filteredGoals) { goal in
                                    SwipeableGoalRow(
                                        goal: goal,
                                        onEdit: { editGoal(goal) },
                                        onDelete: { deleteGoal(goal) },
                                        onUpdateProgress: { updateGoalProgress(goal, newAmount: $0) },
                                        onTap: { editGoal(goal) }
                                    )
                                    .padding(.horizontal, 16)
                                }
                            }
                            .padding(.vertical, 12)
                            
                            // EspaÃ§amento extra para evitar sobreposiÃ§Ã£o com menu inferior
                            Spacer(minLength: 120)
                        }
                    }
                    .background(Color(UIColor.systemGroupedBackground))
                }
            }
        }
        .background(Color(UIColor.systemGroupedBackground))
        .overlay(
            // NotificaÃ§Ã£o de status
            Group {
                if showStatusNotification {
                    GoalStatusNotificationView(
                        message: statusNotificationMessage,
                        isVisible: $showStatusNotification
                    )
                    .zIndex(1000)
                } else {
                    EmptyView()
                }
            }
        )
        .onAppear {
            setupRealtimeListener()
        }
        .onDisappear {
            listener?.remove()
        }
        .sheet(item: $goalToEdit, onDismiss: {
            // Limpar goalToEdit quando o sheet for fechado
            goalToEdit = nil
        }) { goal in
            EditGoalView(goal: goal) { updatedGoal in
                updateGoal(updatedGoal)
            }
        }
        .sheet(isPresented: $showAddGoalSheet) {
            AddGoalView { newGoal in
                addGoal(newGoal)
            }
            .environmentObject(authViewModel)
        }
        .sheet(isPresented: $showPredefinedGoalsSheet) {
            PredefinedGoalsView { goal in
                addGoal(goal)
            }
            .environmentObject(authViewModel)
        }
        .toolbar {
            ToolbarItem(placement: .navigationBarTrailing) {
                Menu {
                    Button(action: {
                        // Abrir tela de metas prÃ©-definidas
                        showPredefinedGoals()
                    }) {
                        Label("Meta PrÃ©-definida", systemImage: "list.bullet")
                    }
                    
                    Button(action: {
                        // Abrir tela de meta personalizada
                        showAddGoal()
                    }) {
                        Label("Meta Personalizada", systemImage: "plus")
                    }
                } label: {
                    Image(systemName: "plus")
                }
            }
        }
    }
    
    // MARK: - View Components
    private var filterView: some View {
        VStack(spacing: 0) {
            HStack {
                Spacer()
            }
            .padding(.horizontal, 16)
            .padding(.top, 8)
            .padding(.bottom, 12)
        }
    }
    
    private var progressCardsView: some View {
        VStack(spacing: 12) {
            HStack(spacing: 12) {
                // Card de Progresso Geral
                VStack(alignment: .leading, spacing: 8) {
                    HStack {
                        Image(systemName: "target")
                            .font(.system(size: 16))
                            .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : .orange)
                        
                        Text("Progresso Geral")
                            .font(.system(size: 14, weight: .medium))
                            .foregroundColor(.primary)
                        
                        Spacer()
                    }
                    
                    Text("\(Int(totalProgress * 100))%")
                        .font(.system(size: 24, weight: .bold))
                        .foregroundColor(.primary)
                    
                    ProgressView(value: totalProgress)
                        .progressViewStyle(LinearProgressViewStyle(tint: getProgressColor(totalProgress)))
                }
                .padding(16)
                .background(Color(UIColor.secondarySystemBackground))
                .cornerRadius(12)
                
                // Card de Valor Total
                VStack(alignment: .leading, spacing: 8) {
                    HStack {
                        Image(systemName: "banknote")
                            .font(.system(size: 16))
                            .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : .green)
                        
                        Text("Total")
                            .font(.system(size: 14, weight: .medium))
                            .foregroundColor(.primary)
                        
                        Spacer()
                    }
                    
                    Text(formatCurrency(totalCurrentAmount))
                        .font(.system(size: 20, weight: .bold))
                        .foregroundColor(.primary)
                    
                    Text("de " + formatCurrency(totalTargetAmount))
                        .font(.system(size: 12))
                        .foregroundColor(.secondary)
                }
                .padding(16)
                .background(Color(UIColor.secondarySystemBackground))
                .cornerRadius(12)
            }
        }
    }
    
    private var filtersView: some View {
        VStack(spacing: 12) {
            // Filtro de Status
            HStack(spacing: 8) {
                FilterButton(
                    title: getStatusText(),
                    icon: getStatusIcon(),
                    isSelected: statusFilter != "all",
                    backgroundColor: getStatusBackground(),
                    borderColor: getStatusBorderColor()
                ) {
                    withAnimation(.easeInOut(duration: 0.2)) {
                        statusFilter = statusFilter == "all" ? "active" : statusFilter == "active" ? "completed" : "all"
                    }
                }
                
                Spacer()
            }
        }
    }
    
    private var emptyStateView: some View {
        VStack(spacing: 16) {
            Spacer()
            
            ZStack {
                Circle()
                    .fill(Color(UIColor.systemGray5))
                    .frame(width: 80, height: 80)
                
                Image(systemName: "target")
                    .font(.system(size: 32, weight: .light))
                    .foregroundColor(.secondary)
            }
            
            VStack(spacing: 8) {
                Text("Nenhuma meta encontrada")
                    .font(.system(size: 18, weight: .medium))
                    .foregroundColor(.primary)
                
                Text("Crie sua primeira meta financeira para comeÃ§ar a planejar seu futuro")
                    .font(.system(size: 14))
                    .foregroundColor(.secondary)
                    .multilineTextAlignment(.center)
            }
            
            VStack(spacing: 12) {
                Button(action: {
                    showPredefinedGoals()
                }) {
                    HStack {
                        Image(systemName: "list.bullet")
                        Text("Escolher Meta PrÃ©-definida")
                    }
                    .font(.headline)
                    .foregroundColor(.white)
                    .padding()
                    .background(
                        LinearGradient(
                            gradient: Gradient(colors: isMonochromaticMode ? 
                                [MonochromaticColorManager.primaryGreen, MonochromaticColorManager.secondaryGreen] :
                                [Color.blue, Color(hex: "#3B82F6")]),
                            startPoint: .leading,
                            endPoint: .trailing
                        )
                    )
                    .cornerRadius(12)
                }
                
                Button(action: {
                    showAddGoal()
                }) {
                    HStack {
                        Image(systemName: "plus.circle.fill")
                        Text("Criar Meta Personalizada")
                    }
                    .font(.headline)
                    .foregroundColor(.white)
                    .padding()
                    .background(
                        LinearGradient(
                            gradient: Gradient(colors: isMonochromaticMode ? 
                                [MonochromaticColorManager.secondaryGreen, MonochromaticColorManager.primaryGreen] :
                                [Color.green, Color(hex: "#16A34A")]),
                            startPoint: .leading,
                            endPoint: .trailing
                        )
                    )
                    .cornerRadius(12)
                }
            }
            
            Spacer()
        }
        .padding(.horizontal, 32)
        .background(Color(UIColor.systemGroupedBackground))
    }
    
    // MARK: - Data Management
    private func setupRealtimeListener() {
        guard let userId = authViewModel.user?.id else { return }
        
        listener?.remove()
        
        listener = db// .collection("users")// .document(userId)// .collection("goals")
            .whereField("isActive", isEqualTo: true)
            .addSnapshotListener { snapshot, error in
                if let error = error {
                    print("âŒ Erro ao escutar mudanÃ§as: \(error.localizedDescription)")
                    return
                }
                
                guard let documents = snapshot?.documents else {
                    print("âŒ Nenhum documento encontrado")
                    DispatchQueue.main.async {
                        self.goals = []
                        self.calculateTotals()
                    }
                    return
                }
                
                print("ğŸ“„ MudanÃ§as detectadas: \(documents.count) documentos")
                
                DispatchQueue.main.async {
                    self.goals = documents.compactMap { doc -> Goal? in
                        let data = doc.data()
                        
                        return Goal(
                            id: doc.documentID,
                            userId: userId,
                            title: data["title"] as? String ?? "",
                            description: data["description"] as? String ?? "",
                            targetAmount: (data["targetAmount"] as? NSNumber)?.doubleValue ?? 0,
                            currentAmount: (data["currentAmount"] as? NSNumber)?.doubleValue ?? 0,
                            deadline: (data["deadline"] as? Timestamp)?.dateValue() ?? Date(),
                            isPredefined: data["isPredefined"] as? Bool ?? false,
                            predefinedType: data["predefinedType"] as? String,
                            createdAt: (data["createdAt"] as? Timestamp)?.dateValue() ?? Date(),
                            updatedAt: (data["updatedAt"] as? Timestamp)?.dateValue() ?? Date(),
                            isActive: data["isActive"] as? Bool ?? true
                        )
                    }.sorted { $0.createdAt > $1.createdAt }
                    
                    // Calcular totais apÃ³s atualizar as metas
                    self.calculateTotals()
                    
                    print("âœ… Metas atualizadas em tempo real: \(self.goals.count)")
                }
            }
    }
    
    private func calculateTotals() {
        var targetTotal: Double = 0
        var currentTotal: Double = 0
        
        for goal in goals {
            targetTotal += goal.targetAmount
            currentTotal += goal.currentAmount
        }
        
        totalTargetAmount = targetTotal
        totalCurrentAmount = currentTotal
        totalProgress = targetTotal > 0 ? currentTotal / targetTotal : 0
    }
    
    // MARK: - Add Goal
    private func addGoal(_ goal: Any) {  // TEMPORARIAMENTE ALTERADO - Goal nÃ£o disponÃ­vel
        // TEMPORARIAMENTE COMENTADO - AuthViewModel nÃ£o disponÃ­vel
        /*
        guard let userId = authViewModel.user?.id else { 
            print("âŒ UserId nÃ£o encontrado para adicionar meta")
            displayStatusNotification(message: "Erro: UsuÃ¡rio nÃ£o autenticado")
            return 
        }
        */
        
        print("ğŸ¯ Iniciando criaÃ§Ã£o de meta:")
        print("   - TÃ­tulo: \(goal.title)")
        print("   - DescriÃ§Ã£o: \(goal.description)")
        print("   - Meta: R$ \(goal.targetAmount)")
        print("   - Atual: R$ \(goal.currentAmount)")
        print("   - Categoria: \(goal.category)")
        print("   - PrÃ©-definida: \(goal.isPredefined)")
        print("   - UserId: \(userId)")
        
        var newGoal = goal
        newGoal.userId = userId
        
        do {
            print("ğŸ“ Salvando meta no Firebase...")
            let docRef = try db// .collection("users")// .document(userId)// .collection("goals").addDocument(from: newGoal)
            
            print("âœ… Documento criado com ID: \(docRef.documentID)")
            
            // Atualizar o ID do documento
            newGoal.id = docRef.documentID
            try docRef.setData(from: newGoal)
            
            print("âœ… Meta salva com sucesso no Firebase!")
            displayStatusNotification(message: "Meta criada com sucesso!")
            
            // ForÃ§ar atualizaÃ§Ã£o da lista
            DispatchQueue.main.asyncAfter(deadline: .now() + 0.5) {
                self.setupRealtimeListener()
            }
            
        } catch {
            print("âŒ Erro ao adicionar meta: \(error)")
            print("âŒ Detalhes do erro: \(error.localizedDescription)")
            displayStatusNotification(message: "Erro ao criar meta")
        }
    }
    
    // TEMPORARIAMENTE COMENTADO - Goal nÃ£o disponÃ­vel
    /*
    private func editGoal(_ goal: Goal) {
        print("ğŸ”§ editGoal chamada - goal: \(goal.title)")
        goalToEdit = goal
    }
    */
    
    // TEMPORARIAMENTE COMENTADO - Goal nÃ£o disponÃ­vel
    /*
    private func deleteGoal(_ goal: Goal) {
        guard let id = goal.id else { return }
        
        db// .collection("users")// .document(authViewModel.user?.id ?? "")// .collection("goals")
            // .document(id)
            .delete { error in
                if let error = error {
                    print("Erro ao deletar meta: \(error.localizedDescription)")
                    return
                }
                
                // Remove a meta da lista local e recalcula totais
                DispatchQueue.main.async {
                    self.goals.removeAll { $0.id == id }
                    self.calculateTotals()
                    print("Meta deletada com sucesso: \(id)")
                }
            }
    }
    */
    
    // TEMPORARIAMENTE COMENTADO - Goal nÃ£o disponÃ­vel
    /*
    private func updateGoalProgress(_ goal: Goal, newAmount: Double) {
        guard let id = goal.id else { return }
        
        let updatedGoal = Goal(
            id: goal.id,
            userId: goal.userId,
            title: goal.title,
            description: goal.description,
            targetAmount: goal.targetAmount,
            currentAmount: newAmount,
            deadline: goal.deadline,
            isPredefined: goal.isPredefined,
            predefinedType: goal.predefinedType,
            createdAt: goal.createdAt,
            updatedAt: Date(),
            isActive: goal.isActive
        )
        
        do {
            try db// .collection("users")// .document(authViewModel.user?.id ?? "")// .collection("goals")
                // .document(id).setData(from: updatedGoal)
            
            displayStatusNotification(message: "Progresso atualizado!")
        } catch {
            print("âŒ Erro ao atualizar progresso: \(error)")
            displayStatusNotification(message: "Erro ao atualizar progresso")
        }
    }
    */
    
    // TEMPORARIAMENTE COMENTADO - Goal nÃ£o disponÃ­vel
    /*
    private func updateGoal(_ goal: Goal) {
        guard let id = goal.id else { return }
        
        do {
            try db// .collection("users")// .document(authViewModel.user?.id ?? "")// .collection("goals")
                // .document(id).setData(from: goal)
            
            displayStatusNotification(message: "Meta atualizada!")
        } catch {
            print("âŒ Erro ao atualizar meta: \(error)")
            displayStatusNotification(message: "Erro ao atualizar meta")
        }
    }
    */
    
    private func showAddGoal() {
        showAddGoalSheet = true
    }
    
    private func showPredefinedGoals() {
        showPredefinedGoalsSheet = true
    }
    
    private func displayStatusNotification(message: String) {
        statusNotificationMessage = message
        showStatusNotification = true
        
        DispatchQueue.main.asyncAfter(deadline: .now() + 2) {
            showStatusNotification = false
        }
    }
    
    // MARK: - Helper Functions for Status Filter
    private func getStatusText() -> String {
        switch statusFilter {
        case "all":
            return "Status"
        case "active":
            return "Ativas"
        case "completed":
            return "ConcluÃ­das"
        default:
            return "Status"
        }
    }
    
    private func getStatusIcon() -> String {
        switch statusFilter {
        case "all":
            return "list.bullet.circle"
        case "active":
            return "clock.circle.fill"
        case "completed":
            return "checkmark.circle.fill"
        default:
            return "list.bullet.circle"
        }
    }
    
    private func getStatusBackground() -> Color {
        switch statusFilter {
        case "all":
            return Color(UIColor.secondarySystemBackground)
        case "active":
            return isMonochromaticMode ? MonochromaticColorManager.primaryGreen.opacity(0.1) : Color.orange.opacity(0.1)
        case "completed":
            return isMonochromaticMode ? MonochromaticColorManager.primaryGreen.opacity(0.1) : Color.green.opacity(0.1)
        default:
            return Color(UIColor.secondarySystemBackground)
        }
    }
    
    private func getStatusBorderColor() -> Color {
        switch statusFilter {
        case "all":
            return Color(UIColor.separator)
        case "active":
            return isMonochromaticMode ? MonochromaticColorManager.primaryGreen.opacity(0.3) : Color.orange.opacity(0.3)
        case "completed":
            return isMonochromaticMode ? MonochromaticColorManager.primaryGreen.opacity(0.3) : Color.green.opacity(0.3)
        default:
            return Color(UIColor.separator)
        }
    }
    
    private func getProgressColor(_ progress: Double) -> Color {
        if isMonochromaticMode {
            return progress >= 0.8 ? MonochromaticColorManager.primaryGreen : MonochromaticColorManager.primaryGray
        }
        
        if progress >= 0.8 {
            return .green
        } else if progress >= 0.5 {
            return .orange
        // } else {
            return .red
        }
    }
    


// MARK: - Swipeable Goal Row
public struct SwipeableGoalRow: View {
    let goal: Goal
    let onEdit: () -> Void
    let onDelete: () -> Void
    let onUpdateProgress: (Double) -> Void
    let onTap: () -> Void
    
    @State private var offset: CGFloat = 0
    @State private var isShowingActions = false
    @AppStorage("isMonochromaticMode") private var isMonochromaticMode: Bool = false
    
    private let actionButtonWidth: CGFloat = 80
    private let maxOffset: CGFloat = -160 // Para dois botÃµes (esquerda)
    
    init(goal: Goal, onEdit: @escaping () -> Void, onDelete: @escaping () -> Void, onUpdateProgress: @escaping (Double) -> Void, onTap: @escaping () -> Void = {}) {
        self.goal = goal
        self.onEdit = onEdit
        self.onDelete = onDelete
        self.onUpdateProgress = onUpdateProgress
        self.onTap = onTap
    }
    
    public var body: some View {
        ZStack {
            // Background com botÃµes de aÃ§Ã£o da esquerda (apenas quando offset < 0)
            if offset < 0 {
                HStack(spacing: 0) {
                    Spacer()
                    // BotÃ£o Editar
                    Button(action: {
                        offset = 0
                        isShowingActions = false
                        DispatchQueue.main.asyncAfter(deadline: .now() + 0.1) {
                            onEdit()
                        }
                    }) {
                        VStack(spacing: 4) {
                            Image(systemName: "pencil")
                                .font(.system(size: 18, weight: .medium))
                            Text("Editar")
                                .font(.system(size: 12, weight: .medium))
                        }
                        .foregroundColor(.white)
                        .frame(width: actionButtonWidth)
                        .frame(maxHeight: .infinity, alignment: .center)
                        .background(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : Color.blue)
                        .cornerRadius(12)
                    }
                    // BotÃ£o Excluir
                    Button(action: {
                        offset = 0
                        isShowingActions = false
                        DispatchQueue.main.asyncAfter(deadline: .now() + 0.1) {
                            onDelete()
                        }
                    }) {
                        VStack(spacing: 4) {
                            Image(systemName: "trash")
                                .font(.system(size: 18, weight: .medium))
                            Text("Excluir")
                                .font(.system(size: 12, weight: .medium))
                        }
                        .foregroundColor(.white)
                        .frame(width: actionButtonWidth)
                        .frame(maxHeight: .infinity, alignment: .center)
                        .background(isMonochromaticMode ? MonochromaticColorManager.primaryGray : Color.red)
                        .cornerRadius(12)
                    }
                }
                .opacity(min(abs(offset) / 80.0, 1.0)) // Fade in baseado no offset
            }
            // ConteÃºdo principal da meta
            GoalRow(goal: goal)
                .background(Color(UIColor.secondarySystemGroupedBackground))
                .cornerRadius(12)
                .shadow(color: .black.opacity(0.05), radius: 2, x: 0, y: 1)
                .offset(x: offset)
                .gesture(
                    DragGesture()
                        .onChanged { value in
                            let translation = value.translation.width
                            if translation < 0 {
                                offset = max(translation, maxOffset)
                            } else if isShowingActions && translation > 0 && offset < 0 {
                                offset = min(translation + maxOffset, 0)
                            }
                        }
                        .onEnded { value in
                            let translation = value.translation.width
                            let velocity = value.predictedEndTranslation.width - value.translation.width
                            withAnimation(.spring(response: 0.3, dampingFraction: 0.8)) {
                                if translation < -60 || velocity < -300 {
                                    offset = maxOffset
                                    isShowingActions = true
                                } else {
                                    offset = 0
                                    isShowingActions = false
                                }
                            }
                        }
                )
                .onTapGesture {
                    if isShowingActions {
                        withAnimation(.spring(response: 0.3)) {
                            offset = 0
                            isShowingActions = false
                        }
                    } else {
                        onTap()
                    }
                }
        }
        .clipped()
        .frame(height: 80)
    }

// MARK: - Goal Row
// TEMPORARIAMENTE COMENTADO - Goal nÃ£o disponÃ­vel
/*
public struct GoalRow: View {
    let goal: Goal
    @AppStorage("isMonochromaticMode") private var isMonochromaticMode: Bool = false
    
    // Computed properties para quebrar a complexidade
    // TEMPORARIAMENTE COMENTADO - Goal nÃ£o disponÃ­vel
    /*
    private var gradientColors: [Color] {
        let progress = goal.currentAmount / goal.targetAmount
        if progress >= 0.8 {
            return isMonochromaticMode ? 
                [MonochromaticColorManager.primaryGreen.opacity(0.8), MonochromaticColorManager.primaryGreen] :
                [Color.green.opacity(0.8), Color.green]
        } else if progress >= 0.5 {
            return isMonochromaticMode ? 
                [MonochromaticColorManager.primaryGray.opacity(0.8), MonochromaticColorManager.primaryGray] :
                [Color.orange.opacity(0.8), Color.orange]
        // } else {
            return isMonochromaticMode ? 
                [MonochromaticColorManager.primaryGray.opacity(0.8), MonochromaticColorManager.primaryGray] :
                [Color.red.opacity(0.8), Color.red]
        }
    }
    */
    
    // TEMPORARIAMENTE COMENTADO - Goal nÃ£o disponÃ­vel
    /*
    private var iconName: String {
        if goal.isPredefined {
            return "target"
        // } else {
            return "flag"
        }
    }
    */
    
    // TEMPORARIAMENTE COMENTADO - Goal nÃ£o disponÃ­vel
    /*
    private var amountColor: Color {
        let progress = goal.currentAmount / goal.targetAmount
        if isMonochromaticMode {
            return progress >= 0.8 ? MonochromaticColorManager.primaryGreen : MonochromaticColorManager.primaryGray
        }
        
        if progress >= 0.8 {
            return .green
        } else if progress >= 0.5 {
            return .orange
        // } else {
            return .red
        }
    }
    */
    
    // TEMPORARIAMENTE COMENTADO - Goal nÃ£o disponÃ­vel
    /*
    public var body: some View {
        HStack(spacing: 12) {
            // Ãcone da meta
            ZStack {
                Circle()
                    .fill(
                        LinearGradient(
                            colors: gradientColors,
                            startPoint: .topLeading,
                            endPoint: .bottomTrailing
                        )
                    )
                    .frame(width: 44, height: 44)
                Image(systemName: iconName)
                    .font(.system(size: 16, weight: .semibold))
                    .foregroundColor(.white)
            }
            
            // InformaÃ§Ãµes da meta
            VStack(alignment: .leading, spacing: 4) {
                HStack {
                    Text(goal.title)
                        .font(.system(size: 13, weight: .medium))
                        .foregroundColor(.primary)
                        .lineLimit(1)
                    
                    if goal.isPredefined {
                        Text("PrÃ©-definida")
                            .font(.system(size: 8, weight: .medium))
                            .foregroundColor(.white)
                            .padding(.horizontal, 4)
                            .padding(.vertical, 1)
                            .background(Color.blue)
                            .cornerRadius(3)
                    }
                }
                
                HStack {
                    Text(goal.category)
                        .font(.system(size: 11, weight: .medium))
                        .foregroundColor(.secondary)
                    
                    Spacer()
                    
                    Text(formatShortDate(goal.deadline))
                        .font(.system(size: 11, weight: .medium))
                        .foregroundColor(.secondary)
                }
            }
            
            Spacer()
            
            // Valor e progresso da meta - TEMPORARIAMENTE COMENTADO
            /*
            VStack(alignment: .trailing, spacing: 4) {
                Text(formatCurrency(goal.currentAmount))
                    .font(.system(size: 13, weight: .semibold))
                    .foregroundColor(amountColor)
                
                Text("de " + formatCurrency(goal.targetAmount))
                    .font(.system(size: 10))
                    .foregroundColor(.secondary)
                
                Text("\(Int((goal.currentAmount / goal.targetAmount) * 100))%")
                    .font(.system(size: 10, weight: .medium))
                    .foregroundColor(amountColor)
            }
            */
        }
    }
    */
        .padding(.horizontal, 16)
        .padding(.vertical, 12)
        .frame(maxWidth: .infinity)
    */
    
    // TEMPORARIAMENTE COMENTADO - Goal nÃ£o disponÃ­vel
    /*
    private func formatShortDate(_ date: Date) -> String {
        let formatter = DateFormatter()
        formatter.dateFormat = "dd/MM"
        return formatter.string(from: date)
    }
    */
}
*/

// MARK: - Goals View (Simplificada para compilaÃ§Ã£o)
struct GoalsView: View {
    var body: some View {
        Text("Goals View - Temporariamente desabilitada")
            .foregroundColor(.secondary)
    }
}

// MARK: - Filter Button
struct FilterButton: View {
    let title: String
    let icon: String
    let isSelected: Bool
    let backgroundColor: Color
    let borderColor: Color
    let action: () -> Void
    @AppStorage("isMonochromaticMode") private var isMonochromaticMode: Bool = false
    
    var body: some View {
        Button(action: action) {
            HStack(spacing: 6) {
                Image(systemName: icon)
                    .font(.system(size: 12, weight: .medium))
                
                Text(title)
                    .font(.system(size: 12, weight: .medium))
            }
            .foregroundColor(isSelected ? (isMonochromaticMode ? MonochromaticColorManager.primaryGreen : .blue) : .primary)
            .padding(.horizontal, 12)
            .padding(.vertical, 8)
            .background(backgroundColor)
            .overlay(
                RoundedRectangle(cornerRadius: 8)
                    .stroke(borderColor, lineWidth: 1)
            )
            .cornerRadius(8)
        }
        .buttonStyle(PlainButtonStyle())
    }

// MARK: - Goal Status Notification View
struct GoalStatusNotificationView: View {
    let message: String
    @Binding var isVisible: Bool
    @AppStorage("isMonochromaticMode") private var isMonochromaticMode: Bool = false
    
    var body: some View {
        VStack {
            HStack {
                Image(systemName: "checkmark.circle.fill")
                    .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : .green)
                
                Text(message)
                    .font(.system(size: 14, weight: .medium))
                    .foregroundColor(.primary)
                
                Spacer()
            }
            .padding(.horizontal, 16)
            .padding(.vertical, 12)
            .background(Color(UIColor.secondarySystemBackground))
            .cornerRadius(12)
            .shadow(color: .black.opacity(0.1), radius: 4, x: 0, y: 2)
            .padding(.horizontal, 16)
            .padding(.top, 8)
            
            Spacer()
        }
        .opacity(isVisible ? 1 : 0)
        .animation(.easeInOut(duration: 0.3), value: isVisible)
    }

// MARK: - Goal Card
struct GoalCard: View {
    let goal: Goal
    let onUpdate: (Goal) -> Void
    
    @State private var showingEdit = false
    @AppStorage("isMonochromaticMode") private var isMonochromaticMode: Bool = false
    
    var body: some View {
        VStack(alignment: .leading, spacing: 12) {
            HStack {
                VStack(alignment: .leading, spacing: 4) {
                    HStack {
                        Text(goal.title)
                            .font(.headline)
                            .foregroundColor(.primary)
                        
                        if goal.isPredefined {
                            Text("PrÃ©-definida")
                                .font(.system(size: 10, weight: .medium))
                                .foregroundColor(.white)
                                .padding(.horizontal, 6)
                                .padding(.vertical, 2)
                                .background(Color.blue)
                                .cornerRadius(4)
                        }
                    }
                    
                    Text(goal.description)
                        .font(.subheadline)
                        .foregroundColor(.secondary)
                        .lineLimit(2)
                    
                    HStack {
                        Text(goal.category)
                            .font(.caption)
                            .foregroundColor(.white)
                            .padding(.horizontal, 8)
                            .padding(.vertical, 4)
                            .background(getCategoryColor())
                            .cornerRadius(8)
                        
                        Spacer()
                        
                        Text("Criada em \(goal.createdAt, style: .date)")
                            .font(.caption)
                            .foregroundColor(.secondary)
                    }
                }
                
                Spacer()
                
                Button(action: {
                    showingEdit = true
                }) {
                    Image(systemName: "pencil")
                        .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : .blue)
                }
            }
            
            VStack(spacing: 8) {
                HStack {
                    Text("Meta:")
                        .font(.caption)
                        .foregroundColor(.secondary)
                    
                    Spacer()
                    
                    Text(formatCurrency(goal.targetAmount))
                        .font(.headline)
                        .foregroundColor(.primary)
                }
                
                HStack {
                    Text("Atual:")
                        .font(.caption)
                        .foregroundColor(.secondary)
                    
                    Spacer()
                    
                    Text(formatCurrency(goal.currentAmount))
                        .font(.subheadline)
                        .foregroundColor(.primary)
                }
                
                ProgressView(value: min(goal.currentAmount / goal.targetAmount, 1.0))
                    .progressViewStyle(LinearProgressViewStyle(tint: getProgressColor()))
            }
            
            HStack {
                Text("Prazo: \(goal.deadline, style: .date)")
                    .font(.caption)
                    .foregroundColor(.secondary)
                
                Spacer()
                
                Text("\(Int((goal.currentAmount / goal.targetAmount) * 100))%")
                    .font(.caption)
                    .fontWeight(.medium)
                    .foregroundColor(getProgressColor())
            }
        }
        .padding()
        .background(Color(UIColor.secondarySystemBackground))
        .cornerRadius(12)
        .sheet(isPresented: $showingEdit) {
            EditGoalView(goal: goal) { updatedGoal in
                onUpdate(updatedGoal)
            }
        }
    }
    
    private func getCategoryColor() -> Color {
        if isMonochromaticMode {
            return MonochromaticColorManager.primaryGreen
        }
        
        switch goal.category {
        case "EducaÃ§Ã£o": return .blue
        case "Viagem": return .orange
        case "Carro": return .purple
        case "Casa": return .brown
        case "Investimento": return .green
        case "EmergÃªncia": return .red
        default: return .gray
        }
    }
    
    private func getProgressColor() -> Color {
        let progress = goal.currentAmount / goal.targetAmount
        if isMonochromaticMode {
            return progress >= 0.8 ? MonochromaticColorManager.primaryGreen : MonochromaticColorManager.primaryGray
        }
        
        if progress >= 0.8 {
            return .green
        } else if progress >= 0.5 {
            return .orange
        // } else {
            return .red
        }
    }

// MARK: - Edit Goal View
struct EditGoalView: View {
    @Environment(\.presentationMode) private var presentationMode
    @EnvironmentObject var authViewModel: AuthViewModel
    @AppStorage("isMonochromaticMode") private var isMonochromaticMode: Bool = false
    let goal: Goal
    let onUpdate: (Goal) -> Void

    @State private var title: String = ""
    @State private var description: String = ""
    @State private var targetAmount: String = "0,00"
    @State private var currentAmount: String = "0,00"
    @State private var deadline: Date = Date()
    @State private var errorMessage: String?
    @State private var isLoading: Bool = false

    init(goal: Goal, onUpdate: @escaping (Goal) -> Void) {
        self.goal = goal
        self.onUpdate = onUpdate
        let formatter = NumberFormatter()
        formatter.numberStyle = .decimal
        formatter.groupingSeparator = "."
        formatter.groupingSize = 3
        formatter.minimumFractionDigits = 2
        formatter.maximumFractionDigits = 2
        _title = State(initialValue: goal.title)
        _description = State(initialValue: goal.description)
        _targetAmount = State(initialValue: formatter.string(from: NSNumber(value: goal.targetAmount)) ?? "0,00")
        _currentAmount = State(initialValue: formatter.string(from: NSNumber(value: goal.currentAmount)) ?? "0,00")
        _deadline = State(initialValue: goal.deadline)
    }

    var body: some View {
        NavigationView {
            ScrollView {
                VStack(spacing: 0) {
                    // Valor Objetivo - Destaque
                    VStack(spacing: 8) {
                        Text("Valor Objetivo")
                            .font(.system(size: 14, weight: .medium))
                            .foregroundColor(.secondary)
                            .frame(maxWidth: .infinity, alignment: .leading)
                        TextField("R$ 0,00", text: $targetAmount)
                            .font(.system(size: 32, weight: .bold))
                            .multilineTextAlignment(.center)
                            .keyboardType(.numberPad)
                            .padding(.vertical, 16)
                            .background(Color(UIColor.secondarySystemBackground))
                            .cornerRadius(16)
                            .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : .green)
                            .onChange(of: targetAmount) { newValue in
                                targetAmount = formatCurrencyInput(newValue)
                            }
                    }
                    .padding(.horizontal, 20)
                    .padding(.top, 24)

                    // Campos principais
                    VStack(spacing: 0) {
                        // TÃ­tulo
                        FormFieldRow(
                            icon: "text.alignleft",
                            title: "TÃ­tulo"
                        ) {
                            TextField("Nome da meta", text: $title)
                                .textFieldStyle(PlainTextFieldStyle())
                        }
                        Divider().padding(.leading, 56)
                        // DescriÃ§Ã£o
                        FormFieldRow(
                            icon: "text.quote",
                            title: "DescriÃ§Ã£o"
                        ) {
                            TextField("Descreva sua meta", text: $description)
                                .textFieldStyle(PlainTextFieldStyle())
                        }
                        Divider().padding(.leading, 56)
                        // Valor Atual
                        FormFieldRow(
                            icon: "banknote",
                            title: "Valor Atual"
                        ) {
                            TextField("R$ 0,00", text: $currentAmount)
                                .textFieldStyle(PlainTextFieldStyle())
                                .keyboardType(.numberPad)
                                .onChange(of: currentAmount) { newValue in
                                    currentAmount = formatCurrencyInput(newValue)
                                }
                        }
                        Divider().padding(.leading, 56)
                        // Data Limite
                        FormFieldRow(
                            icon: "calendar",
                            title: "Data Limite"
                        ) {
                            DatePicker("", selection: $deadline, displayedComponents: .date)
                                .datePickerStyle(CompactDatePickerStyle())
                                .accentColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : .blue)
                        }
                    }
                    .padding(.top, 24)

                    // BotÃ£o Salvar
                    VStack(spacing: 16) {
                        if let errorMessage = errorMessage {
                            Text(errorMessage)
                                .foregroundColor(.red)
                                .font(.system(size: 14))
                                .multilineTextAlignment(.center)
                                .padding(.horizontal, 20)
                        }
                        Button(action: saveGoal) {
                            HStack {
                                if isLoading {
                                    ProgressView()
                                        .progressViewStyle(CircularProgressViewStyle(tint: .white))
                                        .scaleEffect(0.8)
                                } else {
                                    Text("Salvar AlteraÃ§Ãµes")
                                        .font(.system(size: 16, weight: .semibold))
                                }
                            }
                            .foregroundColor(.white)
                            .frame(maxWidth: .infinity)
                            .padding(.vertical, 16)
                            .background(
                                RoundedRectangle(cornerRadius: 16)
                                    .fill(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : Color.green)
                            )
                        }
                        .disabled(targetAmount.trimmingCharacters(in: .whitespacesAndNewlines).isEmpty || title.isEmpty || isLoading)
                        .padding(.horizontal, 20)
                        .padding(.top, 24)
                    }
                }
            }
            .navigationTitle("Editar Meta")
            .navigationBarTitleDisplayMode(.inline)
            .navigationBarItems(
                leading: Button("Cancelar") {
                    presentationMode.wrappedValue.dismiss()
                }
                .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : Color(hex: "#16A34A")),
                trailing: Button("Salvar") {
                    saveGoal()
                }
                .disabled(targetAmount.trimmingCharacters(in: .whitespacesAndNewlines).isEmpty || title.isEmpty || isLoading)
                .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : Color(hex: "#16A34A"))
            )
        }
    }

    private func saveGoal() {
        guard Auth.auth().currentUser != nil else {
            errorMessage = "UsuÃ¡rio nÃ£o autenticado."
            return
        }
        let cleanedTargetAmount = targetAmount.replacingOccurrences(of: ".", with: "").replacingOccurrences(of: ",", with: ".")
        let cleanedCurrentAmount = currentAmount.replacingOccurrences(of: ".", with: "").replacingOccurrences(of: ",", with: ".")
        guard let targetAmountValue = Double(cleanedTargetAmount) else {
            errorMessage = "Valor objetivo invÃ¡lido."
            return
        }
        guard let currentAmountValue = Double(cleanedCurrentAmount) else {
            errorMessage = "Valor atual invÃ¡lido."
            return
        }
        isLoading = true
        errorMessage = nil
        let updatedGoal = Goal(
            id: goal.id,
            userId: goal.userId,
            title: title,
            description: description,
            targetAmount: targetAmountValue,
            currentAmount: currentAmountValue,
            deadline: deadline,
            category: goal.category,
            isPredefined: goal.isPredefined,
            predefinedType: goal.predefinedType,
            createdAt: goal.createdAt,
            updatedAt: Date(),
            isActive: goal.isActive
        )
        onUpdate(updatedGoal)
        isLoading = false
        presentationMode.wrappedValue.dismiss()
    }
    private func formatCurrencyInput(_ input: String) -> String {
        let cleanedInput = input.replacingOccurrences(of: "[^0-9]", with: "", options: .regularExpression)
        if cleanedInput.isEmpty { return "0,00" }
        let centavos = Int(cleanedInput) ?? 0
        let reais = centavos / 100
        let centavosRestantes = centavos % 100
        let formatter = NumberFormatter()
        formatter.numberStyle = .decimal
        formatter.groupingSeparator = "."
        formatter.groupingSize = 3
        let formattedReais = formatter.string(from: NSNumber(value: reais)) ?? "0"
        let formattedCentavos = String(format: "%02d", centavosRestantes)
        return "\(formattedReais),\(formattedCentavos)"
    }

// MARK: - Goal Model
struct Goal: Identifiable, Codable {
    var id: String?
    var userId: String
    let title: String
    let description: String
    let targetAmount: Double
    let currentAmount: Double
    let deadline: Date
    let category: String
    let isPredefined: Bool
    let predefinedType: String?
    let createdAt: Date
    let updatedAt: Date
    let isActive: Bool
    
    init(id: String? = nil, 
         userId: String,
         title: String, 
         description: String, 
         targetAmount: Double, 
         currentAmount: Double, 
         deadline: Date,
         category: String = "Geral",
         isPredefined: Bool = false,
         predefinedType: String? = nil,
         createdAt: Date = Date(),
         updatedAt: Date = Date(),
         isActive: Bool = true) {
        self.id = id
        self.userId = userId
        self.title = title
        self.description = description
        self.targetAmount = targetAmount
        self.currentAmount = currentAmount
        self.deadline = deadline
        self.category = category
        self.isPredefined = isPredefined
        self.predefinedType = predefinedType
        self.createdAt = createdAt
        self.updatedAt = updatedAt
        self.isActive = isActive
    }

// MARK: - Predefined Goal Types
enum PredefinedGoalType: String, CaseIterable {
    case emergencyFund = "emergency_fund"
    case debtPayment = "debt_payment"
    case travel = "travel"
    case carPurchase = "car_purchase"
    case course = "course"
    case investment = "investment"
    case savings = "savings"
    
    var title: String {
        switch self {
        case .emergencyFund: return "Reserva de EmergÃªncia"
        case .debtPayment: return "Quitar DÃ­vidas"
        case .travel: return "Viajar"
        case .carPurchase: return "Comprar um Carro"
        case .course: return "Fazer um Curso"
        case .investment: return "Investir"
        case .savings: return "Ter R$10 mil Guardados"
        }
    }
    
    var description: String {
        switch self {
        case .emergencyFund: return "Criar uma reserva financeira para emergÃªncias"
        case .debtPayment: return "Pagar todas as dÃ­vidas pendentes"
        case .travel: return "Realizar uma viagem dos sonhos"
        case .carPurchase: return "Comprar um veÃ­culo prÃ³prio"
        case .course: return "Investir em educaÃ§Ã£o e qualificaÃ§Ã£o"
        case .investment: return "Aplicar dinheiro em investimentos"
        case .savings: return "Acumular R$10.000 em poupanÃ§a"
        }
    }
    
    var suggestedAmount: Double {
        switch self {
        case .emergencyFund: return 5000.0
        case .debtPayment: return 3000.0
        case .travel: return 8000.0
        case .carPurchase: return 25000.0
        case .course: return 2000.0
        case .investment: return 10000.0
        case .savings: return 10000.0
        }
    }
    
    var suggestedMonths: Int {
        switch self {
        case .emergencyFund: return 6
        case .debtPayment: return 12
        case .travel: return 18
        case .carPurchase: return 24
        case .course: return 6
        case .investment: return 12
        case .savings: return 18
        }
    }
    
    var icon: String {
        switch self {
        case .emergencyFund: return "shield.fill"
        case .debtPayment: return "creditcard.fill"
        case .travel: return "airplane"
        case .carPurchase: return "car.fill"
        case .course: return "book.fill"
        case .investment: return "chart.line.uptrend.xyaxis"
        case .savings: return "banknote.fill"
        }
    }
    
    var color: String {
        switch self {
        case .emergencyFund: return "green"
        case .debtPayment: return "red"
        case .travel: return "blue"
        case .carPurchase: return "purple"
        case .course: return "orange"
        case .investment: return "green"
        case .savings: return "blue"
        }
    }

// MARK: - Investments View
struct InvestmentsView: View {
    @EnvironmentObject var authViewModel: AuthViewModel
    @EnvironmentObject var globalDateManager: GlobalDateManager
    @Environment(\.presentationMode) private var presentationMode
    @Environment(\.colorScheme) private var colorScheme
    @AppStorage("isMonochromaticMode") private var isMonochromaticMode: Bool = false
    @State private var investments: [Investment] = []
    @State private var showingAddInvestment = false
    @State private var isLoading = false
    @State private var dollarRate: Double = 5.25
    @State private var bitcoinPrice: Double = 350000.0
    @State private var bitcoinPriceUSD: Double = 65000.0
    @State private var isLoadingRates = false
    @State private var lastUpdateTime = Date()
    @State private var updateTimer: Timer?
    @State private var statusFilter: String = "all" // "all", "active", "completed"
    
    // Listener para mudanÃ§as na coleÃ§Ã£o
    @State private var listener: Any??
    private let db: Any? = nil // Firestore.firestore() temporariamente desabilitado
    
    // MARK: - Computed Properties
    private var filteredInvestments: [Investment] {
        var filtered = investments
        
        // Filtro por status - como investimentos nÃ£o tÃªm status, vamos filtrar por data
        if statusFilter != "all" {
            let currentDate = Date()
            filtered = filtered.filter { investment in
                if statusFilter == "active" {
                    // Investimentos "ativos" sÃ£o os mais recentes (Ãºltimos 12 meses)
                    let twelveMonthsAgo = Calendar.current.date(byAdding: .month, value: -12, to: currentDate) ?? currentDate
                    return investment.startDate >= twelveMonthsAgo
                } else if statusFilter == "completed" {
                    // Investimentos "concluÃ­dos" sÃ£o os mais antigos (mais de 12 meses)
                    let twelveMonthsAgo = Calendar.current.date(byAdding: .month, value: -12, to: currentDate) ?? currentDate
                    return investment.startDate < twelveMonthsAgo
                }
                return true
            }
        }
        
        return filtered
    }
    
    var body: some View {
        VStack(spacing: 0) {
            // Filtro de perÃ­odo (fixo no topo)
            filterView
                .background(Color(UIColor.systemBackground))
            
            Divider()
                .opacity(0.3)
            
            // ConteÃºdo rolÃ¡vel
            Group {
                if isLoading {
                    loadingView
                } else if investments.isEmpty {
                    emptyStateView
                } else {
                    ScrollView {
                        VStack(spacing: 0) {
                            // Cards de CotaÃ§Ãµes
                            exchangeRatesView
                                .padding(.horizontal, 16)
                                .padding(.vertical, 12)
                            
                            // Filtros de status
                            filtersView
                                .padding(.horizontal, 16)
                                .padding(.vertical, 4)
                            
                            Divider()
                                .opacity(0.3)
                                .padding(.horizontal, 16)
                            
                            // Lista de investimentos
                            LazyVStack(spacing: 8) {
                                ForEach(filteredInvestments) { investment in
                                    InvestmentCard(investment: investment, onUpdate: updateInvestment)
                                        .padding(.horizontal, 16)
                                }
                            }
                            .padding(.vertical, 12)
                            
                            // EspaÃ§amento extra para evitar sobreposiÃ§Ã£o com menu inferior
                            Spacer(minLength: 120)
                        }
                    }
                    .background(Color(UIColor.systemGroupedBackground))
                }
            }
        }
        .background(Color(UIColor.systemGroupedBackground))
        .navigationTitle("Investimentos")
        .navigationBarTitleDisplayMode(.inline)
        .toolbar {
            ToolbarItem(placement: .navigationBarTrailing) {
                Button(action: {
                    showingAddInvestment = true
                }) {
                    Image(systemName: "plus")
                        .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : .blue)
                }
            }
        }
        .onAppear {
            setupRealtimeListener()
            startExchangeRateUpdates()
        }
        .onDisappear {
            listener?.remove()
            stopExchangeRateUpdates()
        }
        .sheet(isPresented: $showingAddInvestment) {
            AddInvestmentView { newInvestment in
                addInvestment(newInvestment)
            }
        }
    }
    
    // MARK: - View Components
    private var loadingView: some View {
        VStack(spacing: 20) {
            ProgressView()
                .scaleEffect(1.5)
                .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : .blue)
            Text("Carregando investimentos...")
                .foregroundColor(.secondary)
        }
        .frame(maxWidth: .infinity, maxHeight: .infinity)
    }
    
    private var emptyStateView: some View {
        VStack(spacing: 16) {
            Spacer()
            
            ZStack {
                Circle()
                    .fill(Color(UIColor.systemGray5))
                    .frame(width: 80, height: 80)
                
                Image(systemName: "chart.line.uptrend.xyaxis")
                    .font(.system(size: 32, weight: .light))
                    .foregroundColor(.secondary)
            }
            
            VStack(spacing: 8) {
                Text("Nenhum investimento encontrado")
                    .font(.system(size: 18, weight: .medium))
                    .foregroundColor(.primary)
                
                Text("Neste perÃ­odo nÃ£o hÃ¡ investimentos registrados")
                    .font(.system(size: 14))
                    .foregroundColor(.secondary)
                    .multilineTextAlignment(.center)
            }
            
            Button(action: {
                showingAddInvestment = true
            }) {
                HStack {
                    Image(systemName: "plus.circle.fill")
                    Text("Adicionar Investimento")
                }
                .font(.headline)
                .foregroundColor(.white)
                .padding()
                .background(
                    (isMonochromaticMode ?
                        LinearGradient(
                            gradient: Gradient(colors: [MonochromaticColorManager.primaryGreen, MonochromaticColorManager.secondaryGreen]),
                            startPoint: .leading,
                            endPoint: .trailing
                        ).asAnyShapeStyle() :
                        Color.blue.asAnyShapeStyle())
                )
                .cornerRadius(12)
                .shadow(color: Color.black.opacity(0.1), radius: 4, x: 0, y: 2)
            }
            
            Spacer()
        }
        .padding(.horizontal, 32)
        .background(Color(UIColor.systemGroupedBackground))
    }
    
    private var filterView: some View {
        HStack(spacing: 20) {
            Button(action: previousPeriod) {
                Image(systemName: "chevron.left")
                    .foregroundColor(globalDateManager.canNavigateBackward() ? .primary : .gray.opacity(0.3))
                    .font(.system(size: 18, weight: .medium))
                    .frame(width: 44, height: 44)
                    .background(Color(UIColor.secondarySystemBackground))
                    .clipShape(Circle())
            }
            .disabled(!globalDateManager.canNavigateBackward())
            
            Spacer()
            
            // Menu de perÃ­odo
            Menu {
                if globalDateManager.periodType != .monthly {
                    Button(action: {
                        globalDateManager.updatePeriodType(.monthly)
                        setupRealtimeListener()
                    }) {
                        Text("Mensal")
                        if globalDateManager.periodType == .monthly {
                            Image(systemName: "checkmark")
                        }
                    }
                }
                if globalDateManager.periodType != .yearly {
                    Button(action: {
                        globalDateManager.updatePeriodType(.yearly)
                        setupRealtimeListener()
                    }) {
                        Text("Anual")
                        if globalDateManager.periodType == .yearly {
                            Image(systemName: "checkmark")
                        }
                    }
                }
                if globalDateManager.periodType != .allTime {
                    Button(action: {
                        globalDateManager.updatePeriodType(.allTime)
                        setupRealtimeListener()
                    }) {
                        Text("Todo o perÃ­odo")
                        if globalDateManager.periodType == .allTime {
                            Image(systemName: "checkmark")
                        }
                    }
                }
            } label: {
                HStack(spacing: 6) {
                    Text(globalDateManager.getCurrentDateRange().displayText)
                        .font(.system(size: 18, weight: .semibold))
                        .foregroundColor(.primary)
                        .lineLimit(1)
                        .minimumScaleFactor(0.8)
                    Image(systemName: "chevron.down")
                        .font(.system(size: 12))
                        .foregroundColor(.secondary)
                }
                .padding(.horizontal, 12)
                .padding(.vertical, 6)
                .background(Color(UIColor.secondarySystemBackground))
                .cornerRadius(16)
            }
            .buttonStyle(PlainButtonStyle())
            
            Spacer()
            
            Button(action: nextPeriod) {
                Image(systemName: "chevron.right")
                    .foregroundColor(globalDateManager.canNavigateForward() ? .primary : .gray.opacity(0.3))
                    .font(.system(size: 18, weight: .medium))
                    .frame(width: 44, height: 44)
                    .background(Color(UIColor.secondarySystemBackground))
                    .clipShape(Circle())
            }
            .disabled(!globalDateManager.canNavigateForward())
        }
        .padding(.horizontal, 20)
        .padding(.vertical, 8)
    }
    
    private var exchangeRatesView: some View {
        VStack(spacing: 12) {
            HStack {
                Text("CotaÃ§Ãµes em Tempo Real")
                    .font(.headline)
                    .foregroundColor(.secondary)
                
                Spacer()
                
                // BotÃ£o de atualizaÃ§Ã£o manual
                Button(action: {
                    loadExchangeRates()
                }) {
                    Image(systemName: "arrow.clockwise")
                        .font(.system(size: 14))
                        .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : .blue)
                }
                .disabled(isLoadingRates)
                
                // Indicador de atualizaÃ§Ã£o
                HStack(spacing: 4) {
                    if isLoadingRates {
                        ProgressView()
                            .scaleEffect(0.6)
                            .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : .blue)
                    } else {
                        Image(systemName: "clock")
                            .font(.system(size: 12))
                            .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : .blue)
                    }
                    
                    Text(formatLastUpdate())
                        .font(.caption)
                        .foregroundColor(.secondary)
                }
            }
            
            HStack(spacing: 12) {
                // Card DÃ³lar
                VStack(alignment: .leading, spacing: 8) {
                    HStack {
                        Image(systemName: "dollarsign.circle")
                            .font(.system(size: 20))
                            .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : .green)
                        Text("DÃ³lar Hoje")
                            .font(.system(size: 14, weight: .medium))
                            .foregroundColor(.primary)
                    }
                    
                    if isLoadingRates {
                        ProgressView()
                            .scaleEffect(0.8)
                            .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : .blue)
                    } else {
                        Text(formatCurrency(dollarRate))
                            .font(.system(size: 16, weight: .bold))
                            .foregroundColor(.primary)
                    }
                }
                .frame(maxWidth: .infinity, alignment: .leading)
                .frame(height: 70)
                .padding()
                .background(
                    RoundedRectangle(cornerRadius: 12)
                        .fill(MonochromaticColorManager.cardBackgroundColor(isMonochromatic: isMonochromaticMode, isDarkMode: colorScheme == .dark))
                        .overlay(
                            RoundedRectangle(cornerRadius: 12)
                                .stroke(isMonochromaticMode ? MonochromaticColorManager.primaryGreen.opacity(0.2) : Color.clear, lineWidth: 1)
                        )
                )
                
                // Card Bitcoin
                VStack(alignment: .leading, spacing: 8) {
                    HStack {
                        Image(systemName: "bitcoinsign.circle")
                            .font(.system(size: 20))
                            .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : .orange)
                        Text("Bitcoin")
                            .font(.system(size: 14, weight: .medium))
                            .foregroundColor(.primary)
                    }
                    
                    if isLoadingRates {
                        ProgressView()
                            .scaleEffect(0.8)
                            .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : .blue)
                    } else {
                        VStack(alignment: .leading, spacing: 2) {
                            Text(formatCurrency(bitcoinPrice))
                                .font(.system(size: 16, weight: .bold))
                                .foregroundColor(.primary)
                            
                            Text(formatCurrencyUSD(bitcoinPriceUSD))
                                .font(.system(size: 10))
                                .foregroundColor(.secondary)
                        }
                    }
                }
                .frame(maxWidth: .infinity, alignment: .leading)
                .frame(height: 70)
                .padding()
                .background(
                    RoundedRectangle(cornerRadius: 12)
                        .fill(MonochromaticColorManager.cardBackgroundColor(isMonochromatic: isMonochromaticMode, isDarkMode: colorScheme == .dark))
                        .overlay(
                            RoundedRectangle(cornerRadius: 12)
                                .stroke(isMonochromaticMode ? MonochromaticColorManager.primaryGreen.opacity(0.2) : Color.clear, lineWidth: 1)
                        )
                )
            }
        }
    }
    
    private var filtersView: some View {
        HStack(spacing: 12) {
            // BotÃ£o de Status - Alterna entre: Status â†’ Ativos â†’ ConcluÃ­dos â†’ Status
            Button(action: {
                switch statusFilter {
                case "all":
                    statusFilter = "active"
                case "active":
                    statusFilter = "completed"
                case "completed":
                    statusFilter = "all"
                default:
                    statusFilter = "all"
                }
            }) {
                HStack(spacing: 6) {
                    Image(systemName: getStatusIcon())
                        .font(.system(size: 14, weight: .medium))
                    Text(getStatusText())
                        .font(.system(size: 14, weight: .medium))
                }
                .foregroundColor(getStatusColor())
                .padding(.horizontal, 12)
                .padding(.vertical, 8)
                .background(getStatusBackground())
                .cornerRadius(20)
                .overlay(
                    RoundedRectangle(cornerRadius: 20)
                        .stroke(getStatusBorderColor(), lineWidth: 1)
                )
            }
            
            Spacer()
        }
    }
    
    // MARK: - Helper Functions for Status Filter
    private func getStatusText() -> String {
        switch statusFilter {
        case "all":
            return "Status"
        case "active":
            return "Ativos"
        case "completed":
            return "ConcluÃ­dos"
        default:
            return "Status"
        }
    }
    
    private func getStatusIcon() -> String {
        switch statusFilter {
        case "all":
            return "line.3.horizontal.decrease.circle"
        case "active":
            return "chart.line.uptrend.xyaxis"
        case "completed":
            return "checkmark.circle.fill"
        default:
            return "line.3.horizontal.decrease.circle"
        }
    }
    
    private func getStatusColor() -> Color {
        switch statusFilter {
        case "all":
            return isMonochromaticMode ? MonochromaticColorManager.primaryGreen : .primary
        case "active":
            return isMonochromaticMode ? MonochromaticColorManager.primaryGreen : .green
        case "completed":
            return isMonochromaticMode ? MonochromaticColorManager.primaryGreen : .blue
        default:
            return isMonochromaticMode ? MonochromaticColorManager.primaryGreen : .primary
        }
    }
    
    private func getStatusBackground() -> Color {
        switch statusFilter {
        case "all":
            return Color(UIColor.secondarySystemBackground)
        case "active":
            return isMonochromaticMode ? MonochromaticColorManager.primaryGreen.opacity(0.1) : Color.green.opacity(0.1)
        case "completed":
            return isMonochromaticMode ? MonochromaticColorManager.primaryGreen.opacity(0.1) : Color.blue.opacity(0.1)
        default:
            return Color(UIColor.secondarySystemBackground)
        }
    }
    
    private func getStatusBorderColor() -> Color {
        switch statusFilter {
        case "all":
            return Color(UIColor.separator)
        case "active":
            return isMonochromaticMode ? MonochromaticColorManager.primaryGreen.opacity(0.3) : Color.green.opacity(0.3)
        case "completed":
            return isMonochromaticMode ? MonochromaticColorManager.primaryGreen.opacity(0.3) : Color.blue.opacity(0.3)
        default:
            return Color(UIColor.separator)
        }
    }
    
    // MARK: - Navigation Functions
    private func previousPeriod() {
        globalDateManager.previousPeriod()
        setupRealtimeListener()
    }
    
    private func nextPeriod() {
        globalDateManager.nextPeriod()
        setupRealtimeListener()
    }
    
    // MARK: - Realtime Listener
    private func setupRealtimeListener() {
        guard let userId = authViewModel.user?.id else {
            print("âš ï¸ UserId nÃ£o encontrado")
            return
        }
        
        // Remove listener anterior se existir
        listener?.remove()
        
        let dateFormatter = DateFormatter()
        dateFormatter.dateFormat = "yyyy-MM-dd"
        
        let currentRange = globalDateManager.getCurrentDateRange()
        let startStr = dateFormatter.string(from: currentRange.start)
        let endStr = dateFormatter.string(from: currentRange.end)
        
        print("ğŸ” Configurando listener de investimentos em tempo real")
        print("ğŸ‘¤ UserId: \(userId)")
        print("ğŸ“… PerÃ­odo: \(startStr) atÃ© \(endStr)")
        
        listener = db// .collection("transactions")
            .whereField("userId", isEqualTo: userId)
            .whereField("type", isEqualTo: "investment")
            .whereField("date", isGreaterThanOrEqualTo: startStr)
            .whereField("date", isLessThanOrEqualTo: endStr)
            .order(by: "date", descending: true)
            .addSnapshotListener { snapshot, error in
                if let error = error {
                    print("âŒ Erro ao escutar mudanÃ§as: \(error.localizedDescription)")
                    return
                }
                
                guard let documents = snapshot?.documents else {
                    print("âŒ Nenhum documento encontrado")
                    DispatchQueue.main.async {
                        self.investments = []
                        self.isLoading = false
                    }
                    return
                }
                
                print("ğŸ“„ MudanÃ§as detectadas: \(documents.count) documentos")
                
                DispatchQueue.main.async {
                    self.investments = documents.compactMap { doc -> Investment? in
                        let data = doc.data()
                        
                        return Investment(
                            id: doc.documentID,
                            name: data["title"] as? String ?? data["description"] as? String ?? "Investimento",
                            type: InvestmentType.other,
                            amount: (data["amount"] as? NSNumber)?.doubleValue ?? 0,
                            startDate: dateFormatter.date(from: data["date"] as? String ?? "") ?? Date(),
                            notes: data["description"] as? String ?? ""
                        )
                    }.sorted { $0.startDate > $1.startDate }
                    
                    self.isLoading = false
                    print("âœ… Investimentos atualizados em tempo real: \(self.investments.count)")
                }
            }
    }
    
    private func startExchangeRateUpdates() {
        // Carregar dados imediatamente
        loadExchangeRates()
        
        // Configurar timer para atualizaÃ§Ã£o automÃ¡tica a cada 5 minutos
        updateTimer = Timer.scheduledTimer(withTimeInterval: 300, repeats: true) { _ in
            loadExchangeRates()
        }
    }
    
    private func stopExchangeRateUpdates() {
        updateTimer?.invalidate()
        updateTimer = nil
    }
    
    private func loadExchangeRates() {
        isLoadingRates = true
        
        // Buscar dados do dÃ³lar (API do Banco Central)
        loadDollarRate()
        
        // Buscar dados do Bitcoin (API CoinGecko)
        loadBitcoinPrice()
    }
    
    private func loadDollarRate() {
        // API do Banco Central do Brasil
        guard let url = URL(string: "https://economia.awesomeapi.com.br/last/USD-BRL") else {
            print("âŒ URL invÃ¡lida para dÃ³lar")
            isLoadingRates = false
            return
        }
        
        URLSession.shared.dataTask(with: url) { data, response, error in
            DispatchQueue.main.async {
                if let error = error {
                    print("âŒ Erro ao buscar dÃ³lar: \(error)")
                    // Fallback para valor simulado
                    self.dollarRate = 5.25 + Double.random(in: -0.1...0.1)
                    self.isLoadingRates = false
                    return
                }
                
                guard let data = data else {
                    print("âŒ Sem dados do dÃ³lar")
                    self.dollarRate = 5.25 + Double.random(in: -0.1...0.1)
                    self.isLoadingRates = false
                    return
                }
                
                do {
                    if let json = try JSONSerialization.jsonObject(with: data) as? [String: Any],
                       let usdBRL = json["USDBRL"] as? [String: Any],
                       let bid = usdBRL["bid"] as? String,
                       let rate = Double(bid) {
                        self.dollarRate = rate
                        print("âœ… DÃ³lar atualizado: R$ \(rate)")
                    } else {
                        print("âŒ Formato de resposta invÃ¡lido para dÃ³lar")
                        self.dollarRate = 5.25 + Double.random(in: -0.1...0.1)
                    }
                } catch {
                    print("âŒ Erro ao decodificar resposta do dÃ³lar: \(error)")
                    self.dollarRate = 5.25 + Double.random(in: -0.1...0.1)
                }
                
                self.lastUpdateTime = Date()
                self.isLoadingRates = false
            }
        }.resume()
    }
    
    private func loadBitcoinPrice() {
        // API CoinGecko para Bitcoin em BRL e USD
        guard let url = URL(string: "https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=brl,usd") else {
            print("âŒ URL invÃ¡lida para Bitcoin")
            DispatchQueue.main.async {
                self.isLoadingRates = false
            }
            return
        }
        
        URLSession.shared.dataTask(with: url) { data, response, error in
            DispatchQueue.main.async {
                if let error = error {
                    print("âŒ Erro ao buscar Bitcoin: \(error)")
                    // Fallback para valor simulado
                    self.bitcoinPrice = 350000 + Double.random(in: -5000...5000)
                    self.bitcoinPriceUSD = 65000 + Double.random(in: -1000...1000)
                    self.isLoadingRates = false
                    return
                }
                
                guard let data = data else {
                    print("âŒ Sem dados do Bitcoin")
                    self.bitcoinPrice = 350000 + Double.random(in: -5000...5000)
                    self.bitcoinPriceUSD = 65000 + Double.random(in: -1000...1000)
                    self.isLoadingRates = false
                    return
                }
                
                do {
                    if let json = try JSONSerialization.jsonObject(with: data) as? [String: Any],
                       let bitcoin = json["bitcoin"] as? [String: Any],
                       let brl = bitcoin["brl"] as? Double,
                       let usd = bitcoin["usd"] as? Double {
                        self.bitcoinPrice = brl
                        self.bitcoinPriceUSD = usd
                        print("âœ… Bitcoin atualizado: R$ \(brl) / $ \(usd)")
                    } else {
                        print("âŒ Formato de resposta invÃ¡lido para Bitcoin")
                        self.bitcoinPrice = 350000 + Double.random(in: -5000...5000)
                        self.bitcoinPriceUSD = 65000 + Double.random(in: -1000...1000)
                    }
                } catch {
                    print("âŒ Erro ao decodificar resposta do Bitcoin: \(error)")
                    self.bitcoinPrice = 350000 + Double.random(in: -5000...5000)
                    self.bitcoinPriceUSD = 65000 + Double.random(in: -1000...1000)
                }
                
                self.isLoadingRates = false
            }
        }.resume()
    }
    
    private func formatLastUpdate() -> String {
        let formatter = DateFormatter()
        formatter.dateFormat = "HH:mm"
        return "Atualizado Ã s \(formatter.string(from: lastUpdateTime))"
    }
    
    private func addInvestment(_ investment: Investment) {
        print("âœ… Investimento adicionado: \(investment.name)")
        // Aqui vocÃª pode adicionar a lÃ³gica do Firestore quando necessÃ¡rio
    }
    
    private func updateInvestment(_ investment: Investment) {
        print("âœ… Investimento atualizado: \(investment.name)")
        // Aqui vocÃª pode adicionar a lÃ³gica do Firestore quando necessÃ¡rio
    }

// MARK: - Investment Card
struct InvestmentCard: View {
    let investment: Investment
    let onUpdate: (Investment) -> Void
    @AppStorage("isMonochromaticMode") private var isMonochromaticMode: Bool = false
    @Environment(\.colorScheme) private var colorScheme
    
    @State private var showingEdit = false
    
    var body: some View {
        VStack(alignment: .leading, spacing: 12) {
            HStack {
                VStack(alignment: .leading, spacing: 4) {
                    Text(investment.name)
                        .font(.headline)
                        .foregroundColor(.primary)
                    
                    Text(investment.type.rawValue)
                        .font(.caption)
                        .foregroundColor(.white)
                        .padding(.horizontal, 8)
                        .padding(.vertical, 4)
                        .background(
                            isMonochromaticMode ? MonochromaticColorManager.primaryGreen : Color.green
                        )
                        .cornerRadius(8)
                }
                
                Spacer()
                
                Button(action: {
                    showingEdit = true
                }) {
                    Image(systemName: "pencil")
                        .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : .blue)
                }
            }
            
            VStack(spacing: 8) {
                HStack {
                    Text("Valor investido:")
                        .font(.caption)
                        .foregroundColor(.secondary)
                    
                    Spacer()
                    
                    Text(formatCurrency(investment.amount))
                        .font(.headline)
                        .foregroundColor(.primary)
                }
                
                HStack {
                    Text("Data de inÃ­cio:")
                        .font(.caption)
                        .foregroundColor(.secondary)
                    
                    Spacer()
                    
                    Text(investment.startDate, style: .date)
                        .font(.subheadline)
                        .foregroundColor(.primary)
                }
            }
            
            if !investment.notes.isEmpty {
                Text(investment.notes)
                    .font(.caption)
                    .foregroundColor(.secondary)
                    .padding(.top, 4)
            }
        }
        .padding()
        .background(
            RoundedRectangle(cornerRadius: 12)
                .fill(MonochromaticColorManager.cardBackgroundColor(isMonochromatic: isMonochromaticMode, isDarkMode: colorScheme == .dark))
                .overlay(
                    RoundedRectangle(cornerRadius: 12)
                        .stroke(isMonochromaticMode ? MonochromaticColorManager.primaryGreen.opacity(0.2) : Color.clear, lineWidth: 1)
                )
        )
        .sheet(isPresented: $showingEdit) {
            EditInvestmentView(investment: investment) { updatedInvestment in
                onUpdate(updatedInvestment)
            }
        }
    }

// MARK: - Add Investment View
struct AddInvestmentView: View {
    @Environment(\.presentationMode) var presentationMode
    @EnvironmentObject var authViewModel: AuthViewModel
    @EnvironmentObject var globalDateManager: GlobalDateManager
    @AppStorage("isMonochromaticMode") private var isMonochromaticMode: Bool = false
    
    let onSave: (Investment) -> Void
    
    @State private var type: String = "investment"
    @State private var amount: String = "0,00"
    @State private var description: String = ""
    @State private var category: String = "Investimento"
    @State private var date: Date = Date()
    @State private var isPaid: Bool = true
    @State private var isRecurring: Bool = false
    @State private var recurringFrequency: String = "monthly"
    @State private var recurringEndDate: Date = Date()
    @State private var errorMessage: String?
    @State private var isLoading: Bool = false
    
    let frequencies = ["monthly", "weekly", "yearly"]
    let categories = ["Investimento", "AÃ§Ãµes", "TÃ­tulos", "ImÃ³veis", "Criptomoedas", "Fundos", "Outros"]
    
    var body: some View {
        NavigationView {
            ScrollView {
                VStack(spacing: 0) {
                    // Tipo de TransaÃ§Ã£o - Header (apenas Investimento)
                    VStack(spacing: 16) {
                        HStack(spacing: 12) {
                            // Investimento (Ãºnica opÃ§Ã£o)
                            HStack(spacing: 8) {
                                Image(systemName: "chart.line.uptrend.xyaxis")
                                    .font(.system(size: 16, weight: .semibold))
                                    .foregroundColor(.white)
                                
                                Text("Investimento")
                                    .font(.system(size: 15, weight: .medium))
                                    .foregroundColor(.white)
                            }
                            .frame(maxWidth: .infinity)
                            .padding(.vertical, 14)
                            .background(
                                RoundedRectangle(cornerRadius: 10)
                                    .fill(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : Color.blue)
                            )
                        }
                        .padding(.horizontal, 20)
                        .padding(.top, 16)
                    }
                    
                    // Valor - Destaque
                    VStack(spacing: 8) {
                        Text("Valor")
                            .font(.system(size: 14, weight: .medium))
                            .foregroundColor(.secondary)
                            .frame(maxWidth: .infinity, alignment: .leading)
                        
                        TextField("R$ 0,00", text: $amount)
                            .font(.system(size: 32, weight: .bold))
                            .multilineTextAlignment(.center)
                            .keyboardType(.numberPad)
                            .padding(.vertical, 16)
                            .background(Color(UIColor.secondarySystemBackground))
                            .cornerRadius(16)
                            .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : .blue)
                            .onChange(of: amount) { newValue in
                                amount = formatCurrencyInput(newValue)
                            }
                    }
                    .padding(.horizontal, 20)
                    .padding(.top, 24)
                    
                    // Campos principais
                    VStack(spacing: 0) {
                        // DescriÃ§Ã£o
                        FormFieldRow(
                            icon: "text.alignleft",
                            title: "DescriÃ§Ã£o"
                        ) {
                            TextField("Adicionar descriÃ§Ã£o", text: $description)
                                .textFieldStyle(PlainTextFieldStyle())
                        }
                        
                        Divider()
                            .padding(.leading, 56)
                        
                        // Data
                        FormFieldRow(
                            icon: "calendar",
                            title: "Data"
                        ) {
                            DatePicker("", selection: $date, displayedComponents: .date)
                                .datePickerStyle(CompactDatePickerStyle())
                                .accentColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : .blue)
                        }
                        
                        Divider()
                            .padding(.leading, 56)
                        
                        // Status
                        FormFieldRow(
                            icon: "checkmark.circle",
                            title: "Aportado"
                        ) {
                            Toggle("", isOn: $isPaid)
                                .accentColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : .blue)
                        }
                        
                        Divider()
                            .padding(.leading, 56)
                        
                        // RecorrÃªncia
                        FormFieldRow(
                            icon: "repeat",
                            title: "Recorrente"
                        ) {
                            Toggle("", isOn: $isRecurring)
                                .accentColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : .blue)
                        }
                        
                        // Campos de recorrÃªncia (condicionais)
                        if isRecurring {
                            VStack(spacing: 0) {
                                Divider()
                                    .padding(.leading, 56)
                                
                                FormFieldRow(
                                    icon: "clock",
                                    title: "FrequÃªncia"
                                ) {
                                    Picker("FrequÃªncia", selection: $recurringFrequency) {
                                        ForEach(frequencies, id: \.self) { freq in
                                            Text(getFrequencyDisplayName(freq)).tag(freq)
                                        }
                                    }
                                    .pickerStyle(MenuPickerStyle())
                                    .accentColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : .blue)
                                }
                                
                                Divider()
                                    .padding(.leading, 56)
                                
                                FormFieldRow(
                                    icon: "calendar.badge.clock",
                                    title: "AtÃ©"
                                ) {
                                    DatePicker("", selection: $recurringEndDate, displayedComponents: .date)
                                        .datePickerStyle(CompactDatePickerStyle())
                                        .accentColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : .blue)
                                }
                            }
                        }
                    }
                    .background(Color(UIColor.secondarySystemBackground))
                    .cornerRadius(16)
                    .padding(.horizontal, 20)
                    .padding(.top, 24)
                    
                    // Mensagem de erro
                    if let errorMessage = errorMessage {
                        HStack(spacing: 8) {
                            Image(systemName: "exclamationmark.triangle.fill")
                                .foregroundColor(.red)
                                .font(.system(size: 14))
                            Text(errorMessage)
                                .foregroundColor(.red)
                                .font(.system(size: 14))
                        }
                        .padding(.horizontal, 20)
                        .padding(.top, 16)
                    }
                    
                    // Loading
                    if isLoading {
                        HStack(spacing: 12) {
                            ProgressView()
                                .scaleEffect(0.8)
                            Text("Salvando...")
                                .font(.system(size: 16, weight: .medium))
                                .foregroundColor(.secondary)
                        }
                        .padding(.top, 24)
                    }
                    
                    // EspaÃ§amento extra no final
                    Spacer(minLength: 40)
                }
            }
            .background(Color(UIColor.systemGroupedBackground))
            .navigationBarTitle("Novo Investimento", displayMode: .inline)
            .navigationBarItems(
                leading: Button("Cancelar") {
                    presentationMode.wrappedValue.dismiss()
                }
                .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : Color(hex: "#16A34A")),
                trailing: Button("Salvar") {
                    saveInvestment()
                }
                .disabled(amount.isEmpty || description.isEmpty || isLoading)
                .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : Color(hex: "#16A34A"))
            )
        }
        .onAppear {
            // Sincronizar data com o GlobalDateManager
            let calendar = Calendar.current
            let currentDate = Date()
            let selectedDate = globalDateManager.selectedDate
            
            // Verificar se o mÃªs/ano selecionado Ã© o mÃªs vigente
            let isCurrentMonth = calendar.isDate(selectedDate, equalTo: currentDate, toGranularity: .month)
            
            if isCurrentMonth {
                // Se for o mÃªs vigente, usar a data atual
                date = currentDate
            } else {
                // Se nÃ£o for o mÃªs vigente, usar o dia 1 do mÃªs/ano selecionado
                let components = calendar.dateComponents([.year, .month], from: selectedDate)
                if let firstDayOfMonth = calendar.date(from: DateComponents(year: components.year, month: components.month, day: 1)) {
                    date = firstDayOfMonth
                }
            }
        }
    }
    
    // MARK: - Functions
    private func saveInvestment() {
        guard let user = Auth.auth().currentUser else {
            errorMessage = "UsuÃ¡rio nÃ£o autenticado."
            return
        }
        
        // Converter valor formatado brasileiro para Double
        let cleanedAmount = amount.replacingOccurrences(of: ".", with: "").replacingOccurrences(of: ",", with: ".")
        guard let amountValue = Double(cleanedAmount) else {
            errorMessage = "Valor invÃ¡lido."
            return
        }
        
        let amountInReais = amountValue
        isLoading = true
        errorMessage = nil
        
        let dateFormatter = DateFormatter()
        dateFormatter.dateFormat = "yyyy-MM-dd"
        let now = Date()
        
        let status: String = isPaid ? "invested" : "pending"
        
        let db = // Firestore.firestore()
        
        // Criar transaÃ§Ã£o de investimento
        if isRecurring {
            // Criar mÃºltiplas transaÃ§Ãµes recorrentes
            createRecurringInvestmentTransactions(amountInReais: amountInReais, status: status, dateFormatter: dateFormatter, now: now, db: db)
        // } else {
            // Criar transaÃ§Ã£o Ãºnica
            let transaction: [String: Any] = [
                "userId": user.uid,
                "title": description.isEmpty ? "-" : description,
                "description": description.isEmpty ? "-" : description,
                "amount": amountInReais,
                "category": category.isEmpty ? "Investimento" : category,
                "date": dateFormatter.string(from: date),
                "type": "investment",
                "status": status,
                "createdAt": Timestamp(date: now),
                "updatedAt": Timestamp(date: now),
                "isRecurring": false,
                "recurringFrequency": "",
                "recurringEndDate": ""
            ]
            
            db// .collection("transactions").addDocument(data: transaction) { err in
                DispatchQueue.main.async {
                    isLoading = false
                    if let err = err {
                        errorMessage = "Erro ao salvar: \(err.localizedDescription)"
                    } else {
                        // Criar objeto Investment para callback
                        let investment = Investment(
                            id: nil,
                            name: description.isEmpty ? "Investimento" : description,
                            type: InvestmentType.other,
                            amount: amountInReais,
                            startDate: date,
                            notes: ""
                        )
                        
                        onSave(investment)
                        presentationMode.wrappedValue.dismiss()
                    }
                }
            }
        }
    }
    
    // private func createRecurringInvestmentTransactions(amountInReais: Double, status: String, dateFormatter: DateFormatter, now: Date, db: Any?) {
        guard let user = Auth.auth().currentUser else {
            errorMessage = "UsuÃ¡rio nÃ£o autenticado."
            isLoading = false
            return
        }
        
        let calendar = Calendar.current
        var currentDate = date
        let endDate = recurringEndDate
        var transactionCount = 0
        let maxTransactions = 50 // Limite para evitar muitas transaÃ§Ãµes
        
        print("ğŸ”„ Criando investimentos recorrentes:")
        print("   Data inicial: \(dateFormatter.string(from: currentDate))")
        print("   Data final: \(dateFormatter.string(from: endDate))")
        print("   FrequÃªncia: \(recurringFrequency)")
        
        let batch = db.batch()
        let parentRecurringId = "recurring_investment_\(now.timeIntervalSince1970)"
        
        // Criar as transaÃ§Ãµes recorrentes
        while currentDate <= endDate && transactionCount < maxTransactions {
            let transaction: [String: Any] = [
                "userId": user.uid,
                "title": description.isEmpty ? "-" : description,
                "description": description.isEmpty ? "-" : description,
                "amount": amountInReais,
                "category": category.isEmpty ? "Investimento" : category,
                "date": dateFormatter.string(from: currentDate),
                "type": "investment",
                "status": status,
                "createdAt": Timestamp(date: now),
                "updatedAt": Timestamp(date: now),
                "isRecurring": false,
                "recurringFrequency": "",
                "recurringEndDate": "",
                "parentRecurringId": parentRecurringId
            ]
            
            let docRef = db// .collection("transactions")// .document()
            batch.setData(transaction, forDocument: docRef)
            
            print("   âœ… Investimento criado para: \(dateFormatter.string(from: currentDate))")
            transactionCount += 1
            
            // Calcular prÃ³xima data baseada na frequÃªncia
            switch recurringFrequency {
            case "weekly":
                currentDate = calendar.date(byAdding: .weekOfYear, value: 1, to: currentDate) ?? currentDate
            case "monthly":
                currentDate = calendar.date(byAdding: .month, value: 1, to: currentDate) ?? currentDate
            case "yearly":
                currentDate = calendar.date(byAdding: .year, value: 1, to: currentDate) ?? currentDate
            default:
                currentDate = calendar.date(byAdding: .month, value: 1, to: currentDate) ?? currentDate
            }
        }
        
        batch.commit { err in
            DispatchQueue.main.async {
                isLoading = false
                if let err = err {
                    errorMessage = "Erro ao criar investimentos recorrentes: \(err.localizedDescription)"
                    print("âŒ Erro ao criar investimentos recorrentes: \(err.localizedDescription)")
                } else {
                    print("âœ… \(transactionCount) investimentos recorrentes criados com sucesso")
                    
                    // Criar objeto Investment para callback
                    let investment = Investment(
                        id: nil,
                        name: description.isEmpty ? "Investimento" : description,
                        type: InvestmentType.other,
                        amount: amountInReais,
                        startDate: date,
                        notes: ""
                    )
                    
                    onSave(investment)
                    presentationMode.wrappedValue.dismiss()
                }
            }
        }
    }
    
    // Mapeamento de frequÃªncias para portuguÃªs
    private func getFrequencyDisplayName(_ frequency: String) -> String {
        switch frequency {
        case "monthly": return "Mensal"
        case "weekly": return "Semanal"
        case "yearly": return "Anual"
        default: return frequency.capitalized
        }
    }
    
    private func formatCurrencyInput(_ input: String) -> String {
        // Remover todos os caracteres nÃ£o numÃ©ricos
        let cleanedInput = input.replacingOccurrences(of: "[^0-9]", with: "", options: .regularExpression)
        
        // Se estÃ¡ vazio, retornar "0,00"
        if cleanedInput.isEmpty {
            return "0,00"
        }
        
        // Converter para nÃºmero inteiro (representa centavos)
        let centavos = Int(cleanedInput) ?? 0
        
        // Converter centavos para reais e centavos
        let reais = centavos / 100
        let centavosRestantes = centavos % 100
        
        // Formatar parte inteira com pontos para milhares
        let formatter = NumberFormatter()
        formatter.numberStyle = .decimal
        formatter.groupingSeparator = "."
        formatter.groupingSize = 3
        
        let formattedReais = formatter.string(from: NSNumber(value: reais)) ?? "0"
        let formattedCentavos = String(format: "%02d", centavosRestantes)
        
        return "\(formattedReais),\(formattedCentavos)"
    }

// MARK: - Edit Investment View
struct EditInvestmentView: View {
    @Environment(\.presentationMode) private var presentationMode
    @AppStorage("isMonochromaticMode") private var isMonochromaticMode: Bool = false
    let investment: Investment
    let onUpdate: (Investment) -> Void
    
    @State private var name: String
    @State private var type: InvestmentType
    @State private var amount: String
    @State private var startDate: Date
    @State private var notes: String
    
    init(investment: Investment, onUpdate: @escaping (Investment) -> Void) {
        self.investment = investment
        self.onUpdate = onUpdate
        self._name = State(initialValue: investment.name)
        self._type = State(initialValue: investment.type)
        self._amount = State(initialValue: String(investment.amount))
        self._startDate = State(initialValue: investment.startDate)
        self._notes = State(initialValue: investment.notes)
    }
    
    var body: some View {
        NavigationView {
            ScrollView {
                VStack(spacing: 24) {
                    // Header
                    VStack(spacing: 16) {
                        ZStack {
                            Circle()
                                .fill(
                                    LinearGradient(
                                        gradient: Gradient(colors: isMonochromaticMode ? 
                                            [MonochromaticColorManager.primaryGreen, MonochromaticColorManager.secondaryGreen] :
                                            [Color.green, Color(hex: "#16A34A")]),
                                        startPoint: .topLeading,
                                        endPoint: .bottomTrailing
                                    )
                                )
                                .frame(width: 80, height: 80)
                            
                            Image(systemName: "target")
                                .font(.system(size: 32))
                                .foregroundColor(.white)
                        }
                        
                        VStack(spacing: 8) {
                            Text("Editar Investimento")
                                .font(.title2)
                                .fontWeight(.bold)
                                .foregroundColor(.primary)
                            
                            Text("Altere os dados do seu investimento")
                                .font(.body)
                                .foregroundColor(.secondary)
                                .multilineTextAlignment(.center)
                        }
                    }
                    .padding(.top, 20)
                    
                    // FormulÃ¡rio
                    VStack(spacing: 20) {
                        // InformaÃ§Ãµes bÃ¡sicas
                        VStack(alignment: .leading, spacing: 12) {
                            Text("InformaÃ§Ãµes do Investimento")
                                .font(.headline)
                                .foregroundColor(.primary)
                            
                            VStack(spacing: 12) {
                                FormFieldRow(
                                    icon: "text.alignleft",
                                    title: "Nome do investimento"
                                ) {
                                    TextField("Nome do seu investimento", text: $name)
                                        .textFieldStyle(PlainTextFieldStyle())
                                }
                                
                                Picker("Tipo", selection: $type) {
                                    ForEach(InvestmentType.allCases, id: \.self) { type in
                                        Text(type.rawValue).tag(type)
                                    }
                                }
                                .accentColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : .blue)
                            }
                        }
                        
                        // Valores
                        VStack(alignment: .leading, spacing: 12) {
                            Text("Valores")
                                .font(.headline)
                                .foregroundColor(.primary)
                            
                            VStack(spacing: 12) {
                                FormFieldRow(
                                    icon: "dollarsign.circle",
                                    title: "Valor investido (R$)"
                                ) {
                                    TextField("Valor investido", text: $amount)
                                        .textFieldStyle(PlainTextFieldStyle())
                                        .keyboardType(.decimalPad)
                                }
                            }
                        }
                        
                        // Data
                        VStack(alignment: .leading, spacing: 12) {
                            Text("Data")
                                .font(.headline)
                                .foregroundColor(.primary)
                            
                            VStack(alignment: .leading, spacing: 8) {
                                Text("Data de inÃ­cio")
                                    .font(.subheadline)
                                    .foregroundColor(.secondary)
                                
                                DatePicker("", selection: $startDate, displayedComponents: .date)
                                    .datePickerStyle(CompactDatePickerStyle())
                                    .accentColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : .blue)
                            }
                            .padding()
                            .background(Color(UIColor.secondarySystemBackground))
                            .cornerRadius(12)
                        }
                        
                        // ObservaÃ§Ãµes
                        VStack(alignment: .leading, spacing: 12) {
                            Text("ObservaÃ§Ãµes")
                                .font(.headline)
                                .foregroundColor(.primary)
                            
                            FormFieldRow(
                                icon: "note.text",
                                title: "Notas (opcional)"
                            ) {
                                TextField("Adicione notas ou observaÃ§Ãµes", text: $notes)
                                    .textFieldStyle(PlainTextFieldStyle())
                            }
                        }
                    }
                    .padding(.horizontal, 20)
                    
                    // BotÃ£o salvar
                    Button(action: updateInvestment) {
                        HStack {
                            Image(systemName: "checkmark.circle.fill")
                            Text("Salvar AlteraÃ§Ãµes")
                        }
                        .font(.headline)
                        .foregroundColor(.white)
                        .padding()
                        .frame(maxWidth: .infinity)
                        .background(
                            LinearGradient(
                                gradient: Gradient(colors: isMonochromaticMode ? 
                                    [MonochromaticColorManager.primaryGreen, MonochromaticColorManager.secondaryGreen] :
                                    [Color.green, Color(hex: "#16A34A")]),
                                startPoint: .leading,
                                endPoint: .trailing
                            )
                        )
                        .cornerRadius(12)
                    }
                    .disabled(name.isEmpty || amount.isEmpty)
                    .padding(.horizontal, 20)
                    .padding(.bottom, 20)
                }
            }
            .navigationTitle("Editar Investimento")
            .navigationBarTitleDisplayMode(.inline)
            .toolbar {
                ToolbarItem(placement: .navigationBarLeading) {
                    Button("Cancelar") {
                        presentationMode.wrappedValue.dismiss()
                    }
                    .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : .blue)
                }
            }
        }
    }
    
    private func updateInvestment() {
        // Converter valor formatado brasileiro para Double
        let cleanedAmount = amount.replacingOccurrences(of: ".", with: "").replacingOccurrences(of: ",", with: ".")
        guard let amountValue = Double(cleanedAmount) else { return }
        
        let updatedInvestment = Investment(
            id: investment.id,
            name: name,
            type: type,
            amount: amountValue,
            startDate: startDate,
            notes: notes
        )
        
        onUpdate(updatedInvestment)
        presentationMode.wrappedValue.dismiss()
    }
    
    private func formatCurrencyInput(_ input: String) -> String {
        // Remover todos os caracteres nÃ£o numÃ©ricos exceto vÃ­rgula e ponto
        let cleanedInput = input.replacingOccurrences(of: "[^0-9,.]", with: "", options: .regularExpression)
        
        // Se nÃ£o hÃ¡ vÃ­rgula, tratar como nÃºmero inteiro
        if !cleanedInput.contains(",") {
            // Remover pontos e converter para nÃºmero
            let numberString = cleanedInput.replacingOccurrences(of: ".", with: "")
            
            // Se estÃ¡ vazio, retornar vazio
            if numberString.isEmpty {
                return ""
            }
            
            // Formatar com vÃ­rgulas para milhares
            if let number = Int(numberString) {
                let formatter = NumberFormatter()
                formatter.numberStyle = .decimal
                formatter.groupingSeparator = "."
                formatter.groupingSize = 3
                return formatter.string(from: NSNumber(value: number)) ?? numberString
            }
            
            return numberString
        // } else {
            // Se hÃ¡ vÃ­rgula, separar parte inteira e decimal
            let parts = cleanedInput.components(separatedBy: ",")
            
            if parts.count == 2 {
                let integerPart = parts[0].replacingOccurrences(of: ".", with: "")
                let decimalPart = parts[1]
                
                // Formatar parte inteira com vÃ­rgulas
                if let number = Int(integerPart) {
                    let formatter = NumberFormatter()
                    formatter.numberStyle = .decimal
                    formatter.groupingSeparator = "."
                    formatter.groupingSize = 3
                    let formattedInteger = formatter.string(from: NSNumber(value: number)) ?? integerPart
                    
                    // Limitar parte decimal a 2 dÃ­gitos
                    let limitedDecimal = String(decimalPart.prefix(2))
                    
                    return "\(formattedInteger),\(limitedDecimal)"
                }
            }
            
            return cleanedInput
        }
    }

// MARK: - Investment Model
struct Investment: Identifiable, Codable {
    var id: String?
    let name: String
    let type: InvestmentType
    let amount: Double
    let startDate: Date
    let notes: String
    
    init(id: String? = nil, name: String, type: InvestmentType, amount: Double, startDate: Date, notes: String) {
        self.id = id
        self.name = name
        self.type = type
        self.amount = amount
        self.startDate = startDate
        self.notes = notes
    }

// MARK: - Investment Type
enum InvestmentType: String, CaseIterable, Codable {
    case stocks = "AÃ§Ãµes"
    case bonds = "TÃ­tulos"
    case realEstate = "ImÃ³veis"
    case crypto = "Criptomoedas"
    case mutualFunds = "Fundos"
    case other = "Outros"

// MARK: - Notifications View
struct NotificationsView: View {
    @EnvironmentObject var authViewModel: AuthViewModel
    @Environment(\.presentationMode) private var presentationMode
    @AppStorage("notificationsEnabled") private var notificationsEnabled: Bool = true
    @AppStorage("transactionReminders") private var transactionReminders: Bool = true
    @AppStorage("goalReminders") private var goalReminders: Bool = true
    @AppStorage("investmentUpdates") private var investmentUpdates: Bool = true
    @AppStorage("weeklyReports") private var weeklyReports: Bool = false
    @AppStorage("monthlyReports") private var monthlyReports: Bool = true
    @AppStorage("reminderTime") private var reminderTime: String = "20:00"
    @AppStorage("isMonochromaticMode") private var isMonochromaticMode: Bool = false
    @State private var showNotificationMessage = false
    @State private var notificationMessage = ""
    
    var body: some View {
        ScrollView {
            VStack(spacing: 20) {
                // SeÃ§Ã£o de NotificaÃ§Ãµes Gerais
                VStack(alignment: .leading, spacing: 8) {
                    Text("NotificaÃ§Ãµes Gerais")
                        .font(.headline)
                        .foregroundColor(.secondary)
                    
                    // Toggle principal de notificaÃ§Ãµes
                    HStack {
                        VStack(alignment: .leading, spacing: 4) {
                            Text("Ativar NotificaÃ§Ãµes")
                                .font(.system(size: 16, weight: .medium))
                                .foregroundColor(.primary)
                            
                            Text("Permitir que o app envie notificaÃ§Ãµes")
                                .font(.caption)
                                .foregroundColor(.secondary)
                        }
                        
                        Spacer()
                        
                        Toggle("", isOn: Binding(
                            get: { notificationsEnabled },
                            set: { newValue in
                                if newValue {
                                    // Tentando ativar notificaÃ§Ãµes
                                    UNUserNotificationCenter.current().requestAuthorization(options: [.alert, .badge, .sound]) { granted, error in
                                        DispatchQueue.main.async {
                                            if granted {
                                                self.notificationsEnabled = true
                                                self.notificationMessage = "NotificaÃ§Ãµes ativadas com sucesso!"
                                            } else {
                                                self.notificationsEnabled = false
                                                self.notificationMessage = "PermissÃ£o de notificaÃ§Ãµes negada"
                                            }
                                            self.showNotificationMessage = true
                                            
                                            // Esconder a notificaÃ§Ã£o apÃ³s 3 segundos
                                            DispatchQueue.main.asyncAfter(deadline: .now() + 3) {
                                                withAnimation(.spring(response: 0.6, dampingFraction: 0.8)) {
                                                    self.showNotificationMessage = false
                                                }
                                            }
                                        }
                                    }
                                } else {
                                    // Desativando notificaÃ§Ãµes
                                    self.notificationsEnabled = false
                                    UNUserNotificationCenter.current().removeAllPendingNotificationRequests()
                                    self.notificationMessage = "NotificaÃ§Ãµes desativadas"
                                    self.showNotificationMessage = true
                                    
                                    // Esconder a notificaÃ§Ã£o apÃ³s 3 segundos
                                    DispatchQueue.main.asyncAfter(deadline: .now() + 3) {
                                        withAnimation(.spring(response: 0.6, dampingFraction: 0.8)) {
                                            self.showNotificationMessage = false
                                        }
                                    }
                                }
                            }
                        ))
                    }
                    .padding()
                    .background(Color(UIColor.secondarySystemBackground))
                    .cornerRadius(12)
                }
                .padding(.horizontal, 16)
                
                if notificationsEnabled {
                    // SeÃ§Ã£o de Tipos de NotificaÃ§Ã£o
                    VStack(alignment: .leading, spacing: 8) {
                        Text("Tipos de NotificaÃ§Ã£o")
                            .font(.headline)
                            .foregroundColor(.secondary)
                        
                        // Lembretes de TransaÃ§Ãµes
                        NotificationToggleCard(
                            title: "Lembretes de TransaÃ§Ãµes",
                            subtitle: "Receba lembretes para registrar suas despesas e receitas",
                            icon: "creditcard.fill",
                            isOn: $transactionReminders,
                            color: .blue
                        )
                        
                        // Lembretes de Metas
                        NotificationToggleCard(
                            title: "Lembretes de Metas",
                            subtitle: "Acompanhe o progresso das suas metas financeiras",
                            icon: "target",
                            isOn: $goalReminders,
                            color: .orange
                        )
                        
                        // AtualizaÃ§Ãµes de Investimentos
                        NotificationToggleCard(
                            title: "AtualizaÃ§Ãµes de Investimentos",
                            subtitle: "Receba informaÃ§Ãµes sobre seus investimentos",
                            icon: "chart.line.uptrend.xyaxis",
                            isOn: $investmentUpdates,
                            color: .green
                        )
                    }
                    .padding(.horizontal, 16)
                    
                    // SeÃ§Ã£o de RelatÃ³rios
                    VStack(alignment: .leading, spacing: 8) {
                        Text("RelatÃ³rios")
                            .font(.headline)
                            .foregroundColor(.secondary)
                        
                        // RelatÃ³rios Semanais
                        NotificationToggleCard(
                            title: "RelatÃ³rios Semanais",
                            subtitle: "Receba um resumo semanal das suas finanÃ§as",
                            icon: "calendar",
                            isOn: $weeklyReports,
                            color: .purple
                        )
                        
                        // RelatÃ³rios Mensais
                        NotificationToggleCard(
                            title: "RelatÃ³rios Mensais",
                            subtitle: "Receba um resumo mensal detalhado",
                            icon: "doc.text.fill",
                            isOn: $monthlyReports,
                            color: .indigo
                        )
                    }
                    .padding(.horizontal, 16)
                    
                    // SeÃ§Ã£o de HorÃ¡rio
                    VStack(alignment: .leading, spacing: 8) {
                        Text("HorÃ¡rio de Lembretes")
                            .font(.headline)
                            .foregroundColor(.secondary)
                        
                        HStack {
                            VStack(alignment: .leading, spacing: 4) {
                                Text("HorÃ¡rio PadrÃ£o")
                                    .font(.system(size: 16, weight: .medium))
                                    .foregroundColor(.primary)
                                
                                Text("HorÃ¡rio para envio de lembretes diÃ¡rios")
                                    .font(.caption)
                                    .foregroundColor(.secondary)
                            }
                            
                            Spacer()
                            
                            Text(reminderTime)
                                .font(.system(size: 16, weight: .medium))
                                .foregroundColor(.primary)
                                .padding(.horizontal, 12)
                                .padding(.vertical, 8)
                                .background(Color(UIColor.tertiarySystemBackground))
                                .cornerRadius(8)
                        }
                        .padding()
                        .background(Color(UIColor.secondarySystemBackground))
                        .cornerRadius(12)
                    }
                    .padding(.horizontal, 16)
                }
                
                // SeÃ§Ã£o de InformaÃ§Ãµes
                VStack(alignment: .leading, spacing: 8) {
                    Text("InformaÃ§Ãµes")
                        .font(.headline)
                        .foregroundColor(.secondary)
                    
                    VStack(alignment: .leading, spacing: 12) {
                        HStack {
                            Image(systemName: "info.circle.fill")
                                .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : .blue)
                                .font(.system(size: 16))
                            
                            Text("As notificaÃ§Ãµes ajudam vocÃª a manter o controle das suas finanÃ§as")
                                .font(.caption)
                                .foregroundColor(.secondary)
                        }
                        
                        HStack {
                            Image(systemName: "clock.fill")
                                .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : .orange)
                                .font(.system(size: 16))
                            
                            Text("Os lembretes sÃ£o enviados no horÃ¡rio configurado")
                                .font(.caption)
                                .foregroundColor(.secondary)
                        }
                        
                        HStack {
                            Image(systemName: "bell.slash.fill")
                                .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGray : .red)
                                .font(.system(size: 16))
                            
                            Text("VocÃª pode desativar notificaÃ§Ãµes especÃ­ficas a qualquer momento")
                                .font(.caption)
                                .foregroundColor(.secondary)
                        }
                    }
                    .padding()
                    .background(Color(UIColor.secondarySystemBackground))
                    .cornerRadius(12)
                }
                .padding(.horizontal, 16)
                
                // EspaÃ§amento extra
                Spacer(minLength: 100)
            }
            .padding(.vertical, 16)
        }
        .background(Color(UIColor.systemBackground))
        .navigationTitle("NotificaÃ§Ãµes")
        .navigationBarTitleDisplayMode(.inline)
    }

// MARK: - Notification Toggle Card
struct NotificationToggleCard: View {
    let title: String
    let subtitle: String
    let icon: String
    @Binding var isOn: Bool
    let color: Color
    @AppStorage("isMonochromaticMode") private var isMonochromaticMode: Bool = false
    
    var body: some View {
        HStack(spacing: 12) {
            Image(systemName: icon)
                .font(.system(size: 20))
                .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : color)
                .frame(width: 24)
            
            VStack(alignment: .leading, spacing: 2) {
                Text(title)
                    .font(.system(size: 16, weight: .medium))
                    .foregroundColor(.primary)
                
                Text(subtitle)
                    .font(.caption)
                    .foregroundColor(.secondary)
            }
            
            Spacer()
            
            Toggle("", isOn: $isOn)
        }
        .padding()
        .background(Color(UIColor.secondarySystemBackground))
        .cornerRadius(12)
    }

// MARK: - Categories View
struct CategoriesView: View {
    @EnvironmentObject var authViewModel: AuthViewModel
    @Environment(\.presentationMode) private var presentationMode
    @State private var categories: [Category] = []
    @State private var showingAddCategory = false
    @State private var showingEditCategory = false
    @State private var categoryToEdit: Category?
    @State private var isLoading = true
    @State private var showDeleteAlert = false
    @State private var categoryToDelete: Category?
    @AppStorage("isMonochromaticMode") private var isMonochromaticMode: Bool = false
    private let db: Any? = nil // Firestore.firestore() temporariamente desabilitado
    
    var body: some View {
        VStack {
            if isLoading {
                VStack(spacing: 20) {
                    ProgressView()
                        .scaleEffect(1.5)
                    Text("Carregando categorias...")
                        .foregroundColor(.secondary)
                }
                .frame(maxWidth: .infinity, maxHeight: .infinity)
            } else {
                ScrollView {
                    LazyVStack(spacing: 16) {
                        // Categorias PadrÃ£o
                        if !defaultCategories.isEmpty {
                            VStack(alignment: .leading, spacing: 12) {
                                Text("Categorias PadrÃ£o")
                                    .font(.headline)
                                    .foregroundColor(.secondary)
                                    .padding(.horizontal, 16)
                                
                                ForEach(defaultCategories) { category in
                                    CategoryCard(
                                        category: category,
                                        isDefault: true,
                                        onEdit: nil,
                                        onDelete: nil
                                    )
                                    .padding(.horizontal, 16)
                                }
                            }
                        }
                        
                        // Categorias Personalizadas
                        if !userCategories.isEmpty {
                            VStack(alignment: .leading, spacing: 12) {
                                HStack {
                                    Text("Suas Categorias")
                                        .font(.headline)
                                        .foregroundColor(.secondary)
                                    
                                    Spacer()
                                    
                                    Text("\(userCategories.count)")
                                        .font(.caption)
                                        .foregroundColor(.secondary)
                                        .padding(.horizontal, 8)
                                        .padding(.vertical, 4)
                                        .background(Color(UIColor.tertiarySystemBackground))
                                        .cornerRadius(8)
                                }
                                .padding(.horizontal, 16)
                                
                                ForEach(userCategories) { category in
                                    CategoryCard(
                                        category: category,
                                        isDefault: false,
                                        onEdit: {
                                            categoryToEdit = category
                                            showingEditCategory = true
                                        },
                                        onDelete: {
                                            categoryToDelete = category
                                            showDeleteAlert = true
                                        }
                                    )
                                    .padding(.horizontal, 16)
                                }
                            }
                        }
                        
                        // Estado vazio
                        if categories.isEmpty {
                            VStack(spacing: 20) {
                                Image(systemName: "folder")
                                    .font(.system(size: 60))
                                    .foregroundColor(.secondary)
                                
                                Text("Nenhuma Categoria Encontrada")
                                    .font(.title2)
                                    .fontWeight(.medium)
                                    .foregroundColor(.primary)
                                
                                Text("Adicione suas categorias personalizadas para organizar melhor suas transaÃ§Ãµes")
                                    .font(.body)
                                    .foregroundColor(.secondary)
                                    .multilineTextAlignment(.center)
                                    .padding(.horizontal, 40)
                                
                                Button(action: {
                                    showingAddCategory = true
                                }) {
                                    HStack {
                                        Image(systemName: "plus.circle.fill")
                                        Text("Adicionar Categoria")
                                    }
                                    .font(.headline)
                                    .foregroundColor(.white)
                                    .padding()
                                    .background(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : .blue)
                                    .cornerRadius(12)
                                }
                            }
                            .padding(.top, 40)
                        }
                    }
                    .padding(.vertical, 16)
                    .padding(.bottom, 120)
                }
            }
        }
        .navigationTitle("Categorias")
        .navigationBarTitleDisplayMode(.inline)
        .toolbar {
            ToolbarItem(placement: .navigationBarTrailing) {
                Button(action: {
                    showingAddCategory = true
                }) {
                    Image(systemName: "plus")
                }
            }
        }
        .sheet(isPresented: $showingAddCategory) {
            AddCategoryView { newCategory in
                addCategory(newCategory)
            }
        }
        .sheet(isPresented: $showingEditCategory) {
            if let category = categoryToEdit {
                EditCategoryView(category: category) { updatedCategory in
                    updateCategory(updatedCategory)
                }
            }
        }
        .alert("Excluir Categoria", isPresented: $showDeleteAlert) {
            Button("Cancelar", role: .cancel) { }
            Button("Excluir", role: .destructive) {
                if let category = categoryToDelete {
                    deleteCategory(category)
                }
            }
        } message: {
            Text("Tem certeza que deseja excluir esta categoria? Esta aÃ§Ã£o nÃ£o pode ser desfeita.")
        }
        .onAppear {
            loadCategories()
        }
    }
    
    // MARK: - Computed Properties
    private var defaultCategories: [Category] {
        return categories.filter { $0.isDefault }
    }
    
    private var userCategories: [Category] {
        return categories.filter { !$0.isDefault }
    }
    
    // MARK: - Functions
    private func loadCategories() {
        guard let userId = authViewModel.user?.id else { 
            print("âŒ loadCategories: userId Ã© nil")
            self.isLoading = false
            return 
        }
        print("ğŸ” loadCategories: userId = \(userId)")
        let defaultCategories = getDefaultCategories()
        // Listener em tempo real para categorias do usuÃ¡rio
        db// .collection("users")// .document(userId)// .collection("categories")
            .addSnapshotListener { snapshot, error in
                    if let error = error {
                    print("âš ï¸ loadCategories: NÃ£o foi possÃ­vel carregar categorias personalizadas: \(error.localizedDescription)")
                    print("â„¹ï¸ loadCategories: Usando apenas categorias padrÃ£o")
                        self.categories = defaultCategories
                        self.isLoading = false
                        return
                    }
                let userCategories: [Category] = snapshot?.documents.compactMap { document in
                    do {
                        let category = try document.data(as: Category.self)
                        print("ğŸ” loadCategories: carregou categoria \(category.name) do tipo \(category.type)")
                        return category
                    } catch {
                        print("âŒ Erro ao decodificar categoria: \(error)")
                        return nil
                    }
                    } ?? []
                    self.categories = defaultCategories + userCategories
                    self.isLoading = false
            }
    }
    
    private func getDefaultCategories() -> [Category] {
        return [
            Category(id: "food", name: "AlimentaÃ§Ã£o", icon: "fork.knife", color: "green", type: "expense", isSystem: true, isDefault: true),
            Category(id: "transport", name: "Transporte", icon: "car.fill", color: "blue", type: "expense", isSystem: true, isDefault: true),
            Category(id: "shopping", name: "Compras", icon: "bag.fill", color: "purple", type: "expense", isSystem: true, isDefault: true),
            Category(id: "entertainment", name: "Entretenimento", icon: "gamecontroller.fill", color: "orange", type: "expense", isSystem: true, isDefault: true),
            Category(id: "health", name: "SaÃºde", icon: "cross.fill", color: "red", type: "expense", isSystem: true, isDefault: true),
            Category(id: "education", name: "EducaÃ§Ã£o", icon: "book.fill", color: "indigo", type: "expense", isSystem: true, isDefault: true),
            Category(id: "home", name: "Casa", icon: "house.fill", color: "brown", type: "expense", isSystem: true, isDefault: true),
            Category(id: "salary", name: "SalÃ¡rio", icon: "dollarsign.circle.fill", color: "green", type: "income", isSystem: true, isDefault: true),
            Category(id: "investment", name: "Investimentos", icon: "chart.line.uptrend.xyaxis", color: "blue", type: "investment", isSystem: true, isDefault: true),
            Category(id: "services", name: "ServiÃ§os", icon: "wrench.and.screwdriver", color: "orange", type: "expense", isSystem: true, isDefault: true),
            Category(id: "loans", name: "EmprÃ©stimos", icon: "creditcard.fill", color: "red", type: "expense", isSystem: true, isDefault: true)
        ]
    }
    
    private func addCategory(_ category: Category) {
        guard let userId = authViewModel.user?.id else { 
            print("âŒ addCategory: userId Ã© nil")
            return 
        }
        print("ğŸ” addCategory: salvando categoria '\(category.name)' do tipo '\(category.type)' para userId \(userId)")
        var categoryToSave = category
        if categoryToSave.id == nil {
            categoryToSave.id = UUID().uuidString
        }
        do {
            try db// .collection("users")// .document(userId)// .collection("categories")// .document(categoryToSave.id!).setData(from: categoryToSave, merge: true)
            print("âœ… addCategory: categoria salva com sucesso")
        } catch {
            print("âŒ Erro ao adicionar categoria: \(error)")
        }
        // loadCategories() nÃ£o Ã© mais necessÃ¡rio pois o snapshotListener jÃ¡ atualiza
    }
    
    private func deleteCategory(_ category: Category) {
        guard let userId = authViewModel.user?.id, let categoryId = category.id else { return }
        db// .collection("users")// .document(userId)// .collection("categories")// .document(categoryId).delete { error in
            if let error = error {
                print("âŒ Erro ao excluir categoria: \(error)")
            } else {
                print("âœ… Categoria excluÃ­da com sucesso")
            }
            // loadCategories() nÃ£o Ã© mais necessÃ¡rio pois o snapshotListener jÃ¡ atualiza
        }
    }
    
    private func updateCategory(_ category: Category) {
        guard let userId = authViewModel.user?.id, let categoryId = category.id else { 
            print("âŒ updateCategory: userId ou categoryId Ã© nil")
            return 
        }
        print("ğŸ” updateCategory: atualizando categoria '\(category.name)' do tipo '\(category.type)' para userId \(userId)")
        do {
            try db// .collection("users")// .document(userId)// .collection("categories")// .document(categoryId).setData(from: category, merge: true)
            print("âœ… updateCategory: categoria atualizada com sucesso")
        } catch {
            print("âŒ Erro ao atualizar categoria: \(error)")
        }
        // loadCategories() nÃ£o Ã© mais necessÃ¡rio pois o snapshotListener jÃ¡ atualiza
    }

// MARK: - Category Card
struct CategoryCard: View {
    let category: Category
    let isDefault: Bool
    let onEdit: (() -> Void)?
    let onDelete: (() -> Void)?
    
    @AppStorage("isMonochromaticMode") private var isMonochromaticMode: Bool = false
    
    var body: some View {
        HStack(spacing: 16) {
            // Ãcone da categoria
            Image(systemName: category.icon)
                .font(.system(size: 24))
                .foregroundColor(getCategoryColor())
                .frame(width: 48, height: 48)
                .background(getCategoryColor().opacity(0.1))
                .cornerRadius(12)
            
            // InformaÃ§Ãµes da categoria
            VStack(alignment: .leading, spacing: 4) {
                HStack {
                    Text(category.name)
                        .font(.system(size: 16, weight: .medium))
                        .foregroundColor(.primary)
                    
                    if isDefault {
                        Text("PadrÃ£o")
                            .font(.system(size: 10, weight: .medium))
                            .foregroundColor(.secondary)
                            .padding(.horizontal, 6)
                            .padding(.vertical, 2)
                            .background(Color(UIColor.tertiarySystemBackground))
                            .cornerRadius(4)
                    }
                }
                
                Text(isDefault ? "Categoria do sistema" : "Categoria personalizada")
                    .font(.system(size: 12))
                    .foregroundColor(.secondary)
            }
            
            Spacer()
            
            // BotÃµes de aÃ§Ã£o (apenas para categorias personalizadas)
            if !isDefault {
                HStack(spacing: 8) {
                    if let onEdit = onEdit {
                        Button(action: onEdit) {
                            Image(systemName: "pencil")
                                .font(.system(size: 14))
                                .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : .blue)
                        }
                    }
                    
                    if let onDelete = onDelete {
                        Button(action: onDelete) {
                            Image(systemName: "trash")
                                .font(.system(size: 14))
                                .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGray : .red)
                        }
                    }
                }
            }
        }
        .padding()
        .background(Color(UIColor.secondarySystemBackground))
        .cornerRadius(12)
    }
    
    private func getCategoryColor() -> Color {
        if isMonochromaticMode {
            return MonochromaticColorManager.primaryGreen
        }
        
        switch category.color {
        case "green": return .green
        case "blue": return .blue
        case "purple": return .purple
        case "orange": return .orange
        case "red": return .red
        case "indigo": return .indigo
        case "brown": return .brown
        case "pink": return .pink
        default: return .gray
        }
    }

// MARK: - Add Category View
struct AddCategoryView: View {
    @Environment(\.presentationMode) private var presentationMode
    let onSave: (Category) -> Void
    
    @State private var name = ""
    @State private var selectedIcon = "folder"
    @State private var selectedColor = "green"
    @State private var selectedType = "expense"
    @AppStorage("isMonochromaticMode") private var isMonochromaticMode: Bool = false
    @State private var showIconModal = false
    
    private let icons = [
        "folder", "star", "heart", "bookmark", "flag", "tag", "gift", "crown",
        "diamond", "bolt", "fire", "leaf", "drop", "sun", "moon", "cloud",
        "car", "house", "building", "shop", "cart", "bag", "creditcard",
        "gamecontroller", "tv", "music.note", "camera", "phone", "laptop",
        "wrench.and.screwdriver", "creditcard.fill"
    ]
    
    private let colors = [
        "green", "blue", "purple", "orange", "red", "indigo", "brown", "pink"
    ]
    
    private let types = [
        ("expense", "Despesa"),
        ("income", "Receita")
    ]
    
    var body: some View {
        NavigationView {
            VStack(spacing: 24) {
                // Nome da categoria
                VStack(alignment: .leading, spacing: 8) {
                    Text("Nome da Categoria")
                        .font(.headline)
                        .foregroundColor(.primary)
                    TextField("Ex: Viagem, Lazer, Trabalho", text: $name)
                        .textFieldStyle(RoundedBorderTextFieldStyle())
                }
                // SeleÃ§Ã£o de Ã­cone (botÃ£o que abre modal)
                VStack(alignment: .leading, spacing: 12) {
                    Text("Ãcone")
                        .font(.headline)
                        .foregroundColor(.primary)
                    Button(action: { showIconModal = true }) {
                        Image(systemName: selectedIcon)
                            .font(.system(size: 32))
                            .foregroundColor(getColor())
                            .frame(width: 56, height: 56)
                            .background(getColor().opacity(0.1))
                            .cornerRadius(16)
                            .overlay(
                                RoundedRectangle(cornerRadius: 16)
                                    .stroke(getColor(), lineWidth: 2)
                            )
                    }
                    .sheet(isPresented: $showIconModal) {
                        NavigationView {
                            ScrollView {
                                LazyVGrid(columns: Array(repeating: GridItem(.flexible()), count: 6), spacing: 16) {
                        ForEach(icons, id: \.self) { icon in
                            Button(action: {
                                selectedIcon = icon
                                            showIconModal = false
                            }) {
                                Image(systemName: icon)
                                                .font(.system(size: 28))
                                    .foregroundColor(selectedIcon == icon ? .white : getColor())
                                    .frame(width: 48, height: 48)
                                    .background(selectedIcon == icon ? getColor() : getColor().opacity(0.1))
                                    .cornerRadius(12)
                            }
                        }
                    }
                                .padding()
                            }
                            .navigationTitle("Escolha um Ãcone")
                            .navigationBarTitleDisplayMode(.inline)
                            .toolbar {
                                ToolbarItem(placement: .cancellationAction) {
                                    Button("Fechar") { showIconModal = false }
                                }
                            }
                        }
                    }
                }
                // SeleÃ§Ã£o de cor
                VStack(alignment: .leading, spacing: 12) {
                    Text("Cor")
                        .font(.headline)
                        .foregroundColor(.primary)
                    HStack(spacing: 12) {
                        ForEach(colors, id: \.self) { color in
                            Button(action: {
                                selectedColor = color
                            }) {
                                Circle()
                                    .fill(getColorFromString(color))
                                    .frame(width: 32, height: 32)
                                    .overlay(
                                        Circle()
                                            .stroke(selectedColor == color ? Color.primary : Color.clear, lineWidth: 2)
                                    )
                            }
                        }
                    }
                }
                // SeleÃ§Ã£o de tipo (apenas despesa e receita)
                VStack(alignment: .leading, spacing: 12) {
                    Text("Tipo")
                        .font(.headline)
                        .foregroundColor(.primary)
                    HStack(spacing: 12) {
                        ForEach(types, id: \.0) { type in
                            Button(action: {
                                selectedType = type.0
                            }) {
                                Text(type.1)
                                    .font(.system(size: 16, weight: .medium))
                                    .foregroundColor(selectedType == type.0 ? .white : getColor())
                                    .padding(.horizontal, 16)
                                    .padding(.vertical, 8)
                                    .background(selectedType == type.0 ? getColor() : getColor().opacity(0.1))
                                    .cornerRadius(12)
                            }
                        }
                    }
                }
                Spacer()
            }
            .padding()
            .navigationTitle("Nova Categoria")
            .navigationBarTitleDisplayMode(.inline)
            .navigationBarItems(
                leading: Button("Cancelar") {
                    presentationMode.wrappedValue.dismiss()
                },
                trailing: Button("Salvar") {
                    saveCategory()
                }
                .disabled(name.trimmingCharacters(in: .whitespacesAndNewlines).isEmpty)
            )
        }
    }
    
    private func getColor() -> Color {
        if isMonochromaticMode {
            return MonochromaticColorManager.primaryGreen
        }
        return getColorFromString(selectedColor)
    }
    
    private func getColorFromString(_ colorString: String) -> Color {
        switch colorString {
        case "green": return .green
        case "blue": return .blue
        case "purple": return .purple
        case "orange": return .orange
        case "red": return .red
        case "indigo": return .indigo
        case "brown": return .brown
        case "pink": return .pink
        default: return .gray
        }
    }
    
    private func saveCategory() {
        let category = Category(
            id: UUID().uuidString,
            name: name.trimmingCharacters(in: .whitespacesAndNewlines),
            icon: selectedIcon,
            color: selectedColor,
            type: selectedType,
            isSystem: false,
            userId: nil,
            isDefault: false
        )
        
        onSave(category)
        presentationMode.wrappedValue.dismiss()
    }

// MARK: - Category Model
struct Category: Identifiable, Codable {
    var id: String?
    let name: String
    let icon: String
    let color: String
    let type: String // "income", "expense", "investment", "goal"
    let isSystem: Bool // true para categorias de sistema, false para usuÃ¡rio
    let userId: String? // null para sistema, userId para usuÃ¡rio
    let isDefault: Bool // manter para compatibilidade visual
    
    init(id: String? = nil, name: String, icon: String, color: String, type: String, isSystem: Bool = false, userId: String? = nil, isDefault: Bool = false) {
        self.id = id
        self.name = name
        self.icon = icon
        self.color = color
        self.type = type
        self.isSystem = isSystem
        self.userId = userId
        self.isDefault = isDefault
    }

// MARK: - Edit Category View
struct EditCategoryView: View {
    @Environment(\.presentationMode) private var presentationMode
    let category: Category
    let onUpdate: (Category) -> Void
    
    @State private var name: String
    @State private var selectedIcon: String
    @State private var selectedColor: String
    @State private var selectedType: String
    @AppStorage("isMonochromaticMode") private var isMonochromaticMode: Bool = false
    @State private var showIconModal = false
    
    private let icons = [
        "folder", "star", "heart", "bookmark", "flag", "tag", "gift", "crown",
        "diamond", "bolt", "fire", "leaf", "drop", "sun", "moon", "cloud",
        "car", "house", "building", "shop", "cart", "bag", "creditcard",
        "gamecontroller", "tv", "music.note", "camera", "phone", "laptop",
        "wrench.and.screwdriver", "creditcard.fill"
    ]
    
    private let colors = [
        "green", "blue", "purple", "orange", "red", "indigo", "brown", "pink"
    ]
    
    private let types = [
        ("expense", "Despesa"),
        ("income", "Receita")
    ]
    
    init(category: Category, onUpdate: @escaping (Category) -> Void) {
        self.category = category
        self.onUpdate = onUpdate
        self._name = State(initialValue: category.name)
        self._selectedIcon = State(initialValue: category.icon)
        self._selectedColor = State(initialValue: category.color)
        self._selectedType = State(initialValue: category.type)
    }
    
    var body: some View {
        NavigationView {
            VStack(spacing: 24) {
                // Nome da categoria
                VStack(alignment: .leading, spacing: 8) {
                    Text("Nome da Categoria")
                        .font(.headline)
                        .foregroundColor(.primary)
                    TextField("Ex: Viagem, Lazer, Trabalho", text: $name)
                        .textFieldStyle(RoundedBorderTextFieldStyle())
                }
                
                // SeleÃ§Ã£o de Ã­cone (botÃ£o que abre modal)
                VStack(alignment: .leading, spacing: 12) {
                    Text("Ãcone")
                        .font(.headline)
                        .foregroundColor(.primary)
                    Button(action: { showIconModal = true }) {
                        Image(systemName: selectedIcon)
                            .font(.system(size: 32))
                            .foregroundColor(getColor())
                            .frame(width: 56, height: 56)
                            .background(getColor().opacity(0.1))
                            .cornerRadius(16)
                            .overlay(
                                RoundedRectangle(cornerRadius: 16)
                                    .stroke(getColor(), lineWidth: 2)
                            )
                    }
                    .sheet(isPresented: $showIconModal) {
                        NavigationView {
                            ScrollView {
                                LazyVGrid(columns: Array(repeating: GridItem(.flexible()), count: 6), spacing: 16) {
                                    ForEach(icons, id: \.self) { icon in
                                        Button(action: {
                                            selectedIcon = icon
                                            showIconModal = false
                                        }) {
                                            Image(systemName: icon)
                                                .font(.system(size: 28))
                                                .foregroundColor(selectedIcon == icon ? .white : getColor())
                                                .frame(width: 48, height: 48)
                                                .background(selectedIcon == icon ? getColor() : getColor().opacity(0.1))
                                                .cornerRadius(12)
                                        }
                                    }
                                }
                                .padding()
                            }
                            .navigationTitle("Escolha um Ãcone")
                            .navigationBarTitleDisplayMode(.inline)
                            .toolbar {
                                ToolbarItem(placement: .cancellationAction) {
                                    Button("Fechar") { showIconModal = false }
                                }
                            }
                        }
                    }
                }
                
                // SeleÃ§Ã£o de cor
                VStack(alignment: .leading, spacing: 12) {
                    Text("Cor")
                        .font(.headline)
                        .foregroundColor(.primary)
                    HStack(spacing: 12) {
                        ForEach(colors, id: \.self) { color in
                            Button(action: {
                                selectedColor = color
                            }) {
                                Circle()
                                    .fill(getColorFromString(color))
                                    .frame(width: 32, height: 32)
                                    .overlay(
                                        Circle()
                                            .stroke(selectedColor == color ? Color.primary : Color.clear, lineWidth: 2)
                                    )
                            }
                        }
                    }
                }
                
                // SeleÃ§Ã£o de tipo (apenas despesa e receita)
                VStack(alignment: .leading, spacing: 12) {
                    Text("Tipo")
                        .font(.headline)
                        .foregroundColor(.primary)
                    HStack(spacing: 12) {
                        ForEach(types, id: \.0) { type in
                            Button(action: {
                                selectedType = type.0
                            }) {
                                Text(type.1)
                                    .font(.system(size: 16, weight: .medium))
                                    .foregroundColor(selectedType == type.0 ? .white : getColor())
                                    .padding(.horizontal, 16)
                                    .padding(.vertical, 8)
                                    .background(selectedType == type.0 ? getColor() : getColor().opacity(0.1))
                                    .cornerRadius(12)
                            }
                        }
                    }
                }
                
                Spacer()
            }
            .padding()
            .navigationTitle("Editar Categoria")
            .navigationBarTitleDisplayMode(.inline)
            .navigationBarItems(
                leading: Button("Cancelar") {
                    presentationMode.wrappedValue.dismiss()
                },
                trailing: Button("Salvar") {
                    updateCategory()
                }
                .disabled(name.trimmingCharacters(in: .whitespacesAndNewlines).isEmpty)
            )
        }
    }
    
    private func getColor() -> Color {
        if isMonochromaticMode {
            return MonochromaticColorManager.primaryGreen
        }
        return getColorFromString(selectedColor)
    }
    
    private func getColorFromString(_ colorString: String) -> Color {
        switch colorString {
        case "green": return .green
        case "blue": return .blue
        case "purple": return .purple
        case "orange": return .orange
        case "red": return .red
        case "indigo": return .indigo
        case "brown": return .brown
        case "pink": return .pink
        default: return .gray
        }
    }
    
    private func updateCategory() {
        let updatedCategory = Category(
            id: category.id,
            name: name.trimmingCharacters(in: .whitespacesAndNewlines),
            icon: selectedIcon,
            color: selectedColor,
            type: selectedType,
            isSystem: category.isSystem,
            userId: category.userId,
            isDefault: category.isDefault
        )
        
        onUpdate(updatedCategory)
        presentationMode.wrappedValue.dismiss()
    }

// MARK: - Premium Notification View
struct PremiumNotificationView: View {
    let message: String
    @Binding var isVisible: Bool
    @AppStorage("isMonochromaticMode") private var isMonochromaticMode: Bool = false
    @Environment(\.colorScheme) var colorScheme
    
    @State private var dragOffset: CGFloat = 0
    @State private var isDragging = false
    @State private var showNotification = false
    
    // Cores adaptativas para todos os modos
    private var backgroundColor: Color {
        if isMonochromaticMode {
            return colorScheme == .dark ? Color.black.opacity(0.9) : Color.white
        // } else {
            return colorScheme == .dark ? Color(UIColor.systemGray6) : Color(UIColor.systemBackground)
        }
    }
    
    private var iconColor: Color {
        if isMonochromaticMode {
            return MonochromaticColorManager.primaryGreen
        // } else {
            return colorScheme == .dark ? .yellow : .orange
        }
    }
    
    private var actionButtonColor: Color {
        if isMonochromaticMode {
            return MonochromaticColorManager.primaryGreen
        // } else {
            return colorScheme == .dark ? .blue : .blue
        }
    }
    
    private var textColor: Color {
        if isMonochromaticMode {
            return colorScheme == .dark ? .white : .black
        // } else {
            return colorScheme == .dark ? .white : .primary
        }
    }
    
    private var secondaryTextColor: Color {
        if isMonochromaticMode {
            return colorScheme == .dark ? .white.opacity(0.7) : .black.opacity(0.7)
        // } else {
            return colorScheme == .dark ? .white.opacity(0.7) : .secondary
        }
    }
    
    var body: some View {
        VStack {
            HStack(spacing: 12) {
                // Ãcone Premium
                Image(systemName: "crown.fill")
                    .font(.system(size: 20))
                    .foregroundColor(iconColor)
                    .scaleEffect(showNotification ? 1.0 : 0.5)
                    .animation(.spring(response: 0.6, dampingFraction: 0.7).delay(0.2), value: showNotification)
                
                // Mensagem
                VStack(alignment: .leading, spacing: 2) {
                    Text("PINEE Premium")
                        .font(.system(size: 14, weight: .semibold))
                        .foregroundColor(textColor)
                    
                    Text(message)
                        .font(.system(size: 12))
                        .foregroundColor(secondaryTextColor)
                        .lineLimit(2)
                }
                .opacity(showNotification ? 1.0 : 0.0)
                .animation(.easeOut(duration: 0.4).delay(0.3), value: showNotification)
                
                Spacer()
                
                // BotÃ£o de aÃ§Ã£o
                Button("Ver") {
                    // AÃ§Ã£o para abrir tela premium
                    isVisible = false
                }
                .font(.system(size: 12, weight: .medium))
                .foregroundColor(actionButtonColor)
                .opacity(showNotification ? 1.0 : 0.0)
                .animation(.easeOut(duration: 0.3).delay(0.4), value: showNotification)
            }
            .padding(.horizontal, 16)
            .padding(.vertical, 12)
            .background(backgroundColor)
            .cornerRadius(12)
            .shadow(color: Color.black.opacity(colorScheme == .dark ? 0.3 : 0.1), radius: 8, x: 0, y: 4)
            .overlay(
                RoundedRectangle(cornerRadius: 12)
                    .stroke(
                        isMonochromaticMode ? MonochromaticColorManager.primaryGreen.opacity(0.3) : Color.clear,
                        lineWidth: 1
                    )
            )
            .offset(x: dragOffset)
            .scaleEffect(isDragging ? 0.98 : 1.0)
            .gesture(
                DragGesture()
                    .onChanged { value in
                        isDragging = true
                        dragOffset = value.translation.width
                    }
                    .onEnded { value in
                        isDragging = false
                        
                        // Se arrastou para a esquerda ou direita mais de 100 pontos, remove a notificaÃ§Ã£o
                        if abs(value.translation.width) > 100 {
                            withAnimation(.spring(response: 0.6, dampingFraction: 0.8)) {
                                dragOffset = value.translation.width > 0 ? 500 : -500
                            }
                            DispatchQueue.main.asyncAfter(deadline: .now() + 0.3) {
                                dismissNotification()
                            }
                        } else {
                            // Retorna Ã  posiÃ§Ã£o original
                            withAnimation(.spring(response: 0.6, dampingFraction: 0.8)) {
                                dragOffset = 0
                            }
                        }
                    }
            )
            .padding(.horizontal, 16)
            .padding(.top, 8)
            
            Spacer()
        }
        .opacity(isVisible ? 1 : 0)
        .offset(y: isVisible ? 0 : -100)
        .animation(.easeInOut(duration: 0.3), value: isVisible)
        .zIndex(1000)
        .onAppear {
            withAnimation(.spring(response: 0.8, dampingFraction: 0.8)) {
                showNotification = true
            }
        }
    }
    
    private func dismissNotification() {
        withAnimation(.spring(response: 0.6, dampingFraction: 0.8)) {
            showNotification = false
        }
        
        DispatchQueue.main.asyncAfter(deadline: .now() + 0.2) {
            isVisible = false
        }
    }

// MARK: - Premium View
struct PremiumView: View {
    @Environment(\.presentationMode) private var presentationMode
    @AppStorage("isMonochromaticMode") private var isMonochromaticMode: Bool = false
    @Environment(\.colorScheme) var systemColorScheme
    @EnvironmentObject var authViewModel: AuthViewModel
    @State private var selectedPlan: PremiumPlan = .monthly
    @StateObject private var iapManager = IAPManager.shared
    @State private var showSuccessMessage = false
    @State private var showErrorMessage = false
    var showNavigationTitle: Bool = true
    
    // Cores adaptativas para todos os modos
    private var backgroundColor: Color {
        if isMonochromaticMode {
            return systemColorScheme == .dark ? Color.black : Color.white
        // } else {
            return systemColorScheme == .dark ? Color(UIColor.systemBackground) : Color(hex: "#F0FDF4")
        }
    }
    
    private var cardBackgroundColor: Color {
        if isMonochromaticMode {
            return systemColorScheme == .dark ? Color.black.opacity(0.8) : Color.white
        // } else {
            return systemColorScheme == .dark ? Color(UIColor.secondarySystemBackground) : Color(UIColor.secondarySystemBackground)
        }
    }
    
    private var primaryColor: Color {
        if isMonochromaticMode {
            return MonochromaticColorManager.primaryGreen
        // } else {
            return systemColorScheme == .dark ? .blue : Color(hex: "#F59E0B")
        }
    }
    
    private var secondaryColor: Color {
        if isMonochromaticMode {
            return MonochromaticColorManager.secondaryGreen
        // } else {
            return systemColorScheme == .dark ? .blue : Color(hex: "#F97316")
        }
    }
    
    private var textColor: Color {
        if isMonochromaticMode {
            return systemColorScheme == .dark ? .white : .black
        // } else {
            return systemColorScheme == .dark ? .white : .primary
        }
    }
    
    private var secondaryTextColor: Color {
        if isMonochromaticMode {
            return systemColorScheme == .dark ? .white.opacity(0.7) : .black.opacity(0.7)
        // } else {
            return systemColorScheme == .dark ? .white.opacity(0.7) : .secondary
        }
    }
    
    enum PremiumPlan: String, CaseIterable {
        case monthly = "monthly"
        case yearly = "yearly"
        
        var title: String {
            switch self {
            case .monthly: return "Mensal"
            case .yearly: return "Anual"
            }
        }
        
        var price: String {
            switch self {
            case .monthly: return "R$ 9,90"
            case .yearly: return "R$ 99,90"
            }
        }
        
        var savings: String? {
            switch self {
            case .monthly: return nil
            case .yearly: return "Economize 16%"
            }
        }
        
        var period: String {
            switch self {
            case .monthly: return "mÃªs"
            case .yearly: return "ano"
            }
        }
    }
    
    var body: some View {
        ScrollView {
            VStack(spacing: 32) {
                // Header
                headerView
                
                // Planos
                plansView
                
                // BenefÃ­cios
                benefitsView
                
                // BotÃ£o de upgrade
                upgradeButton
                
                // Termos e condiÃ§Ãµes
                termsView
            }
            .padding(.horizontal, 20)
            .padding(.vertical, 24)
        }
        .background(
            LinearGradient(
                gradient: Gradient(colors: [backgroundColor, cardBackgroundColor]),
                startPoint: .top,
                endPoint: .bottom
            )
        )
        .conditionalNavigationTitle(showNavigationTitle ? "Seja Premium" : nil)
        .navigationBarTitleDisplayMode(.inline)
    }
    
    // MARK: - Header View
    private var headerView: some View {
        VStack(spacing: 16) {
            // Ãcone Premium
            ZStack {
                Circle()
                    .fill(
                        LinearGradient(
                            gradient: Gradient(colors: [primaryColor, secondaryColor]),
                            startPoint: .topLeading,
                            endPoint: .bottomTrailing
                        )
                    )
                    .frame(width: 80, height: 80)
                    .shadow(color: Color.black.opacity(systemColorScheme == .dark ? 0.3 : 0.1), radius: 8, x: 0, y: 4)
                
                Image(systemName: "crown.fill")
                    .font(.system(size: 36))
                    .foregroundColor(.white)
            }
            
            VStack(spacing: 8) {
                Text("Desbloqueie o PINEE Premium")
                    .font(.system(size: 28, weight: .bold))
                    .foregroundColor(textColor)
                    .multilineTextAlignment(.center)
                
                Text("Acesse recursos exclusivos e maximize seu controle financeiro")
                    .font(.system(size: 16))
                    .foregroundColor(secondaryTextColor)
                    .multilineTextAlignment(.center)
                    .padding(.horizontal, 20)
            }
        }
    }
    
    // MARK: - Plans View
    private var plansView: some View {
        VStack(spacing: 16) {
            Text("Escolha seu plano")
                .font(.system(size: 20, weight: .semibold))
                .foregroundColor(textColor)
            
            VStack(spacing: 12) {
                ForEach(PremiumPlan.allCases, id: \.self) { plan in
                    planCard(plan: plan)
                }
            }
        }
    }
    
    private func planCard(plan: PremiumPlan) -> some View {
        Button(action: {
            selectedPlan = plan
        }) {
            HStack(spacing: 16) {
                // Radio button
                ZStack {
                    Circle()
                        .stroke(selectedPlan == plan ? primaryColor : Color.gray.opacity(0.3), lineWidth: 2)
                        .frame(width: 24, height: 24)
                    
                    if selectedPlan == plan {
                        Circle()
                            .fill(selectedPlan == plan ? primaryColor : Color.clear)
                            .frame(width: 12, height: 12)
                    }
                }
                
                VStack(alignment: .leading, spacing: 4) {
                    HStack {
                        Text(plan.title)
                            .font(.system(size: 18, weight: .semibold))
                            .foregroundColor(textColor)
                        
                        if let savings = plan.savings {
                            Text(savings)
                                .font(.system(size: 12, weight: .medium))
                                .foregroundColor(.white)
                                .padding(.horizontal, 8)
                                .padding(.vertical, 2)
                                .background(Color.green)
                                .cornerRadius(8)
                        }
                    }
                    
                    Text("\(plan.price) por \(plan.period)")
                        .font(.system(size: 14))
                        .foregroundColor(secondaryTextColor)
                }
                
                Spacer()
            }
            .padding()
            .background(
                RoundedRectangle(cornerRadius: 16)
                    .fill(selectedPlan == plan ? primaryColor.opacity(0.1) : cardBackgroundColor)
                    .overlay(
                        RoundedRectangle(cornerRadius: 16)
                            .stroke(selectedPlan == plan ? primaryColor : Color.clear, lineWidth: 2)
                    )
            )
        }
        .buttonStyle(PlainButtonStyle())
    }
    
    // MARK: - Benefits View
    private var benefitsView: some View {
        VStack(spacing: 20) {
            Text("BenefÃ­cios Premium")
                .font(.system(size: 20, weight: .semibold))
                .foregroundColor(textColor)
            
            VStack(spacing: 16) {
                benefitRow(
                    icon: "chart.bar.fill",
                    title: "RelatÃ³rios AvanÃ§ados",
                    description: "AnÃ¡lises detalhadas e grÃ¡ficos interativos"
                )
                
                benefitRow(
                    icon: "square.and.arrow.up",
                    title: "ExportaÃ§Ã£o de Dados",
                    description: "Exporte seus dados em PDF e Excel"
                )
                
                benefitRow(
                    icon: "icloud.fill",
                    title: "Backup na Nuvem",
                    description: "SincronizaÃ§Ã£o automÃ¡tica e backup seguro"
                )
                
                benefitRow(
                    icon: "headphones",
                    title: "Suporte PrioritÃ¡rio",
                    description: "Atendimento exclusivo e resposta rÃ¡pida"
                )
                
                benefitRow(
                    icon: "paintbrush.fill",
                    title: "Temas Personalizados",
                    description: "Personalize cores e aparÃªncia do app"
                )
                
                benefitRow(
                    icon: "infinity",
                    title: "TransaÃ§Ãµes Ilimitadas",
                    description: "Sem limite de transaÃ§Ãµes por mÃªs"
                )
            }
        }
    }
    
    private func benefitRow(icon: String, title: String, description: String) -> some View {
        HStack(spacing: 16) {
            Image(systemName: icon)
                .font(.system(size: 20))
                .foregroundColor(primaryColor)
                .frame(width: 24)
            
            VStack(alignment: .leading, spacing: 4) {
                Text(title)
                    .font(.system(size: 16, weight: .medium))
                    .foregroundColor(textColor)
                
                Text(description)
                    .font(.system(size: 14))
                    .foregroundColor(secondaryTextColor)
            }
            
            Spacer()
        }
        .padding()
        .background(cardBackgroundColor)
        .cornerRadius(12)
    }
    
    // MARK: - Upgrade Button
    private var upgradeButton: some View {
        VStack(spacing: 16) {
            Button(action: {
                Task {
                    await iapManager.purchasePremium()
                    if iapManager.isPremium {
                        authViewModel.setPremiumStatus(isPremium: true)
                        showSuccessMessage = true
                        DispatchQueue.main.asyncAfter(deadline: .now() + 2) {
                            showSuccessMessage = false
                            presentationMode.wrappedValue.dismiss()
                        }
                    } else if iapManager.errorMessage != nil {
                        showErrorMessage = true
                    }
                }
            }) {
                HStack {
                    if iapManager.isLoading {
                        ProgressView()
                            .scaleEffect(0.8)
                            .foregroundColor(.white)
                    } else {
                        Image(systemName: "crown.fill")
                            .font(.system(size: 16))
                    }
                    Text(iapManager.isLoading ? "Processando..." : "Fazer Upgrade para Premium")
                        .font(.system(size: 16, weight: .semibold))
                }
                .foregroundColor(.white)
                .frame(maxWidth: .infinity)
                .padding()
                .background(
                    LinearGradient(
                        gradient: Gradient(colors: [primaryColor, secondaryColor]),
                        startPoint: .leading,
                        endPoint: .trailing
                    )
                )
                .cornerRadius(16)
                .shadow(color: Color.black.opacity(systemColorScheme == .dark ? 0.3 : 0.1), radius: 8, x: 0, y: 4)
            }
            .disabled(iapManager.isLoading)
            
            Button(action: {
                Task {
                    await iapManager.restorePurchases()
                    if iapManager.isPremium {
                        authViewModel.setPremiumStatus(isPremium: true)
                        showSuccessMessage = true
                        DispatchQueue.main.asyncAfter(deadline: .now() + 2) {
                            showSuccessMessage = false
                            presentationMode.wrappedValue.dismiss()
                        }
                    } else if iapManager.errorMessage != nil {
                        showErrorMessage = true
                    }
                }
            }) {
                Text("Restaurar Compras")
                    .font(.system(size: 14, weight: .medium))
                    .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : .blue)
                    .frame(maxWidth: .infinity)
                    .padding(.vertical, 8)
            }
            .disabled(iapManager.isLoading)
            

            
            Text("Cancelamento a qualquer momento")
                .font(.system(size: 12))
                .foregroundColor(.secondary)
        }
        .alert(isPresented: $showErrorMessage) {
            Alert(title: Text("Erro"), message: Text(iapManager.errorMessage ?? "Erro desconhecido"), dismissButton: .default(Text("OK")))
        }
        .overlay(
            Group {
                if showSuccessMessage {
                    VStack {
                        HStack(spacing: 12) {
                            Image(systemName: "checkmark.circle.fill")
                                .foregroundColor(.green)
                                .font(.system(size: 20))
                            Text("Upgrade realizado com sucesso!")
                                .font(.system(size: 16, weight: .medium))
                                .foregroundColor(.primary)
                            Spacer()
                        }
                        .padding(.horizontal, 16)
                        .padding(.vertical, 14)
                        .background(
                            RoundedRectangle(cornerRadius: 16)
                                .fill(Color(UIColor.secondarySystemBackground))
                                .shadow(color: Color.black.opacity(0.1), radius: 12, x: 0, y: 6)
                        )
                        .padding(.horizontal, 16)
                        .padding(.top, 60)
                        Spacer()
                    }
                    .transition(.asymmetric(
                        insertion: .move(edge: .top).combined(with: .opacity),
                        removal: .move(edge: .top).combined(with: .opacity)
                    ))
                    .animation(.spring(response: 0.8, dampingFraction: 0.8), value: showSuccessMessage)
                    .zIndex(1000)
                }
            }
        )
    }
    
    // MARK: - Terms View
    private var termsView: some View {
        VStack(spacing: 8) {
            Text("Ao fazer upgrade, vocÃª concorda com nossos")
                .font(.system(size: 12))
                .foregroundColor(.secondary)
            
            HStack(spacing: 4) {
                Button("Termos de Uso") {
                    // Abrir termos de uso
                }
                .font(.system(size: 12, weight: .medium))
                .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : .blue)
                
                Text("e")
                    .font(.system(size: 12))
                    .foregroundColor(.secondary)
                
                Button("PolÃ­tica de Privacidade") {
                    // Abrir polÃ­tica de privacidade
                }
                .font(.system(size: 12, weight: .medium))
                .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : .blue)
            }
        }
    }

// MARK: - Predefined Goals View
struct PredefinedGoalsView: View {
    @Environment(\.presentationMode) private var presentationMode
    @EnvironmentObject var authViewModel: AuthViewModel
    let onSave: (Goal) -> Void
    
    @State private var selectedGoalType: PredefinedGoalType?
    @State private var showingGoalDetails = false
    @AppStorage("isMonochromaticMode") private var isMonochromaticMode: Bool = false
    
    var body: some View {
        NavigationView {
            ScrollView {
                VStack(spacing: 20) {
                    // Header
                    VStack(spacing: 8) {
                        Text("Escolha uma Meta")
                            .font(.title2)
                            .fontWeight(.bold)
                            .foregroundColor(.primary)
                        
                        Text("Selecione uma meta prÃ©-definida e personalize conforme suas necessidades")
                            .font(.body)
                            .foregroundColor(.secondary)
                            .multilineTextAlignment(.center)
                            .padding(.horizontal, 20)
                    }
                    .padding(.top, 20)
                    
                    // Grid de metas prÃ©-definidas
                    LazyVGrid(columns: [
                        GridItem(.flexible()),
                        GridItem(.flexible())
                    ], spacing: 20) {
                        ForEach(PredefinedGoalType.allCases, id: \.self) { goalType in
                            PredefinedGoalCard(
                                goalType: goalType,
                                isSelected: selectedGoalType == goalType
                            ) {
                                selectedGoalType = goalType
                                showingGoalDetails = true
                            }
                        }
                    }
                    .padding(.horizontal, 20)
                }
            }
            .navigationTitle("Metas PrÃ©-definidas")
            .navigationBarTitleDisplayMode(.inline)
            .toolbar {
                ToolbarItem(placement: .navigationBarLeading) {
                    Button("Cancelar") {
                        presentationMode.wrappedValue.dismiss()
                    }
                }
            }
        }
        .sheet(isPresented: $showingGoalDetails) {
            if let selectedType = selectedGoalType {
                PredefinedGoalDetailsView(
                    goalType: selectedType,
                    onSave: { goal in
                        onSave(goal)
                        presentationMode.wrappedValue.dismiss()
                    }
                )
            }
        }
    }

// MARK: - Predefined Goal Card
struct PredefinedGoalCard: View {
    let goalType: PredefinedGoalType
    let isSelected: Bool
    let onTap: () -> Void
    @AppStorage("isMonochromaticMode") private var isMonochromaticMode: Bool = false
    
    var body: some View {
        Button(action: onTap) {
            VStack(spacing: 8) {
                // Ãcone
                ZStack {
                    Circle()
                        .fill(
                            LinearGradient(
                                gradient: Gradient(colors: getGradientColors()),
                                startPoint: .topLeading,
                                endPoint: .bottomTrailing
                            )
                        )
                        .frame(width: 60, height: 60)
                    
                    Image(systemName: goalType.icon)
                        .font(.system(size: 24))
                        .foregroundColor(.white)
                }
                .padding(.top, 8)
                
                // TÃ­tulo
                Text(goalType.title)
                    .font(.system(size: 12, weight: .semibold))
                    .foregroundColor(.primary)
                    .multilineTextAlignment(.center)
                    .lineLimit(2)
                    .padding(.horizontal, 4)
                
                // Valor sugerido
                Text(formatCurrency(goalType.suggestedAmount))
                    .font(.system(size: 10, weight: .medium))
                    .foregroundColor(.secondary)
                
                // Prazo sugerido
                Text("\(goalType.suggestedMonths) meses")
                    .font(.system(size: 9))
                    .foregroundColor(.secondary)
            }
            .frame(height: 120)
            .frame(maxWidth: .infinity)
            .background(Color(UIColor.secondarySystemBackground))
            .cornerRadius(12)
            .overlay(
                RoundedRectangle(cornerRadius: 12)
                    .stroke(isSelected ? (isMonochromaticMode ? MonochromaticColorManager.primaryGreen : .blue) : Color.clear, lineWidth: 2)
            )
        }
        .buttonStyle(PlainButtonStyle())
    }
    
    private func getGradientColors() -> [Color] {
        if isMonochromaticMode {
            return [MonochromaticColorManager.primaryGreen, MonochromaticColorManager.secondaryGreen]
        }
        
        switch goalType.color {
        case "green": return [Color.green, Color(hex: "#16A34A")]
        case "red": return [Color.red, Color(hex: "#DC2626")]
        case "blue": return [Color.blue, Color(hex: "#3B82F6")]
        case "purple": return [Color.purple, Color(hex: "#7C3AED")]
        case "orange": return [Color.orange, Color(hex: "#F97316")]
        default: return [Color.gray, Color(hex: "#6B7280")]
        }
    }

// MARK: - Predefined Goal Details View
struct PredefinedGoalDetailsView: View {
    @Environment(\.presentationMode) private var presentationMode
    @EnvironmentObject var authViewModel: AuthViewModel
    let goalType: PredefinedGoalType
    let onSave: (Goal) -> Void
    
    @State private var title: String = ""
    @State private var description: String = ""
    @State private var targetAmount: String = "0,00"
    @State private var currentAmount: String = "0,00"
    @State private var deadline: Date = Date()
    @State private var errorMessage: String?
    @State private var isLoading: Bool = false
    @AppStorage("isMonochromaticMode") private var isMonochromaticMode: Bool = false
    
    init(goalType: PredefinedGoalType, onSave: @escaping (Goal) -> Void) {
        self.goalType = goalType
        self.onSave = onSave
        
        // PrÃ©-preencher com valores sugeridos
        self._title = State(initialValue: goalType.title)
        self._description = State(initialValue: goalType.description)
        
        // Formatar o valor sugerido para o padrÃ£o brasileiro
        let formatter = NumberFormatter()
        formatter.numberStyle = .decimal
        formatter.groupingSeparator = "."
        formatter.groupingSize = 3
        formatter.minimumFractionDigits = 2
        formatter.maximumFractionDigits = 2
        let formattedAmount = formatter.string(from: NSNumber(value: goalType.suggestedAmount)) ?? "0,00"
        self._targetAmount = State(initialValue: formattedAmount)
        
        // Calcular data limite baseada nos meses sugeridos
        let calendar = Calendar.current
        let deadlineDate = calendar.date(byAdding: .month, value: goalType.suggestedMonths, to: Date()) ?? Date()
        self._deadline = State(initialValue: deadlineDate)
    }
    
    var body: some View {
        NavigationView {
            ScrollView {
                VStack(spacing: 24) {
                    // Header com Ã­cone
                    VStack(spacing: 16) {
                        ZStack {
                            Circle()
                                .fill(
                                    LinearGradient(
                                        gradient: Gradient(colors: getGradientColors()),
                                        startPoint: .topLeading,
                                        endPoint: .bottomTrailing
                                    )
                                )
                                .frame(width: 80, height: 80)
                            
                            Image(systemName: goalType.icon)
                                .font(.system(size: 32))
                                .foregroundColor(.white)
                        }
                        
                        VStack(spacing: 8) {
                            Text("Personalizar Meta")
                                .font(.title2)
                                .fontWeight(.bold)
                                .foregroundColor(.primary)
                            
                            Text("Ajuste os valores e prazos conforme suas necessidades")
                                .font(.body)
                                .foregroundColor(.secondary)
                                .multilineTextAlignment(.center)
                        }
                    }
                    .padding(.top, 20)
                    
                    // FormulÃ¡rio
                    VStack(spacing: 20) {
                        // InformaÃ§Ãµes bÃ¡sicas
                        VStack(alignment: .leading, spacing: 12) {
                            Text("InformaÃ§Ãµes da Meta")
                                .font(.headline)
                                .foregroundColor(.primary)
                            
                            VStack(spacing: 12) {
                                FormFieldRow(
                                    icon: "text.alignleft",
                                    title: "TÃ­tulo"
                                ) {
                                    TextField("Nome da sua meta", text: $title)
                                        .textFieldStyle(PlainTextFieldStyle())
                                }
                                
                                FormFieldRow(
                                    icon: "text.alignleft",
                                    title: "DescriÃ§Ã£o"
                                ) {
                                    TextField("Descreva sua meta", text: $description)
                                        .textFieldStyle(PlainTextFieldStyle())
                                }
                            }
                        }
                        
                        // Valores
                        VStack(alignment: .leading, spacing: 12) {
                            Text("Valores")
                                .font(.headline)
                                .foregroundColor(.primary)
                            
                            VStack(spacing: 12) {
                                FormFieldRow(
                                    icon: "target",
                                    title: "Meta (R$)"
                                ) {
                                    TextField("Valor objetivo", text: $targetAmount)
                                        .textFieldStyle(PlainTextFieldStyle())
                                        .keyboardType(.decimalPad)
                                }
                                
                                FormFieldRow(
                                    icon: "dollarsign.circle",
                                    title: "Valor Atual (R$)"
                                ) {
                                    TextField("Valor jÃ¡ guardado", text: $currentAmount)
                                        .textFieldStyle(PlainTextFieldStyle())
                                        .keyboardType(.decimalPad)
                                }
                            }
                        }
                        
                        // Prazo
                        VStack(alignment: .leading, spacing: 12) {
                            Text("Prazo")
                                .font(.headline)
                                .foregroundColor(.primary)
                            
                            VStack(alignment: .leading, spacing: 8) {
                                Text("Data Limite")
                                    .font(.subheadline)
                                    .foregroundColor(.secondary)
                                
                                DatePicker("", selection: $deadline, displayedComponents: .date)
                                    .datePickerStyle(CompactDatePickerStyle())
                                    .accentColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : .blue)
                            }
                            .padding()
                            .background(Color(UIColor.secondarySystemBackground))
                            .cornerRadius(12)
                        }
                    }
                    .padding(.horizontal, 20)
                    
                    // BotÃ£o salvar
                    Button(action: {
                        print("ğŸ”§ BotÃ£o Criar Meta pressionado")
                        let impactFeedback = UIImpactFeedbackGenerator(style: .medium)
                        impactFeedback.impactOccurred()
                        saveGoal()
                    }) {
                        HStack {
                            Image(systemName: "checkmark.circle.fill")
                            Text("Criar Meta")
                        }
                        .font(.headline)
                        .foregroundColor(.white)
                        .padding()
                        .frame(maxWidth: .infinity)
                        .background(
                            LinearGradient(
                                gradient: Gradient(colors: getGradientColors()),
                                startPoint: .leading,
                                endPoint: .trailing
                            )
                        )
                        .cornerRadius(12)
                        .opacity(title.trimmingCharacters(in: .whitespacesAndNewlines).isEmpty || targetAmount.trimmingCharacters(in: .whitespacesAndNewlines).isEmpty ? 0.5 : 1.0)
                    }
                    .disabled(title.trimmingCharacters(in: .whitespacesAndNewlines).isEmpty || targetAmount.trimmingCharacters(in: .whitespacesAndNewlines).isEmpty)
                    .padding(.horizontal, 20)
                    .padding(.bottom, 20)
                }
            }
            .navigationTitle("Personalizar Meta")
            .navigationBarTitleDisplayMode(.inline)
            .toolbar {
                ToolbarItem(placement: .navigationBarLeading) {
                    Button("Cancelar") {
                        presentationMode.wrappedValue.dismiss()
                    }
                }
            }
        }
    }
    
    private func saveGoal() {
        print("ğŸ”§ saveGoal chamada")
        print("   - title: \(title)")
        print("   - description: \(description)")
        print("   - targetAmount: \(targetAmount)")
        print("   - currentAmount: \(currentAmount)")
        print("   - deadline: \(deadline)")
        
        guard let userId = authViewModel.user?.id else {
            print("âŒ userId nÃ£o encontrado")
            return
        }
        
        // Limpar e converter valores
        let cleanedTargetAmount = targetAmount.replacingOccurrences(of: ".", with: "").replacingOccurrences(of: ",", with: ".")
        let cleanedCurrentAmount = currentAmount.replacingOccurrences(of: ".", with: "").replacingOccurrences(of: ",", with: ".")
        
        print("   - cleanedTargetAmount: \(cleanedTargetAmount)")
        print("   - cleanedCurrentAmount: \(cleanedCurrentAmount)")
        
        guard let target = Double(cleanedTargetAmount) else {
            print("âŒ Erro ao converter targetAmount: \(targetAmount)")
            return
        }
        
        guard let current = Double(cleanedCurrentAmount) else {
            print("âŒ Erro ao converter currentAmount: \(currentAmount)")
            return
        }
        
        print("   - target convertido: \(target)")
        print("   - current convertido: \(current)")
        
        let goal = Goal(
            userId: userId,
            title: title.isEmpty ? goalType.title : title,
            description: description.isEmpty ? goalType.description : description,
            targetAmount: target,
            currentAmount: current,
            deadline: deadline,
            category: "Geral",
            isPredefined: true,
            predefinedType: goalType.rawValue
        )
        
        print("âœ… Goal criada: \(goal.title) - R$ \(goal.targetAmount)")
        onSave(goal)
        presentationMode.wrappedValue.dismiss()
    }
    
    private func getGradientColors() -> [Color] {
        if isMonochromaticMode {
            return [MonochromaticColorManager.primaryGreen, MonochromaticColorManager.secondaryGreen]
        }
        
        switch goalType.color {
        case "green": return [Color.green, Color(hex: "#16A34A")]
        case "red": return [Color.red, Color(hex: "#DC2626")]
        case "blue": return [Color.blue, Color(hex: "#3B82F6")]
        case "purple": return [Color.purple, Color(hex: "#7C3AED")]
        case "orange": return [Color.orange, Color(hex: "#F97316")]
        default: return [Color.gray, Color(hex: "#6B7280")]
        }
    }

// MARK: - View Extensions
extension View {
    func conditionalNavigationTitle(_ title: String?) -> some View {
        if let title = title {
            return AnyView(self.navigationTitle(title))
        // } else {
            return AnyView(self)
        }
    }

func updatePremiumStatusInFirestore(isPremium: Bool) async {
    // A atualizaÃ§Ã£o do status premium serÃ¡ feita na tela apÃ³s a compra/restauraÃ§Ã£o.

// Adicionar funÃ§Ãµes auxiliares no escopo da View:
private func formatCurrency(_ value: Double) -> String {
    let formatter = NumberFormatter()
    formatter.numberStyle = .currency
    formatter.currencySymbol = "R$ "
    formatter.locale = Locale(identifier: "pt_BR")
    return formatter.string(from: NSNumber(value: value)) ?? "R$ 0,00"

private func formatCurrencyUSD(_ value: Double) -> String {
    let formatter = NumberFormatter()
    formatter.numberStyle = .currency
    formatter.currencySymbol = "$ "
    formatter.locale = Locale(identifier: "en_US")
    return formatter.string(from: NSNumber(value: value)) ?? "$ 0.00"

extension ShapeStyle {
    func asAnyShapeStyle() -> AnyShapeStyle {
        AnyShapeStyle(self)
    }

// MARK: - About App View
struct AboutAppView: View {
    @Environment(\.presentationMode) private var presentationMode
    @AppStorage("isMonochromaticMode") private var isMonochromaticMode: Bool = false
    @State private var animateLogo = false
    @State private var showFeatures = false
    
    var body: some View {
        NavigationView {
            ScrollView {
                VStack(spacing: 30) {
                    // Header com Logo e Nome
                    VStack(spacing: 20) {
                        // Logo animado
                        ZStack {
                            Circle()
                                .fill(
                                    LinearGradient(
                                        gradient: Gradient(colors: isMonochromaticMode ? 
                                            [MonochromaticColorManager.primaryGreen, MonochromaticColorManager.secondaryGreen] :
                                            [Color(hex: "#16A34A"), Color(hex: "#22C55E")]),
                                        startPoint: .topLeading,
                                        endPoint: .bottomTrailing
                                    )
                                )
                                .frame(width: 120, height: 120)
                                .scaleEffect(animateLogo ? 1.1 : 1.0)
                                .animation(.easeInOut(duration: 2.0).repeatForever(autoreverses: true), value: animateLogo)
                            
                            Image(systemName: "leaf.fill")
                                .font(.system(size: 50))
                                .foregroundColor(.white)
                                .rotationEffect(.degrees(animateLogo ? 360 : 0))
                                .animation(.linear(duration: 3.0).repeatForever(autoreverses: false), value: animateLogo)
                        }
                        
                        VStack(spacing: 8) {
                            Text("PINEE")
                                .font(.system(size: 36, weight: .bold, design: .rounded))
                                .foregroundColor(.primary)
                            
                            Text("Seu companheiro financeiro")
                                .font(.system(size: 18, weight: .medium))
                                .foregroundColor(.secondary)
                            
                            Text("VersÃ£o 1.0.0")
                                .font(.system(size: 14))
                                .foregroundColor(.secondary)
                                .padding(.top, 4)
                        }
                    }
                    .padding(.top, 20)
                    
                    // MissÃ£o
                    VStack(spacing: 16) {
                        HStack {
                            Image(systemName: "target")
                                .font(.system(size: 24))
                                .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : Color(hex: "#16A34A"))
                            
                            Text("Nossa MissÃ£o")
                                .font(.system(size: 22, weight: .semibold))
                                .foregroundColor(.primary)
                            
                            Spacer()
                        }
                        
                        Text("Transformar a gestÃ£o financeira pessoal em uma experiÃªncia simples, intuitiva e inspiradora. Queremos que cada usuÃ¡rio sinta que tem controle total sobre suas finanÃ§as e possa construir um futuro financeiro sÃ³lido.")
                            .font(.system(size: 16))
                            .foregroundColor(.secondary)
                            .multilineTextAlignment(.leading)
                            .lineSpacing(4)
                    }
                    .padding(.horizontal, 20)
                    .padding(.vertical, 20)
                    .background(Color(UIColor.secondarySystemBackground))
                    .cornerRadius(16)
                    .padding(.horizontal, 20)
                    
                    // Recursos Principais
                    VStack(spacing: 16) {
                        HStack {
                            Image(systemName: "star.fill")
                                .font(.system(size: 24))
                                .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : Color(hex: "#16A34A"))
                            
                            Text("Recursos Principais")
                                .font(.system(size: 22, weight: .semibold))
                                .foregroundColor(.primary)
                            
                            Spacer()
                        }
                        
                        LazyVGrid(columns: [
                            GridItem(.flexible()),
                            GridItem(.flexible())
                        ], spacing: 16) {
                            FeatureCard(
                                icon: "chart.pie.fill",
                                title: "AnÃ¡lises Detalhadas",
                                description: "Visualize seus gastos com grÃ¡ficos intuitivos"
                            )
                            
                            FeatureCard(
                                icon: "target",
                                title: "Metas Financeiras",
                                description: "Defina e acompanhe suas metas de economia"
                            )
                            
                            FeatureCard(
                                icon: "chart.line.uptrend.xyaxis",
                                title: "Investimentos",
                                description: "Acompanhe seus investimentos e rendimentos"
                            )
                            
                            FeatureCard(
                                icon: "bell.fill",
                                title: "Lembretes Inteligentes",
                                description: "Receba notificaÃ§Ãµes personalizadas"
                            )
                        }
                    }
                    .padding(.horizontal, 20)
                    .opacity(showFeatures ? 1.0 : 0.0)
                    .offset(y: showFeatures ? 0 : 20)
                    .animation(.easeOut(duration: 0.8).delay(0.3), value: showFeatures)
                    
                    // EstatÃ­sticas do App
                    VStack(spacing: 16) {
                        HStack {
                            Image(systemName: "chart.bar.fill")
                                .font(.system(size: 24))
                                .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : Color(hex: "#16A34A"))
                            
                            Text("PINEE em NÃºmeros")
                                .font(.system(size: 22, weight: .semibold))
                                .foregroundColor(.primary)
                            
                            Spacer()
                        }
                        
                        HStack(spacing: 20) {
                            StatCard(
                                number: "100%",
                                label: "Gratuito",
                                icon: "heart.fill"
                            )
                            
                            StatCard(
                                number: "24/7",
                                label: "DisponÃ­vel",
                                icon: "clock.fill"
                            )
                            
                            StatCard(
                                number: "âˆ",
                                label: "Possibilidades",
                                icon: "infinity"
                            )
                        }
                    }
                    .padding(.horizontal, 20)
                    .opacity(showFeatures ? 1.0 : 0.0)
                    .offset(y: showFeatures ? 0 : 20)
                    .animation(.easeOut(duration: 0.8).delay(0.5), value: showFeatures)
                    
                    // Agradecimento
                    VStack(spacing: 16) {
                        Image(systemName: "heart.fill")
                            .font(.system(size: 30))
                            .foregroundColor(.red)
                            .scaleEffect(animateLogo ? 1.2 : 1.0)
                            .animation(.easeInOut(duration: 1.5).repeatForever(autoreverses: true), value: animateLogo)
                        
                        Text("Obrigado por escolher o PINEE!")
                            .font(.system(size: 20, weight: .semibold))
                            .foregroundColor(.primary)
                        
                        Text("Esperamos que o PINEE ajude vocÃª a alcanÃ§ar seus objetivos financeiros e construir um futuro mais prÃ³spero. Sua jornada financeira comeÃ§a aqui! ğŸŒ±")
                            .font(.system(size: 16))
                            .foregroundColor(.secondary)
                            .multilineTextAlignment(.center)
                            .lineSpacing(4)
                    }
                    .padding(.horizontal, 20)
                    .padding(.vertical, 20)
                    .background(Color(UIColor.secondarySystemBackground))
                    .cornerRadius(16)
                    .padding(.horizontal, 20)
                    .opacity(showFeatures ? 1.0 : 0.0)
                    .offset(y: showFeatures ? 0 : 20)
                    .animation(.easeOut(duration: 0.8).delay(0.7), value: showFeatures)
                    
                    // Footer
                    VStack(spacing: 8) {
                        Text("Desenvolvido com â¤ï¸ no Brasil")
                            .font(.system(size: 14, weight: .medium))
                            .foregroundColor(.secondary)
                        
                        Text("Â© 2024 PINEE. Todos os direitos reservados.")
                            .font(.system(size: 12))
                            .foregroundColor(.secondary)
                    }
                    .padding(.top, 20)
                    .padding(.bottom, 40)
                }
            }
            .background(Color(UIColor.systemGroupedBackground))
            .navigationTitle("Sobre o PINEE")
            .navigationBarTitleDisplayMode(.inline)
            .toolbar {
                ToolbarItem(placement: .navigationBarTrailing) {
                    Button("Fechar") {
                        presentationMode.wrappedValue.dismiss()
                    }
                    .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : Color(hex: "#16A34A"))
                }
            }
        }
        .onAppear {
            animateLogo = true
            DispatchQueue.main.asyncAfter(deadline: .now() + 0.5) {
                showFeatures = true
            }
        }
    }

// MARK: - Feature Card
struct FeatureCard: View {
    let icon: String
    let title: String
    let description: String
    @AppStorage("isMonochromaticMode") private var isMonochromaticMode: Bool = false
    
    var body: some View {
        VStack(spacing: 12) {
            Image(systemName: icon)
                .font(.system(size: 24))
                .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : Color(hex: "#16A34A"))
            
            Text(title)
                .font(.system(size: 14, weight: .semibold))
                .foregroundColor(.primary)
                .multilineTextAlignment(.center)
            
            Text(description)
                .font(.system(size: 12))
                .foregroundColor(.secondary)
                .multilineTextAlignment(.center)
                .lineLimit(3)
        }
        .padding()
        .frame(maxWidth: .infinity)
        .background(Color(UIColor.systemBackground))
        .cornerRadius(12)
        .shadow(color: Color.black.opacity(0.05), radius: 5, x: 0, y: 2)
    }

// MARK: - Stat Card
struct StatCard: View {
    let number: String
    let label: String
    let icon: String
    @AppStorage("isMonochromaticMode") private var isMonochromaticMode: Bool = false
    
    var body: some View {
        VStack(spacing: 8) {
            Image(systemName: icon)
                .font(.system(size: 20))
                .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : Color(hex: "#16A34A"))
            
            Text(number)
                .font(.system(size: 20, weight: .bold))
                .foregroundColor(.primary)
            
            Text(label)
                .font(.system(size: 12))
                .foregroundColor(.secondary)
                .multilineTextAlignment(.center)
        }
        .padding()
        .frame(maxWidth: .infinity)
        .background(Color(UIColor.systemBackground))
        .cornerRadius(12)
        .shadow(color: Color.black.opacity(0.05), radius: 5, x: 0, y: 2)
    }

// MARK: - Feedback View
struct FeedbackView: View {
    @EnvironmentObject var authViewModel: AuthViewModel
    @Environment(\.presentationMode) private var presentationMode
    @AppStorage("isMonochromaticMode") private var isMonochromaticMode: Bool = false
    
    @State private var feedbackText = ""
    @State private var isLoading = false
    @State private var showSuccessMessage = false
    @State private var showErrorMessage = false
    @State private var errorMessage = ""
    @State private var dailyFeedbackCount = 0
    @State private var isCheckingDailyLimit = true
    
    private let maxCharacters = 500
    
    var body: some View {
        NavigationView {
            ZStack {
                Color(UIColor.systemGroupedBackground)
                    .ignoresSafeArea()
                
                ScrollView {
                    VStack(spacing: 24) {
                        // Header
                        VStack(spacing: 16) {
                            Image(systemName: "bubble.left.and.bubble.right.fill")
                                .font(.system(size: 60))
                                .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : Color(hex: "#16A34A"))
                            
                            VStack(spacing: 8) {
                                Text("Envie seu Feedback")
                                    .font(.system(size: 28, weight: .bold))
                                    .foregroundColor(.primary)
                                
                                Text("Sua opiniÃ£o Ã© muito importante para melhorarmos o PINEE!")
                                    .font(.system(size: 16))
                                    .foregroundColor(.secondary)
                                    .multilineTextAlignment(.center)
                                    .lineSpacing(4)
                            }
                        }
                        .padding(.top, 20)
                        
                        // InformaÃ§Ãµes do usuÃ¡rio
                        VStack(spacing: 16) {
                            HStack {
                                Image(systemName: "person.circle.fill")
                                    .font(.system(size: 20))
                                    .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : Color(hex: "#16A34A"))
                                
                                Text("InformaÃ§Ãµes do UsuÃ¡rio")
                                    .font(.system(size: 18, weight: .semibold))
                                    .foregroundColor(.primary)
                                
                                Spacer()
                            }
                            
                            VStack(spacing: 12) {
                                HStack {
                                    VStack(alignment: .leading, spacing: 4) {
                                        Text("Nome")
                                            .font(.system(size: 14, weight: .medium))
                                            .foregroundColor(.secondary)
                                        
                                        Text(authViewModel.user?.name ?? "UsuÃ¡rio")
                                            .font(.system(size: 16))
                                            .foregroundColor(.primary)
                                    }
                                    
                                    Spacer()
                                    
                                    VStack(alignment: .trailing, spacing: 4) {
                                        Text("Email")
                                            .font(.system(size: 14, weight: .medium))
                                            .foregroundColor(.secondary)
                                        
                                        Text(authViewModel.user?.email ?? "")
                                            .font(.system(size: 16))
                                            .foregroundColor(.primary)
                                    }
                                }
                            }
                            .padding()
                            .background(Color(UIColor.secondarySystemBackground))
                            .cornerRadius(12)
                        }
                        .padding(.horizontal, 20)
                        
                        // Ãrea de feedback
                        VStack(spacing: 16) {
                            HStack {
                                Image(systemName: "pencil.circle.fill")
                                    .font(.system(size: 20))
                                    .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : Color(hex: "#16A34A"))
                                
                                Text("Seu Feedback")
                                    .font(.system(size: 18, weight: .semibold))
                                    .foregroundColor(.primary)
                                
                                Spacer()
                                
                                // Contador de caracteres
                                Text("\(feedbackText.count)/\(maxCharacters)")
                                    .font(.system(size: 14, weight: .medium))
                                    .foregroundColor(feedbackText.count > maxCharacters ? .red : .secondary)
                            }
                            
                            VStack(spacing: 12) {
                                TextEditor(text: $feedbackText)
                                    .frame(minHeight: 200)
                                    .padding()
                                    .background(Color(UIColor.systemBackground))
                                    .cornerRadius(12)
                                    .overlay(
                                        RoundedRectangle(cornerRadius: 12)
                                            .stroke(feedbackText.count > maxCharacters ? Color.red : Color.clear, lineWidth: 2)
                                    )
                                    .onChange(of: feedbackText) { newValue in
                                        if newValue.count > maxCharacters {
                                            feedbackText = String(newValue.prefix(maxCharacters))
                                        }
                                    }
                                
                                // Dicas de feedback
                                VStack(alignment: .leading, spacing: 8) {
                                    Text("ğŸ’¡ Dicas para um feedback Ãºtil:")
                                        .font(.system(size: 14, weight: .medium))
                                        .foregroundColor(.secondary)
                                    
                                    VStack(alignment: .leading, spacing: 4) {
                                        Text("â€¢ Descreva o que vocÃª gostou ou nÃ£o gostou")
                                        Text("â€¢ Sugira melhorias ou novas funcionalidades")
                                        Text("â€¢ Mencione bugs ou problemas encontrados")
                                        Text("â€¢ Compartilhe sua experiÃªncia geral")
                                    }
                                    .font(.system(size: 12))
                                    .foregroundColor(.secondary)
                                }
                                .padding()
                                .background(Color(UIColor.secondarySystemBackground))
                                .cornerRadius(12)
                            }
                        }
                        .padding(.horizontal, 20)
                        
                        // Limite diÃ¡rio
                        if dailyFeedbackCount >= 3 {
                            VStack(spacing: 8) {
                                Image(systemName: "exclamationmark.triangle.fill")
                                    .font(.system(size: 24))
                                    .foregroundColor(.orange)
                                
                                Text("Limite DiÃ¡rio Atingido")
                                    .font(.system(size: 16, weight: .semibold))
                                    .foregroundColor(.primary)
                                
                                Text("VocÃª jÃ¡ enviou 3 feedbacks hoje. Tente novamente amanhÃ£!")
                                    .font(.system(size: 14))
                                    .foregroundColor(.secondary)
                                    .multilineTextAlignment(.center)
                            }
                            .padding()
                            .background(Color(UIColor.secondarySystemBackground))
                            .cornerRadius(12)
                            .padding(.horizontal, 20)
                        }
                        
                        // BotÃ£o enviar
                        Button(action: submitFeedback) {
                            HStack {
                                if isLoading {
                                    ProgressView()
                                        .progressViewStyle(CircularProgressViewStyle(tint: .white))
                                        .scaleEffect(0.8)
                                } else {
                                    Image(systemName: "paperplane.fill")
                                }
                                
                                Text(isLoading ? "Enviando..." : "Enviar Feedback")
                            }
                            .font(.system(size: 16, weight: .semibold))
                            .foregroundColor(.white)
                            .padding()
                            .frame(maxWidth: .infinity)
                            .background(
                                LinearGradient(
                                    gradient: Gradient(colors: isMonochromaticMode ? 
                                        [MonochromaticColorManager.primaryGreen, MonochromaticColorManager.secondaryGreen] :
                                        [Color(hex: "#16A34A"), Color(hex: "#22C55E")]),
                                    startPoint: .leading,
                                    endPoint: .trailing
                                )
                            )
                            .cornerRadius(12)
                        }
                        .disabled(feedbackText.isEmpty || isLoading || dailyFeedbackCount >= 3 || isCheckingDailyLimit)
                        .opacity((feedbackText.isEmpty || dailyFeedbackCount >= 3 || isCheckingDailyLimit) ? 0.6 : 1.0)
                        .padding(.horizontal, 20)
                        
                        // InformaÃ§Ãµes adicionais
                        VStack(spacing: 8) {
                            Text("ğŸ“Š Feedback enviados hoje: \(dailyFeedbackCount)/3")
                                .font(.system(size: 14, weight: .medium))
                                .foregroundColor(.secondary)
                            
                            Text("â° Limite diÃ¡rio: 3 feedbacks")
                                .font(.system(size: 12))
                                .foregroundColor(.secondary)
                        }
                        .padding(.top, 10)
                        
                        Spacer(minLength: 40)
                    }
                }
            }
            .navigationTitle("Feedback")
            .navigationBarTitleDisplayMode(.inline)
            .toolbar {
                ToolbarItem(placement: .navigationBarLeading) {
                    Button("Cancelar") {
                        presentationMode.wrappedValue.dismiss()
                    }
                    .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : Color(hex: "#16A34A"))
                }
            }
        }
        .onAppear {
            checkDailyFeedbackLimit()
        }
        .alert("Sucesso!", isPresented: $showSuccessMessage) {
            Button("OK") {
                presentationMode.wrappedValue.dismiss()
            }
        } message: {
            Text("Seu feedback foi enviado com sucesso! Obrigado por nos ajudar a melhorar o PINEE. ğŸŒ±")
        }
        .alert("Erro", isPresented: $showErrorMessage) {
            Button("OK") { }
        } message: {
            Text(errorMessage)
        }
    }
    
    // MARK: - Functions
    private func checkDailyFeedbackLimit() {
        guard let userId = authViewModel.user?.id else {
            isCheckingDailyLimit = false
            return
        }
        
        let db = // Firestore.firestore()
        let today = Calendar.current.startOfDay(for: Date())
        
        db// .collection("feedbacks")
            .whereField("userId", isEqualTo: userId)
            .whereField("createdAt", isGreaterThan: Timestamp(date: today))
            .getDocuments { snapshot, error in
                DispatchQueue.main.async {
                    isCheckingDailyLimit = false
                    
                    if let error = error {
                        print("âŒ Erro ao verificar limite diÃ¡rio: \(error)")
                        return
                    }
                    
                    dailyFeedbackCount = snapshot?.documents.count ?? 0
                }
            }
    }
    
    private func submitFeedback() {
        guard let userId = authViewModel.user?.id,
              let userName = authViewModel.user?.name,
              let userEmail = authViewModel.user?.email else {
            errorMessage = "Erro: InformaÃ§Ãµes do usuÃ¡rio nÃ£o disponÃ­veis."
            showErrorMessage = true
            return
        }
        
        guard !feedbackText.trimmingCharacters(in: .whitespacesAndNewlines).isEmpty else {
            errorMessage = "Por favor, escreva seu feedback antes de enviar."
            showErrorMessage = true
            return
        }
        
        guard dailyFeedbackCount < 3 else {
            errorMessage = "VocÃª jÃ¡ atingiu o limite de 3 feedbacks por dia."
            showErrorMessage = true
            return
        }
        
        isLoading = true
        
        let db = // Firestore.firestore()
        let feedbackData: [String: Any] = [
            "userId": userId,
            "userName": userName,
            "userEmail": userEmail,
            "feedback": feedbackText.trimmingCharacters(in: .whitespacesAndNewlines),
            "createdAt": Timestamp(date: Date()),
            "updatedAt": Timestamp(date: Date())
        ]
        
        db// .collection("feedbacks").addDocument(data: feedbackData) { error in
            DispatchQueue.main.async {
                isLoading = false
                
                if let error = error {
                    errorMessage = "Erro ao enviar feedback: \(error.localizedDescription)"
                    showErrorMessage = true
                } else {
                    showSuccessMessage = true
                    dailyFeedbackCount += 1
                }
            }
        }
    }

// MARK: - Privacy Policy View
struct PrivacyPolicyView: View {
    @Environment(\.presentationMode) private var presentationMode
    @AppStorage("isMonochromaticMode") private var isMonochromaticMode: Bool = false
    @State private var selectedSection: PrivacySection = .overview
    @Environment(\.horizontalSizeClass) private var horizontalSizeClass
    
    enum PrivacySection: String, CaseIterable {
        case overview = "VisÃ£o Geral"
        case dataCollection = "Coleta de Dados"
        case dataUsage = "Uso dos Dados"
        case dataSharing = "Compartilhamento"
        case security = "SeguranÃ§a"
        case rights = "Seus Direitos"
        case contact = "Contato"
        
        var icon: String {
            switch self {
            case .overview: return "eye.fill"
            case .dataCollection: return "folder.fill"
            case .dataUsage: return "gear.fill"
            case .dataSharing: return "arrow.triangle.2.circlepath"
            case .security: return "lock.shield.fill"
            case .rights: return "person.crop.circle.fill"
            case .contact: return "envelope.fill"
            }
        }
    }
    
    var body: some View {
        NavigationView {
            Group {
                if horizontalSizeClass == .compact {
                    // Layout para telas pequenas (iPhone)
                    VStack(spacing: 0) {
                        ScrollView(.horizontal, showsIndicators: false) {
                            HStack(spacing: 8) {
                                ForEach(PrivacySection.allCases, id: \.self) { section in
                                    Button(action: { selectedSection = section }) {
                                        HStack(spacing: 6) {
                                            Image(systemName: section.icon)
                                                .font(.system(size: 14))
                                                .foregroundColor(selectedSection == section ? (isMonochromaticMode ? MonochromaticColorManager.primaryGreen : Color(hex: "#16A34A")) : .secondary)
                                            Text(section.rawValue)
                                                .font(.system(size: 13, weight: selectedSection == section ? .semibold : .medium))
                                                .foregroundColor(selectedSection == section ? .primary : .secondary)
                                        }
                                        .padding(.vertical, 8)
                                        .padding(.horizontal, 10)
                                        .background(selectedSection == section ? Color(UIColor.systemBackground) : Color.clear)
                                        .cornerRadius(8)
                                    }
                                }
                            }
                            .padding(.horizontal, 8)
                            .padding(.top, 8)
                        }
                        Divider()
                        ScrollView {
                            VStack(alignment: .leading, spacing: 20) {
                                HStack {
                                    Image(systemName: selectedSection.icon)
                                        .font(.system(size: 20))
                                        .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : Color(hex: "#16A34A"))
                                    Text(selectedSection.rawValue)
                                        .font(.system(size: 22, weight: .bold))
                                        .foregroundColor(.primary)
                                    Spacer()
                                }
                                Text("Ãšltima atualizaÃ§Ã£o: Janeiro 2024")
                                    .font(.system(size: 12))
                                    .foregroundColor(.secondary)
                                // ConteÃºdo da seÃ§Ã£o
                                Group {
                                    switch selectedSection {
                                    case .overview: overviewContent
                                    case .dataCollection: dataCollectionContent
                                    case .dataUsage: dataUsageContent
                                    case .dataSharing: dataSharingContent
                                    case .security: securityContent
                                    case .rights: rightsContent
                                    case .contact: contactContent
                                    }
                                }
                            }
                            .padding(.horizontal, 12)
                            .padding(.top, 16)
                        }
                    }
                } else {
                    // Layout para telas grandes (iPad, Mac)
                    HStack(spacing: 0) {
                        VStack(spacing: 0) {
                            VStack(spacing: 12) {
                                Image(systemName: "hand.raised.fill")
                                    .font(.system(size: 30))
                                    .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : Color(hex: "#16A34A"))
                                Text("PolÃ­tica de\nPrivacidade")
                                    .font(.system(size: 16, weight: .bold))
                                    .foregroundColor(.primary)
                                    .multilineTextAlignment(.center)
                            }
                            .padding(.vertical, 20)
                            .frame(maxWidth: .infinity)
                            .background(Color(UIColor.secondarySystemBackground))
                            ScrollView {
                                VStack(spacing: 2) {
                                    ForEach(PrivacySection.allCases, id: \.self) { section in
                                        Button(action: { selectedSection = section }) {
                                            HStack(spacing: 12) {
                                                Image(systemName: section.icon)
                                                    .font(.system(size: 16))
                                                    .foregroundColor(selectedSection == section ? (isMonochromaticMode ? MonochromaticColorManager.primaryGreen : Color(hex: "#16A34A")) : .secondary)
                                                    .frame(width: 20)
                                                Text(section.rawValue)
                                                    .font(.system(size: 14, weight: selectedSection == section ? .semibold : .medium))
                                                    .foregroundColor(selectedSection == section ? .primary : .secondary)
                                                Spacer()
                                            }
                                            .padding(.horizontal, 16)
                                            .padding(.vertical, 12)
                                            .background(selectedSection == section ? Color(UIColor.systemBackground) : Color.clear)
                                            .cornerRadius(8)
                                        }
                                        .buttonStyle(PlainButtonStyle())
                                    }
                                }
                                .padding(.vertical, 8)
                            }
                        }
                        .frame(width: 160)
                        .background(Color(UIColor.systemGroupedBackground))
                        ScrollView {
                            VStack(alignment: .leading, spacing: 24) {
                                VStack(alignment: .leading, spacing: 12) {
                                    HStack {
                                        Image(systemName: selectedSection.icon)
                                            .font(.system(size: 24))
                                            .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : Color(hex: "#16A34A"))
                                        Text(selectedSection.rawValue)
                                            .font(.system(size: 28, weight: .bold))
                                            .foregroundColor(.primary)
                                        Spacer()
                                    }
                                    Text("Ãšltima atualizaÃ§Ã£o: Janeiro 2024")
                                        .font(.system(size: 14))
                                        .foregroundColor(.secondary)
                                }
                                .padding(.horizontal, 24)
                                .padding(.top, 20)
                                VStack(alignment: .leading, spacing: 20) {
                                    switch selectedSection {
                                    case .overview: overviewContent
                                    case .dataCollection: dataCollectionContent
                                    case .dataUsage: dataUsageContent
                                    case .dataSharing: dataSharingContent
                                    case .security: securityContent
                                    case .rights: rightsContent
                                    case .contact: contactContent
                                    }
                                }
                                .padding(.horizontal, 24)
                                Spacer(minLength: 40)
                            }
                        }
                        .background(Color(UIColor.systemBackground))
                    }
                }
            }
            .navigationTitle("PolÃ­tica de Privacidade")
            .navigationBarTitleDisplayMode(.inline)
            .toolbar {
                ToolbarItem(placement: .navigationBarTrailing) {
                    Button("Fechar") {
                        presentationMode.wrappedValue.dismiss()
                    }
                    .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : Color(hex: "#16A34A"))
                }
            }
        }
    }
    
    // MARK: - Content Sections
    private var overviewContent: some View {
        VStack(alignment: .leading, spacing: 16) {
            Text("Bem-vindo Ã  PolÃ­tica de Privacidade do PINEE!")
                .font(.system(size: 20, weight: .semibold))
                .foregroundColor(.primary)
            
            Text("No PINEE, sua privacidade Ã© fundamental para nÃ³s. Esta polÃ­tica explica como coletamos, usamos e protegemos suas informaÃ§Ãµes pessoais quando vocÃª utiliza nosso aplicativo de gestÃ£o financeira.")
                .font(.system(size: 16))
                .foregroundColor(.secondary)
                .lineSpacing(4)
            
            VStack(alignment: .leading, spacing: 12) {
                Text("ğŸ”’ Compromisso com a Privacidade")
                    .font(.system(size: 18, weight: .semibold))
                    .foregroundColor(.primary)
                
                Text("â€¢ Suas informaÃ§Ãµes financeiras sÃ£o suas e apenas suas")
                Text("â€¢ Utilizamos criptografia de ponta para proteger seus dados")
                Text("â€¢ Nunca vendemos ou compartilhamos seus dados pessoais")
                Text("â€¢ VocÃª tem controle total sobre suas informaÃ§Ãµes")
            }
            .font(.system(size: 14))
            .foregroundColor(.secondary)
            .padding()
            .background(Color(UIColor.secondarySystemBackground))
            .cornerRadius(12)
        }
    }
    
    private var dataCollectionContent: some View {
        VStack(alignment: .leading, spacing: 16) {
            Text("Quais Dados Coletamos")
                .font(.system(size: 20, weight: .semibold))
                .foregroundColor(.primary)
            
            VStack(alignment: .leading, spacing: 16) {
                DataCollectionCard(
                    title: "InformaÃ§Ãµes de Conta",
                    description: "Nome, email e informaÃ§Ãµes bÃ¡sicas de perfil para criar e gerenciar sua conta.",
                    icon: "person.circle.fill"
                )
                
                DataCollectionCard(
                    title: "Dados Financeiros",
                    description: "TransaÃ§Ãµes, categorias, metas e investimentos que vocÃª registra no app.",
                    icon: "creditcard.fill"
                )
                
                DataCollectionCard(
                    title: "Dados de Uso",
                    description: "Como vocÃª interage com o app, funcionalidades utilizadas e preferÃªncias.",
                    icon: "chart.bar.fill"
                )
                
                DataCollectionCard(
                    title: "Dados TÃ©cnicos",
                    description: "InformaÃ§Ãµes do dispositivo, versÃ£o do app e logs de erro para melhorias.",
                    icon: "gear.fill"
                )
            }
        }
    }
    
    private var dataUsageContent: some View {
        VStack(alignment: .leading, spacing: 16) {
            Text("Como Usamos Seus Dados")
                .font(.system(size: 20, weight: .semibold))
                .foregroundColor(.primary)
            
            VStack(alignment: .leading, spacing: 12) {
                UsageItem(
                    title: "Fornecer ServiÃ§os",
                    description: "Processar transaÃ§Ãµes, gerar relatÃ³rios e personalizar sua experiÃªncia."
                )
                
                UsageItem(
                    title: "Melhorar o App",
                    description: "Analisar padrÃµes de uso para desenvolver novas funcionalidades."
                )
                
                UsageItem(
                    title: "ComunicaÃ§Ã£o",
                    description: "Enviar notificaÃ§Ãµes importantes sobre sua conta e atualizaÃ§Ãµes."
                )
                
                UsageItem(
                    title: "SeguranÃ§a",
                    description: "Detectar e prevenir atividades fraudulentas e proteger sua conta."
                )
            }
        }
    }
    
    private var dataSharingContent: some View {
        VStack(alignment: .leading, spacing: 16) {
            Text("Compartilhamento de Dados")
                .font(.system(size: 20, weight: .semibold))
                .foregroundColor(.primary)
            
            VStack(alignment: .leading, spacing: 16) {
                Text("ğŸš« NÃ£o Compartilhamos")
                    .font(.system(size: 18, weight: .semibold))
                    .foregroundColor(.primary)
                
                VStack(alignment: .leading, spacing: 8) {
                    Text("â€¢ Suas informaÃ§Ãµes financeiras pessoais")
                    Text("â€¢ Dados de transaÃ§Ãµes especÃ­ficas")
                    Text("â€¢ InformaÃ§Ãµes de conta para terceiros")
                    Text("â€¢ Dados para fins de marketing sem consentimento")
                }
                .font(.system(size: 14))
                .foregroundColor(.secondary)
                .padding()
                .background(Color.red.opacity(0.1))
                .cornerRadius(12)
                
                Text("âœ… Compartilhamento Limitado")
                    .font(.system(size: 18, weight: .semibold))
                    .foregroundColor(.primary)
                
                VStack(alignment: .leading, spacing: 8) {
                    Text("â€¢ Prestadores de serviÃ§os essenciais (Firebase, Google)")
                    Text("â€¢ Dados anonimizados para anÃ¡lises gerais")
                    Text("â€¢ InformaÃ§Ãµes quando exigido por lei")
                    Text("â€¢ Com seu consentimento explÃ­cito")
                }
                .font(.system(size: 14))
                .foregroundColor(.secondary)
                .padding()
                .background(Color.green.opacity(0.1))
                .cornerRadius(12)
            }
        }
    }
    
    private var securityContent: some View {
        VStack(alignment: .leading, spacing: 16) {
            Text("SeguranÃ§a dos Dados")
                .font(.system(size: 20, weight: .semibold))
                .foregroundColor(.primary)
            
            VStack(alignment: .leading, spacing: 16) {
                SecurityFeatureCard(
                    title: "Criptografia de Ponta",
                    description: "Todos os dados sÃ£o criptografados em trÃ¢nsito e em repouso usando padrÃµes AES-256.",
                    icon: "lock.shield.fill"
                )
                
                SecurityFeatureCard(
                    title: "AutenticaÃ§Ã£o Segura",
                    description: "Utilizamos Firebase Auth com autenticaÃ§Ã£o de dois fatores e tokens seguros.",
                    icon: "key.fill"
                )
                
                SecurityFeatureCard(
                    title: "Backup Seguro",
                    description: "Seus dados sÃ£o armazenados em servidores seguros da Google Cloud com redundÃ¢ncia.",
                    icon: "icloud.fill"
                )
                
                SecurityFeatureCard(
                    title: "Monitoramento ContÃ­nuo",
                    description: "Sistemas de monitoramento 24/7 para detectar e prevenir ameaÃ§as.",
                    icon: "eye.fill"
                )
            }
        }
    }
    
    private var rightsContent: some View {
        VStack(alignment: .leading, spacing: 16) {
            Text("Seus Direitos")
                .font(.system(size: 20, weight: .semibold))
                .foregroundColor(.primary)
            
            VStack(alignment: .leading, spacing: 12) {
                RightItem(
                    title: "Acesso aos Dados",
                    description: "VocÃª pode acessar todos os seus dados pessoais a qualquer momento."
                )
                
                RightItem(
                    title: "CorreÃ§Ã£o",
                    description: "Solicitar correÃ§Ã£o de dados incorretos ou incompletos."
                )
                
                RightItem(
                    title: "ExclusÃ£o",
                    description: "Solicitar a exclusÃ£o de sua conta e todos os dados associados."
                )
                
                RightItem(
                    title: "Portabilidade",
                    description: "Exportar seus dados em formato legÃ­vel por mÃ¡quina."
                )
                
                RightItem(
                    title: "OposiÃ§Ã£o",
                    description: "Opor-se ao processamento de seus dados para fins especÃ­ficos."
                )
                
                RightItem(
                    title: "Retirada do Consentimento",
                    description: "Retirar consentimento para processamento de dados a qualquer momento."
                )
            }
        }
    }
    
    private var contactContent: some View {
        VStack(alignment: .leading, spacing: 16) {
            Text("Entre em Contato")
                .font(.system(size: 20, weight: .semibold))
                .foregroundColor(.primary)
            
            Text("Se vocÃª tiver dÃºvidas sobre esta PolÃ­tica de Privacidade ou sobre como tratamos seus dados, entre em contato conosco:")
                .font(.system(size: 16))
                .foregroundColor(.secondary)
                .lineSpacing(4)
            
            VStack(spacing: 16) {
                ContactCard(
                    title: "Email",
                    value: "privacidade@pinee.app",
                    icon: "envelope.fill"
                )
                
                ContactCard(
                    title: "HorÃ¡rio de Atendimento",
                    value: "Segunda a Sexta, 9h Ã s 18h (BRT)",
                    icon: "clock.fill"
                )
                
                ContactCard(
                    title: "Tempo de Resposta",
                    value: "AtÃ© 48 horas Ãºteis",
                    icon: "timer.fill"
                )
            }
            
            VStack(alignment: .leading, spacing: 8) {
                Text("ğŸ“ DÃºvidas Frequentes")
                    .font(.system(size: 16, weight: .semibold))
                    .foregroundColor(.primary)
                
                Text("â€¢ Como solicitar exclusÃ£o de dados?")
                Text("â€¢ Como exportar minhas informaÃ§Ãµes?")
                Text("â€¢ Como alterar minhas configuraÃ§Ãµes de privacidade?")
                Text("â€¢ Como denunciar violaÃ§Ã£o de privacidade?")
            }
            .font(.system(size: 14))
            .foregroundColor(.secondary)
            .padding()
            .background(Color(UIColor.secondarySystemBackground))
            .cornerRadius(12)
        }
    }

// MARK: - Supporting Views
struct DataCollectionCard: View {
    let title: String
    let description: String
    let icon: String
    @AppStorage("isMonochromaticMode") private var isMonochromaticMode: Bool = false
    
    var body: some View {
        HStack(spacing: 16) {
            Image(systemName: icon)
                .font(.system(size: 24))
                .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : Color(hex: "#16A34A"))
                .frame(width: 30)
            
            VStack(alignment: .leading, spacing: 4) {
                Text(title)
                    .font(.system(size: 16, weight: .semibold))
                    .foregroundColor(.primary)
                
                Text(description)
                    .font(.system(size: 14))
                    .foregroundColor(.secondary)
                    .lineSpacing(2)
            }
            
            Spacer()
        }
        .padding()
        .background(Color(UIColor.secondarySystemBackground))
        .cornerRadius(12)
    }

struct UsageItem: View {
    let title: String
    let description: String
    
    var body: some View {
        VStack(alignment: .leading, spacing: 4) {
            Text("â€¢ \(title)")
                .font(.system(size: 16, weight: .semibold))
                .foregroundColor(.primary)
            
            Text(description)
                .font(.system(size: 14))
                .foregroundColor(.secondary)
                .lineSpacing(2)
        }
        .padding()
        .background(Color(UIColor.secondarySystemBackground))
        .cornerRadius(12)
    }

struct SecurityFeatureCard: View {
    let title: String
    let description: String
    let icon: String
    @AppStorage("isMonochromaticMode") private var isMonochromaticMode: Bool = false
    
    var body: some View {
        HStack(spacing: 16) {
            Image(systemName: icon)
                .font(.system(size: 24))
                .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : Color(hex: "#16A34A"))
                .frame(width: 30)
            
            VStack(alignment: .leading, spacing: 4) {
                Text(title)
                    .font(.system(size: 16, weight: .semibold))
                    .foregroundColor(.primary)
                
                Text(description)
                    .font(.system(size: 14))
                    .foregroundColor(.secondary)
                    .lineSpacing(2)
            }
            
            Spacer()
        }
        .padding()
        .background(Color(UIColor.secondarySystemBackground))
        .cornerRadius(12)
    }

struct RightItem: View {
    let title: String
    let description: String
    
    var body: some View {
        VStack(alignment: .leading, spacing: 4) {
            Text("ğŸ”’ \(title)")
                .font(.system(size: 16, weight: .semibold))
                .foregroundColor(.primary)
            
            Text(description)
                .font(.system(size: 14))
                .foregroundColor(.secondary)
                .lineSpacing(2)
        }
        .padding()
        .background(Color(UIColor.secondarySystemBackground))
        .cornerRadius(12)
    }

struct ContactCard: View {
    let title: String
    let value: String
    let icon: String
    @AppStorage("isMonochromaticMode") private var isMonochromaticMode: Bool = false
    
    var body: some View {
        HStack(spacing: 16) {
            Image(systemName: icon)
                .font(.system(size: 20))
                .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : Color(hex: "#16A34A"))
                .frame(width: 24)
            
            VStack(alignment: .leading, spacing: 2) {
                Text(title)
                    .font(.system(size: 14, weight: .medium))
                    .foregroundColor(.secondary)
                
                Text(value)
                    .font(.system(size: 16, weight: .semibold))
                    .foregroundColor(.primary)
            }
            
            Spacer()
        }
        .padding()
        .background(Color(UIColor.secondarySystemBackground))
        .cornerRadius(12)
    }

// MARK: - Import Data View
struct ImportDataView: View {
    @Environment(\.presentationMode) private var presentationMode
    @AppStorage("isMonochromaticMode") private var isMonochromaticMode: Bool = false
    @State private var csvData = ""
    @State private var showSuccessMessage = false
    @State private var showErrorMessage = false
    @State private var isLoading = false
    @State private var errorMessage = ""
    
    var body: some View {
        NavigationView {
            ZStack {
                Color(UIColor.systemGroupedBackground)
                    .ignoresSafeArea()
                
                ScrollView {
                    VStack(spacing: 24) {
                        // Header
                        VStack(spacing: 16) {
                            Image(systemName: "square.and.arrow.down.fill")
                                .font(.system(size: 60))
                                .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : Color(hex: "#16A34A"))
                            
                            VStack(spacing: 8) {
                                Text("Importar Dados")
                                    .font(.system(size: 28, weight: .bold))
                                    .foregroundColor(.primary)
                                
                                Text("Envie o arquivo CSV para importar seus dados")
                                    .font(.system(size: 16))
                                    .foregroundColor(.secondary)
                                    .multilineTextAlignment(.center)
                            }
                        }
                        .padding(.top, 20)
                        
                        // Ãrea de importaÃ§Ã£o
                        VStack(spacing: 16) {
                            HStack {
                                Image(systemName: "doc.text.fill")
                                    .font(.system(size: 20))
                                    .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : Color(hex: "#16A34A"))
                                
                                Text("Arquivo CSV")
                                    .font(.system(size: 18, weight: .semibold))
                                    .foregroundColor(.primary)
                                
                                Spacer()
                            }
                            
                            TextEditor(text: $csvData)
                                .frame(minHeight: 200)
                                .padding()
                                .background(Color(UIColor.systemBackground))
                                .cornerRadius(12)
                                .overlay(
                                    RoundedRectangle(cornerRadius: 12)
                                        .stroke(csvData.isEmpty ? Color.red : Color.clear, lineWidth: 2)
                                )
                                .onChange(of: csvData) { newValue in
                                    if newValue.count > 1000 {
                                        csvData = String(newValue.prefix(1000))
                                    }
                                }
                            
                            // Dicas de importaÃ§Ã£o
                            VStack(alignment: .leading, spacing: 8) {
                                Text("ğŸ’¡ Dicas para importar dados:")
                                    .font(.system(size: 14, weight: .medium))
                                    .foregroundColor(.secondary)
                                
                                VStack(alignment: .leading, spacing: 4) {
                                    Text("â€¢ Certifique-se de que o arquivo CSV estÃ¡ no formato correto")
                                    Text("â€¢ Separe os dados com vÃ­rgulas (,)")
                                    Text("â€¢ Use aspas duplas (\") para strings")
                                    Text("â€¢ Adicione uma linha de cabeÃ§alho com os tÃ­tulos das colunas")
                                }
                                .font(.system(size: 12))
                                .foregroundColor(.secondary)
                            }
                            .padding()
                            .background(Color(UIColor.secondarySystemBackground))
                            .cornerRadius(12)
                        }
                        .padding(.horizontal, 20)
                        
                        // BotÃ£o importar
                        Button(action: importData) {
                            HStack {
                                if isLoading {
                                    ProgressView()
                                        .progressViewStyle(CircularProgressViewStyle(tint: .white))
                                        .scaleEffect(0.8)
                                } else {
                                    Image(systemName: "square.and.arrow.down.fill")
                                }
                                
                                Text(isLoading ? "Importando..." : "Importar Dados")
                            }
                            .font(.system(size: 16, weight: .semibold))
                            .foregroundColor(.white)
                            .padding()
                            .frame(maxWidth: .infinity)
                            .background(
                                LinearGradient(
                                    gradient: Gradient(colors: isMonochromaticMode ? 
                                        [MonochromaticColorManager.primaryGreen, MonochromaticColorManager.secondaryGreen] :
                                        [Color(hex: "#16A34A"), Color(hex: "#22C55E")]),
                                    startPoint: .leading,
                                    endPoint: .trailing
                                )
                            )
                            .cornerRadius(12)
                        }
                        .disabled(csvData.isEmpty || isLoading)
                        .opacity((csvData.isEmpty || isLoading) ? 0.6 : 1.0)
                        .padding(.horizontal, 20)
                        
                        // InformaÃ§Ãµes adicionais
                        VStack(spacing: 8) {
                            Text("ğŸ“Š Dados importados: \(csvData.count)/1000 caracteres")
                                .font(.system(size: 14, weight: .medium))
                                .foregroundColor(.secondary)
                            
                            Text("â° Limite: 1000 caracteres")
                                .font(.system(size: 12))
                                .foregroundColor(.secondary)
                        }
                        .padding(.top, 10)
                        
                        Spacer(minLength: 40)
                    }
                }
            }
            .navigationTitle("Importar Dados")
            .navigationBarTitleDisplayMode(.inline)
            .toolbar {
                ToolbarItem(placement: .navigationBarLeading) {
                    Button("Cancelar") {
                        presentationMode.wrappedValue.dismiss()
                    }
                    .foregroundColor(isMonochromaticMode ? MonochromaticColorManager.primaryGreen : Color(hex: "#16A34A"))
                }
            }
        }
        .onAppear {
            checkImportDataLimit()
        }
        .alert("Sucesso!", isPresented: $showSuccessMessage) {
            Button("OK") {
                presentationMode.wrappedValue.dismiss()
            }
        } message: {
            Text("Dados importados com sucesso! ğŸŒ±")
        }
        .alert("Erro", isPresented: $showErrorMessage) {
            Button("OK") { }
        } message: {
            Text(errorMessage)
        }
    }
    
    // MARK: - Functions
    private func checkImportDataLimit() {
        if csvData.count > 1000 {
            errorMessage = "Limite de 1000 caracteres atingido. Por favor, envie um arquivo menor."
            showErrorMessage = true
        }
    }
    
    private func importData() {
        // Aqui vocÃª pode adicionar a lÃ³gica para importar os dados do arquivo CSV
        print("Dados importados: \(csvData)")
        showSuccessMessage = true
        presentationMode.wrappedValue.dismiss()
    }

}
*/
